### 🪆 Subquery: 쿼리 속의 쿼리

**서브쿼리(Subquery)**, 또는 **하위 쿼리**는 하나의 SQL 문 안에 포함된 또 다른 `SELECT` 문입니다. 마치 러시아 인형(마트료시카)처럼, 바깥쪽 쿼리(Main Query)가 안쪽 쿼리(Subquery)를 감싸는 구조입니다. 🪆

서브쿼리는 "먼저 안쪽 쿼리를 실행해서 그 결과를 얻은 뒤, 그 결과를 바깥쪽 쿼리에서 활용"하는 방식으로 동작합니다. 이를 통해 복잡한 문제를 단계적으로 해결하거나, 다른 쿼리의 결과를 현재 쿼리의 조건으로 사용할 수 있어 매우 유용합니다.

---

#### ### **1. WHERE 절에서 사용하기 (가장 일반적인 형태)**

`WHERE` 절에서 서브쿼리를 사용하면, 서브쿼리가 반환하는 **결과를 조건 값으로** 활용할 수 있습니다.

* **단일 행(Single-Row) 서브쿼리**: 서브쿼리가 **하나의 결과 값**만 반환하는 경우입니다. 주로 비교 연산자(`=`, `>`, `<` 등)와 함께 사용됩니다.

    ```sql
    -- [예제] 'Seoul'과 인구가 같은 다른 도시를 찾아보기
    -- 1. (서브쿼리) 'Seoul'의 인구를 먼저 찾는다. -> 9981619
    -- 2. (메인쿼리) 위에서 찾은 인구수와 같은 도시를 조회한다.
    SELECT
      Name,
      Population
    FROM
      city
    WHERE
      Population = (
        SELECT Population FROM city WHERE Name = 'Seoul'
      );
    ```

* **다중 행(Multi-Row) 서브쿼리**: 서브쿼리가 **여러 개의 결과 값**을 반환하는 경우입니다. 주로 `IN`, `NOT IN`, `ANY`, `ALL` 같은 연산자와 함께 사용됩니다.
	* - IN: 목록 중 일치하는 값이 있는지 확인
	    - NOT IN : 목록 중 일치하는 값이 없는지 확인
	- ANY: 조건을 만족하는 값이 하나라도 있는지 확인
	- ALL: 모든 값이 조건을 만족하는지 확인
	- EXISTS: 서브쿼리 결과가 존재하는지 확인
	    - NOT EXISTS: 서브쿼리 결과가 존재하지 않는지 확인

    ```sql
    -- [예제] 'Japan'에 속한 모든 도시의 정보를 조회하기
    -- 1. (서브쿼리) country 테이블에서 'Japan'의 국가 코드('JPN')를 찾는다.
    -- 2. (메인쿼리) city 테이블에서 위 국가 코드('JPN')를 가진 도시들을 조회한다.
    SELECT
      Name,
      District
    FROM
      city
    WHERE
      CountryCode IN (
        SELECT Code FROM country WHERE Name = 'Japan'
      );
    ```

---

#### ### **2. FROM 절에서 사용하기 (인라인 뷰)**

`FROM` 절에 서브쿼리를 사용하면, 서브쿼리의 실행 결과가 마치 **하나의 가상 테이블**처럼 동작하게 됩니다. 이를 **인라인 뷰(Inline View)** 또는 **파생 테이블(Derived Table)**이라고 부릅니다.

> **💡 중요!**: `FROM` 절에 서브쿼리를 사용할 때는 반드시 **별칭(Alias)을 지정**해야 합니다.

```sql
-- [예제] 각 대륙별 국가 수와 총인구를 먼저 구한 뒤(가상 테이블), 이 결과에서 국가 수가 20개 이상인 대륙만 다시 조회하기
SELECT
  Continent,
  국가_수,
  대륙별_총인구
FROM
  (
    SELECT
      Continent,
      COUNT(*) AS '국가_수',
      SUM(Population) AS '대륙별_총인구'
    FROM
      country
    GROUP BY
      Continent
  ) AS continent_summary -- 반드시 별칭을 지정해야 함!
WHERE
  국가_수 >= 20;
```

---

#### ### **3. SELECT 절에서 사용하기 (스칼라 서브쿼리)**

`SELECT` 절에 오는 서브쿼리는 반드시 **하나의 값만**을 반환해야 하며, 이를 **스칼라 서브쿼리(Scalar Subquery)**라고 합니다. 메인 쿼리의 각 행에 대해 독립적으로 실행되어, 마치 새로운 컬럼이 추가된 것처럼 결과를 보여줍니다.

```sql
-- [예제] 각 국가의 이름과 함께, 해당 국가에 속한 도시의 수를 '도시_수'라는 컬럼으로 함께 조회하기
SELECT
  co.Name AS '국가명',
  (
    SELECT COUNT(*) FROM city ci WHERE ci.CountryCode = co.Code
  ) AS '도시_수'
FROM
  country co;
```
> **💡 상관 서브쿼리(Correlated Subquery)**
>
> 위 예제처럼 서브쿼리가 바깥쪽 메인 쿼리의 컬럼(`co.Code`)을 참조하여 실행되는 경우, 이를 **상관 서브쿼리**라고 합니다. 메인 쿼리의 각 행마다 서브쿼리가 독립적으로 다시 실행되기 때문에 데이터 양이 많을 경우 성능이 저하될 수 있습니다.

---

### ## 💡 JOIN vs Subquery

많은 경우 `JOIN`과 서브쿼리는 서로 대체 가능하며 비슷한 결과를 낼 수 있습니다.

* **가독성**: 쿼리가 복잡하지 않다면, `JOIN`이 일반적으로 더 직관적이고 읽기 쉽습니다.
* **성능**: 대부분의 경우, 데이터베이스 옵티마이저는 `JOIN`을 서브쿼리보다 더 효율적으로 처리합니다. 특히 상관 서브쿼리는 성능 저하의 주된 원인이 될 수 있습니다.
* **유연성**: 서브쿼리는 `GROUP BY`의 결과를 `WHERE` 절의 조건으로 사용하는 등, `JOIN`으로는 표현하기 어렵거나 불가능한 복잡한 논리를 구현할 때 강력한 유연성을 제공합니다.

**결론**: 성능과 가독성이 중요하다면 `JOIN`을 우선적으로 고려하되, `JOIN`으로 해결하기 어려운 복잡한 문제를 해결해야 할 때는 서브쿼리가 훌륭한 대안이 될 수 있습니다.