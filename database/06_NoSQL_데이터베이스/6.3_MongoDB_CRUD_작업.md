# 6.3. MongoDB CRUD 작업

## 학습 목표
- MongoDB의 Create, Read, Update, Delete 작업을 상세히 학습한다
- 다양한 쿼리 연산자를 활용할 수 있다
- update 연산자를 사용하여 데이터를 효율적으로 수정한다

---

## 1. Create (생성)

### 1.1. insertOne - 단일 문서 삽입

```javascript
db.users.insertOne({
    name: "Alice",
    age: 25,
    email: "alice@example.com",
    hobbies: ["reading", "coding"],
    createdAt: new Date()
})

// 결과
{
    acknowledged: true,
    insertedId: ObjectId("...")
}
```

### 1.2. insertMany - 여러 문서 삽입

```javascript
db.users.insertMany([
    { name: "Bob", age: 30, email: "bob@example.com" },
    { name: "Charlie", age: 35, email: "charlie@example.com" },
    { name: "David", age: 28, email: "david@example.com" }
])

// 결과
{
    acknowledged: true,
    insertedIds: {
        '0': ObjectId("..."),
        '1': ObjectId("..."),
        '2': ObjectId("...")
    }
}
```

**옵션:**
```javascript
// ordered: false - 오류 발생 시에도 계속 삽입
db.users.insertMany([...], { ordered: false })
```

---

## 2. Read (조회)

### 2.1. find - 여러 문서 조회

```javascript
// 모든 문서
db.users.find()

// 조건 지정
db.users.find({ age: 25 })

// 여러 조건 (AND)
db.users.find({ age: 25, name: "Alice" })

// OR 조건
db.users.find({
    $or: [
        { age: 25 },
        { name: "Bob" }
    ]
})
```

### 2.2. 비교 연산자

```javascript
// $gt (greater than)
db.users.find({ age: { $gt: 25 } })  // age > 25

// $gte (greater than or equal)
db.users.find({ age: { $gte: 25 } })  // age >= 25

// $lt (less than)
db.users.find({ age: { $lt: 30 } })  // age < 30

// $lte (less than or equal)
db.users.find({ age: { $lte: 30 } })  // age <= 30

// $ne (not equal)
db.users.find({ age: { $ne: 25 } })  // age != 25

// $in (in array)
db.users.find({ age: { $in: [25, 30, 35] } })  // age가 25, 30, 35 중 하나

// $nin (not in array)
db.users.find({ age: { $nin: [25, 30] } })  // age가 25, 30이 아닌 것
```

### 2.3. 논리 연산자

```javascript
// $and
db.users.find({
    $and: [
        { age: { $gt: 20 } },
        { age: { $lt: 30 } }
    ]
})

// 간단하게
db.users.find({ age: { $gt: 20, $lt: 30 } })

// $or
db.users.find({
    $or: [
        { age: { $lt: 25 } },
        { age: { $gt: 35 } }
    ]
})

// $not
db.users.find({ age: { $not: { $gt: 30 } } })
```

### 2.4. 필드 선택 (Projection)

```javascript
// 특정 필드만 조회
db.users.find({}, { name: 1, age: 1 })  // name과 age만
// _id는 기본적으로 포함됨

// _id 제외
db.users.find({}, { name: 1, age: 1, _id: 0 })

// 특정 필드 제외
db.users.find({}, { email: 0, createdAt: 0 })
```

### 2.5. 정렬, 제한, 건너뛰기

```javascript
// 정렬 (sort)
db.users.find().sort({ age: 1 })   // 오름차순
db.users.find().sort({ age: -1 })  // 내림차순

// 제한 (limit)
db.users.find().limit(5)  // 처음 5개만

// 건너뛰기 (skip)
db.users.find().skip(10)  // 처음 10개 건너뛰고

// 조합 (페이징)
db.users.find()
    .sort({ age: -1 })
    .skip(20)
    .limit(10)  // 21~30번째 문서
```

### 2.6. 문서 개수 세기

```javascript
// 전체 개수
db.users.countDocuments()

// 조건에 맞는 개수
db.users.countDocuments({ age: { $gt: 25 } })
```

---

## 3. Update (수정)

### 3.1. updateOne - 단일 문서 수정

```javascript
db.users.updateOne(
    { name: "Alice" },            // 조건
    { $set: { age: 26 } }         // 수정 내용
)

// 결과
{
    acknowledged: true,
    matchedCount: 1,
    modifiedCount: 1
}
```

### 3.2. updateMany - 여러 문서 수정

```javascript
db.users.updateMany(
    { age: { $lt: 30 } },         // 30세 미만 모두
    { $set: { status: "young" } }
)
```

### 3.3. update 연산자

**$set - 필드 설정**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $set: { age: 26, city: "Seoul" } }
)
```

**$unset - 필드 제거**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $unset: { city: "" } }  // city 필드 삭제
)
```

**$inc - 숫자 증가/감소**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $inc: { age: 1 } }  // age를 1 증가
)

db.products.updateOne(
    { _id: 1 },
    { $inc: { stock: -5 } }  // stock을 5 감소
)
```

**$mul - 곱하기**
```javascript
db.products.updateOne(
    { _id: 1 },
    { $mul: { price: 1.1 } }  // 가격 10% 인상
)
```

**$rename - 필드명 변경**
```javascript
db.users.updateMany(
    {},
    { $rename: { "email": "emailAddress" } }
)
```

**$currentDate - 현재 날짜/시간**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $currentDate: { lastModified: true } }
)
```

### 3.4. 배열 연산자

**$push - 배열에 요소 추가**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $push: { hobbies: "gaming" } }
)

// 여러 요소 추가
db.users.updateOne(
    { name: "Alice" },
    { $push: { hobbies: { $each: ["swimming", "hiking"] } } }
)
```

**$pull - 배열에서 요소 제거**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $pull: { hobbies: "gaming" } }
)
```

**$addToSet - 중복 없이 추가**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $addToSet: { hobbies: "coding" } }  // 이미 있으면 추가 안 됨
)
```

**$pop - 배열의 첫/마지막 요소 제거**
```javascript
db.users.updateOne(
    { name: "Alice" },
    { $pop: { hobbies: 1 } }   // 마지막 요소 제거
)

db.users.updateOne(
    { name: "Alice" },
    { $pop: { hobbies: -1 } }  // 첫 요소 제거
)
```

### 3.5. upsert 옵션

```javascript
// 문서가 없으면 삽입, 있으면 수정
db.users.updateOne(
    { name: "Eve" },
    { $set: { age: 22, email: "eve@example.com" } },
    { upsert: true }
)
```

---

## 4. Delete (삭제)

### 4.1. deleteOne - 단일 문서 삭제

```javascript
db.users.deleteOne({ name: "Alice" })

// 결과
{
    acknowledged: true,
    deletedCount: 1
}
```

### 4.2. deleteMany - 여러 문서 삭제

```javascript
// 조건에 맞는 모든 문서 삭제
db.users.deleteMany({ age: { $gt: 50 } })

// 모든 문서 삭제 (컬렉션은 유지)
db.users.deleteMany({})
```

---

## 5. 복합 쿼리 예제

### 예제 1: 전자상거래 상품 관리

```javascript
// 상품 컬렉션 생성
db.products.insertMany([
    { name: "노트북", category: "전자기기", price: 1200000, stock: 10, tags: ["컴퓨터", "업무"] },
    { name: "마우스", category: "액세서리", price: 30000, stock: 50, tags: ["컴퓨터", "주변기기"] },
    { name: "키보드", category: "액세서리", price: 80000, stock: 30, tags: ["컴퓨터", "주변기기"] },
    { name: "모니터", category: "전자기기", price: 300000, stock: 15, tags: ["디스플레이"] }
])

// 100만원 이상 상품 조회
db.products.find({ price: { $gte: 1000000 } })

// 전자기기이면서 재고 15개 이상
db.products.find({
    category: "전자기기",
    stock: { $gte: 15 }
})

// 가격 범위 조회
db.products.find({
    price: { $gte: 50000, $lte: 500000 }
})

// 태그에 "컴퓨터" 포함
db.products.find({ tags: "컴퓨터" })

// 재고 감소
db.products.updateOne(
    { name: "노트북" },
    { $inc: { stock: -1 } }
)

// 가격 10% 할인
db.products.updateMany(
    { category: "액세서리" },
    { $mul: { price: 0.9 } }
)
```

### 예제 2: 블로그 포스트

```javascript
// 포스트 생성
db.posts.insertOne({
    title: "MongoDB 시작하기",
    author: "Alice",
    content: "MongoDB는...",
    tags: ["database", "nosql", "mongodb"],
    views: 0,
    likes: 0,
    comments: [],
    createdAt: new Date(),
    published: true
})

// 조회수 증가
db.posts.updateOne(
    { title: "MongoDB 시작하기" },
    { $inc: { views: 1 } }
)

// 좋아요 증가
db.posts.updateOne(
    { title: "MongoDB 시작하기" },
    { $inc: { likes: 1 } }
)

// 댓글 추가
db.posts.updateOne(
    { title: "MongoDB 시작하기" },
    {
        $push: {
            comments: {
                author: "Bob",
                text: "좋은 글 감사합니다!",
                date: new Date()
            }
        }
    }
)

// 태그로 검색
db.posts.find({ tags: "mongodb" })

// 인기 포스트 (조회수 100 이상, 좋아요 10 이상)
db.posts.find({
    views: { $gte: 100 },
    likes: { $gte: 10 }
}).sort({ views: -1 })
```

---

## 6. SQL vs MongoDB 비교

| SQL | MongoDB |
|-----|---------|
| `INSERT INTO users VALUES (...)` | `db.users.insertOne({...})` |
| `SELECT * FROM users` | `db.users.find()` |
| `SELECT name, age FROM users` | `db.users.find({}, {name:1, age:1})` |
| `SELECT * FROM users WHERE age > 25` | `db.users.find({age: {$gt: 25}})` |
| `SELECT * FROM users WHERE age BETWEEN 20 AND 30` | `db.users.find({age: {$gte: 20, $lte: 30}})` |
| `SELECT * FROM users ORDER BY age DESC LIMIT 10` | `db.users.find().sort({age:-1}).limit(10)` |
| `UPDATE users SET age = 26 WHERE name = 'Alice'` | `db.users.updateOne({name:"Alice"}, {$set:{age:26}})` |
| `UPDATE users SET status = 'active'` | `db.users.updateMany({}, {$set:{status:"active"}})` |
| `DELETE FROM users WHERE age > 50` | `db.users.deleteMany({age:{$gt:50}})` |
| `SELECT COUNT(*) FROM users` | `db.users.countDocuments()` |

---

## 강사 가이드

### 수업 진행 팁

1. **CRUD 순서대로 진행** (각 20분)
   - Create부터 순서대로
   - 각 작업마다 즉시 실습
   - SQL과 비교하며 설명

2. **연산자 중점 설명** (30분)
   - 비교 연산자 ($gt, $lt 등)
   - update 연산자 ($set, $inc 등)
   - 배열 연산자 ($push, $pull 등)

3. **실습 예제** (20분)
   - 전자상거래, 블로그 등 실무 시나리오
   - 학생들이 직접 쿼리 작성
   - 다양한 조건 조합 연습

### 자주 하는 질문

**Q: updateOne과 updateMany의 차이는?**
> A: updateOne은 첫 번째 일치하는 문서 하나만, updateMany는 조건에 맞는 모든 문서를 수정합니다.

**Q: $set 없이 바로 값을 주면 안 되나요?**
> A: $set 없이 하면 문서 전체가 교체됩니다. 필드만 수정하려면 반드시 $set을 사용하세요.

**Q: SQL의 JOIN은 어떻게 하나요?**
> A: MongoDB는 $lookup을 사용하거나, 데이터를 임베드(내장)합니다. 다음 시간에 배웁니다.

---

## 요약

### CRUD 명령어

```javascript
// Create
db.collection.insertOne({...})
db.collection.insertMany([...])

// Read
db.collection.find()
db.collection.findOne({...})

// Update
db.collection.updateOne({조건}, {$set: {...}})
db.collection.updateMany({조건}, {$set: {...}})

// Delete
db.collection.deleteOne({조건})
db.collection.deleteMany({조건})
```

### 주요 연산자

- 비교: `$gt`, `$gte`, `$lt`, `$lte`, `$eq`, `$ne`, `$in`, `$nin`
- 논리: `$and`, `$or`, `$not`, `$nor`
- Update: `$set`, `$unset`, `$inc`, `$mul`, `$rename`
- 배열: `$push`, `$pull`, `$addToSet`, `$pop`

### 다음 단계

다음 시간에는 **MongoDB 쿼리와 인덱스**를 학습합니다.
