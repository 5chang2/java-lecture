# 6.4. MongoDB 쿼리와 인덱스

## 학습 목표
- 고급 쿼리 기법을 학습한다
- 집계 파이프라인(Aggregation)을 사용할 수 있다
- 인덱스의 중요성을 이해하고 생성할 수 있다

---

## 1. 고급 쿼리

### 1.1. 배열 쿼리

```javascript
// 배열에 특정 값 포함
db.users.find({ hobbies: "coding" })

// 배열에 여러 값 모두 포함
db.users.find({ hobbies: { $all: ["coding", "reading"] } })

// 배열 크기
db.users.find({ hobbies: { $size: 3 } })

// 배열 요소 조건
db.products.find({ "reviews.rating": { $gte: 4 } })
```

### 1.2. 중첩 객체 쿼리

```javascript
// 점 표기법
db.users.find({ "address.city": "Seoul" })

// 여러 조건
db.users.find({
    "address.city": "Seoul",
    "address.zipcode": "12345"
})
```

### 1.3. 정규표현식

```javascript
// 이름이 "A"로 시작
db.users.find({ name: /^A/ })

// 대소문자 구분 없이
db.users.find({ email: /alice/i })

// $regex 사용
db.users.find({ name: { $regex: "^A", $options: "i" } })
```

---

## 2. 집계 파이프라인 (Aggregation)

### 2.1. 기본 개념

```javascript
db.collection.aggregate([
    { $match: {...} },    // 필터링 (WHERE)
    { $group: {...} },    // 그룹화 (GROUP BY)
    { $sort: {...} },     // 정렬 (ORDER BY)
    { $limit: 10 }        // 제한 (LIMIT)
])
```

### 2.2. $match - 필터링

```javascript
db.orders.aggregate([
    { $match: { status: "completed" } }
])
```

### 2.3. $group - 그룹화

```javascript
// 카테고리별 상품 수와 평균 가격
db.products.aggregate([
    {
        $group: {
            _id: "$category",
            count: { $sum: 1 },
            avgPrice: { $avg: "$price" }
        }
    }
])

// 전체 통계
db.orders.aggregate([
    {
        $group: {
            _id: null,
            totalOrders: { $sum: 1 },
            totalRevenue: { $sum: "$amount" }
        }
    }
])
```

### 2.4. $project - 필드 선택

```javascript
db.users.aggregate([
    {
        $project: {
            name: 1,
            age: 1,
            _id: 0
        }
    }
])
```

### 2.5. $sort - 정렬

```javascript
db.products.aggregate([
    { $sort: { price: -1 } }
])
```

### 2.6. 복합 예제

```javascript
// 카테고리별 매출 상위 3개
db.sales.aggregate([
    { $match: { year: 2025 } },
    {
        $group: {
            _id: "$category",
            totalSales: { $sum: "$amount" }
        }
    },
    { $sort: { totalSales: -1 } },
    { $limit: 3 }
])
```

---

## 3. 인덱스 (Index)

### 3.1. 인덱스의 필요성

```javascript
// 인덱스 없이 조회 (느림)
db.users.find({ email: "alice@example.com" })
// 모든 문서를 스캔 (Collection Scan)

// 인덱스 생성 후 (빠름)
db.users.createIndex({ email: 1 })
db.users.find({ email: "alice@example.com" })
// 인덱스를 사용하여 즉시 찾음
```

### 3.2. 인덱스 생성

```javascript
// 단일 필드 인덱스
db.users.createIndex({ email: 1 })  // 오름차순

// 복합 인덱스
db.users.createIndex({ age: 1, name: 1 })

// 내림차순
db.products.createIndex({ price: -1 })
```

### 3.3. 인덱스 확인

```javascript
// 모든 인덱스 조회
db.users.getIndexes()

// 쿼리 실행 계획 확인
db.users.find({ email: "alice@example.com" }).explain("executionStats")
```

### 3.4. 인덱스 삭제

```javascript
// 특정 인덱스 삭제
db.users.dropIndex("email_1")

// 모든 인덱스 삭제 (_id 제외)
db.users.dropIndexes()
```

### 3.5. 특수 인덱스

**고유 인덱스 (Unique Index)**
```javascript
db.users.createIndex({ email: 1 }, { unique: true })
```

**텍스트 인덱스**
```javascript
// 전문 검색용
db.articles.createIndex({ content: "text" })

// 텍스트 검색
db.articles.find({ $text: { $search: "mongodb tutorial" } })
```

---

## 4. SQL vs MongoDB 집계

| SQL | MongoDB Aggregation |
|-----|---------------------|
| WHERE | $match |
| GROUP BY | $group |
| HAVING | $match (after $group) |
| SELECT | $project |
| ORDER BY | $sort |
| LIMIT | $limit |
| SUM() | $sum |
| COUNT() | $sum: 1 |
| AVG() | $avg |

---

## 강사 가이드

### 수업 진행 팁

1. **집계 파이프라인 시각화**
   - 단계별로 데이터 변환 과정 보여주기
   - 화이트보드에 파이프라인 그리기

2. **인덱스 성능 비교**
   - 대량 데이터로 인덱스 전후 속도 비교
   - explain() 결과 해석

3. **실습 위주**
   - 전자상거래 주문 데이터로 집계 연습
   - 다양한 통계 쿼리 작성

---

## 요약

### 집계 파이프라인
```javascript
db.collection.aggregate([
    { $match: {...} },
    { $group: {...} },
    { $sort: {...} }
])
```

### 인덱스
```javascript
// 생성
db.collection.createIndex({ field: 1 })

// 조회
db.collection.getIndexes()

// 삭제
db.collection.dropIndex("index_name")
```

### 다음 단계
다음 시간에는 **SQL vs NoSQL 선택 기준**을 학습합니다.
