# 3.4. INSERT, UPDATE, DELETE

> INSERT, UPDATE, DELETE 문을 사용하여 데이터를 추가, 수정, 삭제할 수 있다.

---

## 1. DML이란?

**DML** (Data Manipulation Language, 데이터 조작어)은 테이블의 **실제 데이터를 조작**하는 명령어입니다.

### DML 명령어

| 명령어 | 기능 | 설명 |
|--------|------|------|
| `INSERT` | 추가 | 새로운 행 삽입 |
| `SELECT` | 조회 | 데이터 조회 (이미 학습) |
| `UPDATE` | 수정 | 기존 데이터 변경 |
| `DELETE` | 삭제 | 데이터 삭제 |

---

## 2. INSERT: 데이터 추가

`INSERT`는 테이블에 **새로운 행(row)**를 추가합니다.

### 2.1. 기본 문법

```sql
INSERT INTO 테이블명 (컬럼1, 컬럼2, ...)
VALUES (값1, 값2, ...);
```

### 2.2. 단일 행 삽입

```sql
-- 새 상품 추가
INSERT INTO products (product_name, category, price, stock)
VALUES ('USB', '전자제품', 15000, 40);
```

**확인**:
```sql
SELECT * FROM products WHERE product_name = 'USB';
```

**결과**:
```
+-----------+-------------+----------+-------+-------+
|product_id |product_name |category  |price  |stock  |
+-----------+-------------+----------+-------+-------+
| 9         |USB          |전자제품  |15000  |40     |
+-----------+-------------+----------+-------+-------+
```

### 2.3. 여러 행 한 번에 삽입

```sql
-- 여러 상품 동시 추가
INSERT INTO products (product_name, category, price, stock)
VALUES
    ('헤드셋', '전자제품', 50000, 20),
    ('스탠드', '가구', 80000, 10),
    ('지우개', '문구', 500, 150);
```

**장점**: 한 번의 쿼리로 여러 행 삽입 → 성능 향상

### 2.4. 컬럼 순서 생략 (비권장)

모든 컬럼을 순서대로 입력하면 컬럼명 생략 가능하지만, **권장하지 않습니다**.

```sql
-- ❌ 비권장: 컬럼 순서를 알아야 함
INSERT INTO products
VALUES (NULL, '마이크', '전자제품', 60000, 15);

-- ✅ 권장: 명확히 컬럼 지정
INSERT INTO products (product_name, category, price, stock)
VALUES ('마이크', '전자제품', 60000, 15);
```

### 2.5. DEFAULT와 NULL

```sql
-- stock 컬럼은 DEFAULT 0이므로 생략 가능
INSERT INTO products (product_name, category, price)
VALUES ('테스트 상품', '기타', 10000);
-- stock은 자동으로 0

-- NULL 허용 컬럼은 명시적으로 NULL 입력 가능
INSERT INTO products (product_name, category, price, stock)
VALUES ('미정 상품', '기타', NULL, 0);
```

---

## 3. UPDATE: 데이터 수정

`UPDATE`는 **기존 데이터의 값을 변경**합니다.

### 3.1. 기본 문법

```sql
UPDATE 테이블명
SET 컬럼1 = 값1, 컬럼2 = 값2, ...
WHERE 조건;
```

⚠️ **중요**: `WHERE` 절을 **반드시** 지정하세요. 없으면 **모든 행이 변경**됩니다!

### 3.2. 단일 컬럼 수정

```sql
-- USB 상품의 가격을 12000원으로 변경
UPDATE products
SET price = 12000
WHERE product_name = 'USB';
```

**확인**:
```sql
SELECT product_name, price FROM products WHERE product_name = 'USB';
```

### 3.3. 여러 컬럼 동시 수정

```sql
-- 헤드셋의 가격과 재고를 동시에 변경
UPDATE products
SET price = 45000, stock = 25
WHERE product_name = '헤드셋';
```

### 3.4. 조건부 수정

```sql
-- 문구 카테고리의 모든 상품 가격을 10% 인상
UPDATE products
SET price = price * 1.1
WHERE category = '문구';
```

### 3.5. WHERE 없는 UPDATE (위험!)

```sql
-- ❌ 매우 위험: 모든 상품의 재고가 0이 됨
UPDATE products
SET stock = 0;

-- ✅ 항상 WHERE 절 사용
UPDATE products
SET stock = 0
WHERE product_id = 9;
```

---

## 4. DELETE: 데이터 삭제

`DELETE`는 테이블에서 **행을 삭제**합니다.

### 4.1. 기본 문법

```sql
DELETE FROM 테이블명
WHERE 조건;
```

⚠️ **중요**: `WHERE` 절 없으면 **모든 데이터가 삭제**됩니다!

### 4.2. 조건에 맞는 행 삭제

```sql
-- 테스트 상품 삭제
DELETE FROM products
WHERE product_name = '테스트 상품';
```

**확인**:
```sql
SELECT * FROM products WHERE product_name = '테스트 상품';
-- 결과: 0 rows
```

### 4.3. 여러 행 삭제

```sql
-- 재고가 0인 모든 상품 삭제
DELETE FROM products
WHERE stock = 0;

-- 가격이 10000원 미만인 문구 삭제
DELETE FROM products
WHERE category = '문구' AND price < 10000;
```

### 4.4. WHERE 없는 DELETE (위험!)

```sql
-- ❌ 매우 위험: 모든 데이터 삭제
DELETE FROM products;

-- 모든 데이터를 삭제하려면 명시적으로 확인
DELETE FROM products WHERE 1=1;  -- 명확한 의도 표현
```

### 4.5. TRUNCATE vs DELETE

```sql
-- DELETE: 한 행씩 삭제 (느림, ROLLBACK 가능)
DELETE FROM products;

-- TRUNCATE: 테이블 전체 삭제 (빠름, ROLLBACK 불가)
TRUNCATE TABLE products;
```

**차이점**:
| 구분 | DELETE | TRUNCATE |
|------|--------|----------|
| 속도 | 느림 | 빠름 |
| WHERE | 사용 가능 | 사용 불가 |
| ROLLBACK | 가능 | 불가 (AUTO_INCREMENT 초기화) |
| 용도 | 일부 데이터 삭제 | 전체 데이터 초기화 |

---

## 5. 안전한 DML 사용법

### 5.1. 항상 SELECT로 먼저 확인

```sql
-- 1단계: 어떤 데이터가 영향받을지 먼저 조회
SELECT * FROM products WHERE price < 5000;

-- 2단계: 확인 후 DELETE 실행
DELETE FROM products WHERE price < 5000;
```

### 5.2. WHERE 절 필수

```sql
-- ❌ 위험
UPDATE products SET price = 0;
DELETE FROM products;

-- ✅ 안전
UPDATE products SET price = 0 WHERE product_id = 1;
DELETE FROM products WHERE product_id = 1;
```

### 5.3. 트랜잭션 사용 (권장)

```sql
-- 트랜잭션 시작
START TRANSACTION;

-- 데이터 수정
UPDATE products SET price = 0 WHERE product_id = 1;

-- 확인
SELECT * FROM products WHERE product_id = 1;

-- 만족하면 확정, 아니면 취소
COMMIT;     -- 확정
-- ROLLBACK;  -- 취소
```

---

## 6. 외래키와 DML

### 6.1. 외래키 제약 조건

2장에서 만든 도서관 예시를 사용합니다.

```sql
-- 회원 테이블
CREATE TABLE members (
    member_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL
);

-- 대출 테이블 (외래키)
CREATE TABLE loans (
    loan_id INT PRIMARY KEY AUTO_INCREMENT,
    member_id INT NOT NULL,
    book_title VARCHAR(100),
    FOREIGN KEY (member_id) REFERENCES members(member_id)
);
```

### 6.2. INSERT 시 외래키

```sql
-- 회원 추가
INSERT INTO members (name) VALUES ('홍길동');

-- ✅ 존재하는 회원의 대출 기록 추가
INSERT INTO loans (member_id, book_title)
VALUES (1, 'SQL 기초');

-- ❌ 오류: 존재하지 않는 회원
INSERT INTO loans (member_id, book_title)
VALUES (999, 'SQL 기초');
-- Error: Cannot add or update a child row: a foreign key constraint fails
```

### 6.3. DELETE 시 외래키

```sql
-- ❌ 오류: 대출 기록이 있는 회원은 삭제 불가
DELETE FROM members WHERE member_id = 1;
-- Error: Cannot delete or update a parent row: a foreign key constraint fails

-- ✅ 해결책 1: 대출 기록 먼저 삭제
DELETE FROM loans WHERE member_id = 1;
DELETE FROM members WHERE member_id = 1;

-- ✅ 해결책 2: CASCADE 옵션 사용 (설계 시)
-- ON DELETE CASCADE를 설정하면 부모 삭제 시 자식도 자동 삭제
```

---

## 7. 실전 예시

### 예시 1: 재고 조정

```sql
-- 판매: 재고 감소
UPDATE products
SET stock = stock - 1
WHERE product_name = '노트북' AND stock > 0;

-- 입고: 재고 증가
UPDATE products
SET stock = stock + 10
WHERE product_name = '노트북';
```

### 예시 2: 할인 이벤트

```sql
-- 전자제품 10% 할인
UPDATE products
SET price = price * 0.9
WHERE category = '전자제품';

-- 확인
SELECT product_name, price FROM products WHERE category = '전자제품';
```

### 예시 3: 품절 상품 삭제

```sql
-- 재고가 0인 상품 삭제
DELETE FROM products WHERE stock = 0;
```

---

## 실습 문제

### 문제 1: INSERT

다음 상품을 추가하세요.
- 상품명: 램프, 카테고리: 가구, 가격: 35000, 재고: 12

**예상 답**:
```sql
INSERT INTO products (product_name, category, price, stock)
VALUES ('램프', '가구', 35000, 12);
```

### 문제 2: UPDATE

다음 요구사항에 맞게 UPDATE 문을 작성하세요.

1. '마우스' 상품의 가격을 30000원으로 변경
2. '가구' 카테고리의 모든 상품 재고를 5개 증가
3. 재고가 100개 이상인 모든 상품의 가격을 5% 할인

**예상 답**:
```sql
-- 1
UPDATE products
SET price = 30000
WHERE product_name = '마우스';

-- 2
UPDATE products
SET stock = stock + 5
WHERE category = '가구';

-- 3
UPDATE products
SET price = price * 0.95
WHERE stock >= 100;
```

### 문제 3: DELETE

다음 요구사항에 맞게 DELETE 문을 작성하세요.

1. '지우개' 상품 삭제
2. 가격이 1000원 미만인 모든 상품 삭제
3. '기타' 카테고리의 모든 상품 삭제

**예상 답**:
```sql
-- 1
DELETE FROM products WHERE product_name = '지우개';

-- 2
DELETE FROM products WHERE price < 1000;

-- 3
DELETE FROM products WHERE category = '기타';
```

### 문제 4: 복합 작업

다음 작업을 순서대로 수행하세요.

1. '특가 상품' (카테고리: 전자제품, 가격: 9900, 재고: 5) 추가
2. '특가 상품'의 재고를 10개 증가
3. '특가 상품' 삭제

**예상 답**:
```sql
-- 1
INSERT INTO products (product_name, category, price, stock)
VALUES ('특가 상품', '전자제품', 9900, 5);

-- 2
UPDATE products
SET stock = stock + 10
WHERE product_name = '특가 상품';

-- 3
DELETE FROM products WHERE product_name = '특가 상품';
```

---

## 강사 가이드

### 핵심 포인트

1. **WHERE 절 필수**: UPDATE/DELETE는 항상 WHERE와 함께
2. **SELECT로 먼저 확인**: 영향받을 데이터를 먼저 조회
3. **트랜잭션 활용**: 실수 방지를 위해 COMMIT 전에 확인
4. **외래키 제약**: 참조 무결성 보장
5. **TRUNCATE vs DELETE**: 전체 삭제 시 TRUNCATE가 빠름

### 자주 하는 질문

**Q: UPDATE/DELETE를 되돌릴 수 있나요?**
A: 트랜잭션 내에서는 ROLLBACK으로 가능합니다. 하지만 COMMIT 후에는 불가능하므로 항상 신중하게!

**Q: INSERT 시 AUTO_INCREMENT 컬럼은 어떻게 하나요?**
A: 생략하거나 NULL을 입력하면 자동으로 증가합니다.

**Q: UPDATE에서 여러 행을 다르게 업데이트할 수 있나요?**
A: CASE 문을 사용하면 가능합니다.
```sql
UPDATE products
SET price = CASE
    WHEN category = '전자제품' THEN price * 0.9
    WHEN category = '가구' THEN price * 0.8
    ELSE price
END;
```

**Q: DELETE와 DROP의 차이는?**
A: DELETE는 데이터 삭제, DROP은 테이블 자체를 삭제합니다.

### 실습 진행 팁

1. **안전 장치**: `sql_safe_updates` 설정 활용
```sql
SET sql_safe_updates = 1;  -- WHERE 없는 UPDATE/DELETE 금지
```

2. **실수 체험**: WHERE 없이 실행하여 경고 확인 (테스트 데이터로)
3. **트랜잭션 실습**: COMMIT/ROLLBACK 체험
4. **외래키 실습**: 외래키 제약으로 인한 오류 경험

---

## 요약

- **INSERT**: 새로운 데이터 추가
  - `INSERT INTO table (col1, col2) VALUES (val1, val2);`
  - 여러 행 동시 삽입 가능
- **UPDATE**: 기존 데이터 수정
  - `UPDATE table SET col = val WHERE condition;`
  - **WHERE 필수** (없으면 전체 수정)
- **DELETE**: 데이터 삭제
  - `DELETE FROM table WHERE condition;`
  - **WHERE 필수** (없으면 전체 삭제)
- **안전 수칙**:
  1. SELECT로 먼저 확인
  2. WHERE 절 항상 사용
  3. 트랜잭션으로 안전성 확보
  4. 외래키 제약 조건 이해
- **TRUNCATE**: 테이블 전체 데이터 빠르게 삭제

**다음 단계**: 기본 함수(집계, 문자열, 날짜)를 배워 데이터를 가공하는 방법을 익힙니다!
