# 3.5. 기본 함수 (집계, 문자열, 날짜)

> SQL의 기본 함수를 사용하여 데이터를 집계하고 가공할 수 있다.

---

## 실습 준비

이 섹션에서는 **world 데이터베이스**와 **sakila 데이터베이스**를 함께 사용합니다.

```sql
-- 집계 함수 실습
USE world;

-- 문자열/날짜 함수 실습
USE sakila;
```

---

## 1. 함수란?

SQL 함수는 데이터를 **가공하거나 계산**하는 도구입니다.

### 함수 분류

| 분류 | 설명 | 예시 |
|------|------|------|
| **집계 함수** | 여러 행을 계산하여 하나의 값 반환 | COUNT, SUM, AVG, MAX, MIN |
| **문자열 함수** | 문자열 조작 | CONCAT, UPPER, LOWER, SUBSTRING |
| **날짜 함수** | 날짜/시간 처리 | NOW, DATE, YEAR, DATEDIFF |
| **수학 함수** | 수학 연산 | ROUND, CEIL, FLOOR, ABS |

---

## 2. 집계 함수 (Aggregate Functions)

집계 함수는 **여러 행을 하나로 요약**합니다. 주로 `GROUP BY`와 함께 사용합니다.

### 2.1. COUNT: 행 개수

```sql
-- 전체 상품 개수
SELECT COUNT(*) AS 총상품수 FROM products;

-- 특정 컬럼의 NULL이 아닌 개수
SELECT COUNT(price) AS 가격있는상품수 FROM products;

-- 중복 제거한 개수
SELECT COUNT(DISTINCT category) AS 카테고리수 FROM products;
```

**결과 예시**:
```
+-----------+
|총상품수   |
+-----------+
| 12        |
+-----------+
```

### 2.2. SUM: 합계

```sql
-- 전체 상품의 재고 합계
SELECT SUM(stock) AS 총재고 FROM products;

-- 전자제품 재고 합계
SELECT SUM(stock) AS 전자제품재고
FROM products
WHERE category = '전자제품';
```

### 2.3. AVG: 평균

```sql
-- 전체 상품의 평균 가격
SELECT AVG(price) AS 평균가격 FROM products;

-- 카테고리별 평균 가격
SELECT category, AVG(price) AS 평균가격
FROM products
GROUP BY category;
```

**결과 예시**:
```
+----------+-----------+
|category  |평균가격   |
+----------+-----------+
|전자제품  |260000.00  |
|가구      |175000.00  |
|문구      |1500.00    |
+----------+-----------+
```

### 2.4. MAX / MIN: 최댓값 / 최솟값

```sql
-- 가장 비싼 상품 가격
SELECT MAX(price) AS 최고가 FROM products;

-- 가장 저렴한 상품 가격
SELECT MIN(price) AS 최저가 FROM products;

-- 카테고리별 최고가/최저가
SELECT
    category,
    MAX(price) AS 최고가,
    MIN(price) AS 최저가
FROM products
GROUP BY category;
```

---

## 3. GROUP BY: 그룹별 집계

`GROUP BY`는 **같은 값을 가진 행끼리 그룹화**하여 집계합니다.

### 3.1. 기본 사용법

```sql
-- 카테고리별 상품 개수
SELECT
    category,
    COUNT(*) AS 상품수
FROM products
GROUP BY category;
```

**결과**:
```
+----------+-------+
|category  |상품수 |
+----------+-------+
|전자제품  |5      |
|가구      |3      |
|문구      |4      |
+----------+-------+
```

### 3.2. 여러 컬럼으로 그룹화

```sql
-- 카테고리별 상품 통계
SELECT
    category AS 카테고리,
    COUNT(*) AS 상품수,
    SUM(stock) AS 총재고,
    AVG(price) AS 평균가격,
    MAX(price) AS 최고가,
    MIN(price) AS 최저가
FROM products
GROUP BY category;
```

### 3.3. HAVING: 그룹 필터링

`HAVING`은 **그룹화된 결과를 필터링**합니다.

```sql
-- 상품이 3개 이상인 카테고리만 조회
SELECT
    category,
    COUNT(*) AS 상품수
FROM products
GROUP BY category
HAVING COUNT(*) >= 3;
```

**WHERE vs HAVING**:
```sql
-- WHERE: 그룹화 전 필터링 (개별 행)
SELECT category, COUNT(*) AS 상품수
FROM products
WHERE price >= 10000  -- 가격이 10000원 이상인 상품만
GROUP BY category;

-- HAVING: 그룹화 후 필터링 (그룹)
SELECT category, COUNT(*) AS 상품수
FROM products
GROUP BY category
HAVING COUNT(*) >= 3;  -- 상품이 3개 이상인 카테고리만
```

---

## 4. 문자열 함수

### 4.1. CONCAT: 문자열 연결

```sql
-- 상품명과 카테고리를 연결
SELECT CONCAT(product_name, ' (', category, ')') AS 상품정보
FROM products;
```

**결과**:
```
+---------------------+
|상품정보             |
+---------------------+
|노트북 (전자제품)    |
|마우스 (전자제품)    |
|책상 (가구)          |
+---------------------+
```

### 4.2. UPPER / LOWER: 대소문자 변환

```sql
-- 영문 상품명을 대문자로
SELECT product_name, UPPER(product_name) AS 대문자
FROM products
WHERE product_name LIKE '%USB%';
```

### 4.3. SUBSTRING: 부분 문자열 추출

```sql
-- 상품명의 첫 2글자만 추출
SELECT product_name, SUBSTRING(product_name, 1, 2) AS 축약명
FROM products;
```

**MySQL 인덱스**: 1부터 시작

### 4.4. LENGTH: 문자열 길이

```sql
-- 상품명 길이 계산
SELECT product_name, LENGTH(product_name) AS 글자수
FROM products;
```

### 4.5. TRIM: 공백 제거

```sql
-- 앞뒤 공백 제거
SELECT TRIM('  hello  ');  -- 'hello'

-- 왼쪽/오른쪽만 제거
SELECT LTRIM('  hello  ');  -- 'hello  '
SELECT RTRIM('  hello  ');  -- '  hello'
```

### 4.6. REPLACE: 문자열 치환

```sql
-- 카테고리명에서 '제품'을 '기기'로 변경
SELECT
    category,
    REPLACE(category, '제품', '기기') AS 수정된카테고리
FROM products;
```

---

## 5. 날짜 함수

### 5.1. NOW / CURRENT_TIMESTAMP: 현재 날짜시간

```sql
-- 현재 날짜와 시간
SELECT NOW();  -- 2025-01-16 14:30:25

-- 현재 날짜만
SELECT CURDATE();  -- 2025-01-16

-- 현재 시간만
SELECT CURTIME();  -- 14:30:25
```

### 5.2. DATE: 날짜 부분만 추출

```sql
-- 주문 테이블 예시
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 날짜 부분만 추출
SELECT order_id, DATE(order_date) AS 주문일
FROM orders;
```

### 5.3. YEAR, MONTH, DAY: 연월일 추출

```sql
SELECT
    NOW() AS 현재시각,
    YEAR(NOW()) AS 년,
    MONTH(NOW()) AS 월,
    DAY(NOW()) AS 일;
```

**결과**:
```
+---------------------+------+----+----+
|현재시각             |년    |월  |일  |
+---------------------+------+----+----+
|2025-01-16 14:30:25  |2025  |1   |16  |
+---------------------+------+----+----+
```

### 5.4. DATEDIFF: 날짜 차이

```sql
-- 두 날짜 간의 일수 차이
SELECT DATEDIFF('2025-01-20', '2025-01-16') AS 차이;
-- 결과: 4

-- 대출일로부터 며칠 지났는지 (도서관 예시)
SELECT
    book_title,
    loan_date,
    DATEDIFF(NOW(), loan_date) AS 경과일수
FROM loans
WHERE return_date IS NULL;
```

### 5.5. DATE_ADD / DATE_SUB: 날짜 연산

```sql
-- 7일 후 날짜
SELECT DATE_ADD(NOW(), INTERVAL 7 DAY) AS 일주일후;

-- 1개월 전 날짜
SELECT DATE_SUB(NOW(), INTERVAL 1 MONTH) AS 한달전;

-- 대출 후 14일이 반납 예정일
SELECT
    book_title,
    loan_date,
    DATE_ADD(loan_date, INTERVAL 14 DAY) AS 반납예정일
FROM loans;
```

### 5.6. DATE_FORMAT: 날짜 포맷

```sql
-- 날짜를 원하는 형식으로 표시
SELECT DATE_FORMAT(NOW(), '%Y년 %m월 %d일') AS 한글날짜;
-- 결과: 2025년 01월 16일

SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') AS 기본형식;
-- 결과: 2025-01-16 14:30:25
```

**주요 포맷**:
- `%Y`: 4자리 연도 (2025)
- `%m`: 2자리 월 (01)
- `%d`: 2자리 일 (16)
- `%H`: 24시간 형식 시 (14)
- `%i`: 분 (30)
- `%s`: 초 (25)

---

## 6. 수학 함수

### 6.1. ROUND: 반올림

```sql
-- 평균 가격을 소수점 첫째 자리에서 반올림
SELECT ROUND(AVG(price), 0) AS 평균가격 FROM products;
```

### 6.2. CEIL / FLOOR: 올림 / 내림

```sql
SELECT
    AVG(price) AS 원본,
    CEIL(AVG(price)) AS 올림,
    FLOOR(AVG(price)) AS 내림
FROM products;
```

### 6.3. ABS: 절댓값

```sql
SELECT ABS(-100);  -- 100
```

### 6.4. MOD: 나머지

```sql
-- 짝수 product_id만 조회
SELECT * FROM products WHERE MOD(product_id, 2) = 0;
```

---

## 7. 실전 예시

### 예시 1: 카테고리별 판매 통계

```sql
SELECT
    category AS 카테고리,
    COUNT(*) AS 상품수,
    CONCAT(SUM(stock), '개') AS 총재고,
    CONCAT(ROUND(AVG(price), 0), '원') AS 평균가격
FROM products
GROUP BY category
ORDER BY AVG(price) DESC;
```

### 예시 2: 월별 주문 통계

```sql
SELECT
    YEAR(order_date) AS 년도,
    MONTH(order_date) AS 월,
    COUNT(*) AS 주문수,
    SUM(total_amount) AS 매출총액
FROM orders
GROUP BY YEAR(order_date), MONTH(order_date)
ORDER BY 년도, 월;
```

### 예시 3: 재고 부족 경고

```sql
SELECT
    product_name,
    stock,
    CASE
        WHEN stock = 0 THEN '품절'
        WHEN stock < 10 THEN '재고부족'
        ELSE '정상'
    END AS 재고상태
FROM products
ORDER BY stock ASC;
```

---

## 실습 문제

### 문제 1: 집계 함수

다음 쿼리를 작성하세요.

1. 전체 상품의 총 재고량
2. 전자제품의 평균 가격
3. 가장 비싼 상품의 가격과 이름

**예상 답**:
```sql
-- 1
SELECT SUM(stock) AS 총재고 FROM products;

-- 2
SELECT AVG(price) AS 평균가격
FROM products
WHERE category = '전자제품';

-- 3
SELECT product_name, price
FROM products
WHERE price = (SELECT MAX(price) FROM products);
```

### 문제 2: GROUP BY

카테고리별로 다음 정보를 조회하세요:
- 카테고리명
- 상품 개수
- 평균 가격
- 최고가
- 최저가

단, 상품이 2개 이상인 카테고리만 조회하세요.

**예상 답**:
```sql
SELECT
    category AS 카테고리,
    COUNT(*) AS 상품수,
    ROUND(AVG(price), 0) AS 평균가격,
    MAX(price) AS 최고가,
    MIN(price) AS 최저가
FROM products
GROUP BY category
HAVING COUNT(*) >= 2
ORDER BY 평균가격 DESC;
```

### 문제 3: 문자열 함수

상품 정보를 "상품명 [카테고리] - 가격원" 형식으로 출력하세요.
예: "노트북 [전자제품] - 1500000원"

**예상 답**:
```sql
SELECT CONCAT(product_name, ' [', category, '] - ', price, '원') AS 상품정보
FROM products;
```

### 문제 4: 날짜 함수

다음 정보를 조회하세요 (테이블에 created_at 컬럼이 있다고 가정):
1. 오늘 날짜
2. 7일 후 날짜
3. 현재 연도와 월

**예상 답**:
```sql
-- 1
SELECT CURDATE() AS 오늘;

-- 2
SELECT DATE_ADD(CURDATE(), INTERVAL 7 DAY) AS 일주일후;

-- 3
SELECT YEAR(NOW()) AS 년도, MONTH(NOW()) AS 월;
```

---

## 강사 가이드

### 핵심 포인트

1. **집계 함수는 GROUP BY와 짝꿍**: 카테고리별, 날짜별 통계
2. **WHERE vs HAVING**: 그룹화 전/후 필터링 구분
3. **NULL 처리**: 집계 함수는 NULL을 무시
4. **CONCAT 활용**: 사용자 친화적 결과 표시
5. **DATE 함수**: 시계열 분석의 기초

### 자주 하는 질문

**Q: COUNT(*)와 COUNT(column)의 차이는?**
A: `COUNT(*)`는 모든 행 개수, `COUNT(column)`은 NULL이 아닌 행만 센다.

**Q: GROUP BY에 SELECT한 컬럼이 없으면 오류가 나나요?**
A: MySQL은 허용하지만 권장하지 않습니다. PostgreSQL은 오류가 발생합니다.

**Q: 날짜 계산에서 시간대는 어떻게 처리하나요?**
A: MySQL은 시스템 시간대를 사용합니다. `SET time_zone = '+09:00';`로 변경 가능.

**Q: ROUND의 두 번째 인자는 무엇인가요?**
A: 소수점 자릿수입니다. `ROUND(3.14159, 2)` → 3.14

### 실습 진행 팁

1. **집계 함수 체험**: 카테고리별 통계를 단계별로 작성
2. **GROUP BY 시각화**: 같은 값끼리 묶이는 과정 설명
3. **날짜 함수 실습**: 현재 날짜로 다양한 연산 시도
4. **실전 쿼리**: 대시보드 용 통계 쿼리 작성

---

## 요약

- **집계 함수**: 여러 행을 하나로 요약
  - `COUNT(*)`: 행 개수
  - `SUM()`: 합계
  - `AVG()`: 평균
  - `MAX()`, `MIN()`: 최댓값, 최솟값
- **GROUP BY**: 같은 값끼리 그룹화
  - `HAVING`: 그룹 필터링
- **문자열 함수**:
  - `CONCAT()`: 연결
  - `SUBSTRING()`: 부분 추출
  - `UPPER()`, `LOWER()`: 대소문자 변환
- **날짜 함수**:
  - `NOW()`, `CURDATE()`: 현재 날짜시간
  - `YEAR()`, `MONTH()`, `DAY()`: 연월일 추출
  - `DATEDIFF()`: 날짜 차이
  - `DATE_ADD()`, `DATE_SUB()`: 날짜 연산
- **수학 함수**:
  - `ROUND()`: 반올림
  - `CEIL()`, `FLOOR()`: 올림, 내림

**다음 단계**: 실습 프로젝트로 지금까지 배운 모든 내용을 종합 적용합니다!
