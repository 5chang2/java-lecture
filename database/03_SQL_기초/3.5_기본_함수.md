# 3.5. 기본 함수 (집계, 문자열, 날짜)

> SQL의 기본 함수를 사용하여 데이터를 집계하고 가공할 수 있다.

---

## 실습 준비

이 섹션에서는 **world 데이터베이스**를 사용합니다.

```sql
USE world;
```

---

## 1. 함수란?

SQL 함수는 데이터를 **가공하거나 계산**하는 도구입니다.

### 함수 분류

| 분류 | 설명 | 예시 |
|------|------|------|
| **집계 함수** | 여러 행을 계산하여 하나의 값 반환 | COUNT, SUM, AVG, MAX, MIN |
| **문자열 함수** | 문자열 조작 | CONCAT, UPPER, LOWER, SUBSTRING |
| **날짜 함수** | 날짜/시간 처리 | NOW, DATE, YEAR, DATEDIFF |
| **수학 함수** | 수학 연산 | ROUND, CEIL, FLOOR, ABS |

---

## 2. 집계 함수 (Aggregate Functions)

집계 함수는 **여러 행을 하나로 요약**합니다. 주로 `GROUP BY`와 함께 사용합니다.

### 2.1. COUNT: 행 개수

```sql
-- 전체 국가 개수
SELECT COUNT(*) AS 총국가수 FROM country;

-- 특정 컬럼의 NULL이 아닌 개수
SELECT COUNT(LifeExpectancy) AS 평균수명있는국가수 FROM country;

-- 중복 제거한 개수
SELECT COUNT(DISTINCT Continent) AS 대륙수 FROM country;
```

**결과 예시**:
```
+-----------+
|총국가수   |
+-----------+
| 239       |
+-----------+
```

### 2.2. SUM: 합계

```sql
-- 전 세계 총 인구
SELECT SUM(Population) AS 세계총인구 FROM country;

-- 아시아 총 인구
SELECT SUM(Population) AS 아시아총인구
FROM country
WHERE Continent = 'Asia';
```

### 2.3. AVG: 평균

```sql
-- 전 세계 평균 인구
SELECT ROUND(AVG(Population), 0) AS 평균인구 FROM country;

-- 대륙별 평균 인구
SELECT Continent, ROUND(AVG(Population), 0) AS 평균인구
FROM country
GROUP BY Continent;
```

**결과 예시**:
```
+---------------+----------+
|Continent      |평균인구  |
+---------------+----------+
|Asia           |72647562  |
|Europe         |15871186  |
|North America  |13053864  |
+---------------+----------+
```

### 2.4. MAX / MIN: 최댓값 / 최솟값

```sql
-- 가장 많은 인구
SELECT MAX(Population) AS 최대인구 FROM country;

-- 가장 적은 인구
SELECT MIN(Population) AS 최소인구 FROM country WHERE Population > 0;

-- 대륙별 최대/최소 인구
SELECT
    Continent,
    MAX(Population) AS 최대인구,
    MIN(Population) AS 최소인구
FROM country
GROUP BY Continent;
```

---

## 3. GROUP BY: 그룹별 집계

`GROUP BY`는 **같은 값을 가진 행끼리 그룹화**하여 집계합니다.

### 3.1. 기본 사용법

```sql
-- 대륙별 국가 개수
SELECT
    Continent,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent;
```

**결과**:
```
+---------------+-------+
|Continent      |국가수 |
+---------------+-------+
|Asia           |51     |
|Europe         |46     |
|North America  |37     |
|Africa         |58     |
+---------------+-------+
```

### 3.2. 여러 집계 함수 사용

```sql
-- 대륙별 국가 통계
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수,
    SUM(Population) AS 총인구,
    ROUND(AVG(Population), 0) AS 평균인구,
    MAX(Population) AS 최대인구,
    MIN(Population) AS 최소인구
FROM country
GROUP BY Continent;
```

### 3.3. HAVING: 그룹 필터링

`HAVING`은 **그룹화된 결과를 필터링**합니다.

```sql
-- 국가가 40개 이상인 대륙만 조회
SELECT
    Continent,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent
HAVING COUNT(*) >= 40;
```

**WHERE vs HAVING**:
```sql
-- WHERE: 그룹화 전 필터링 (개별 행)
SELECT Continent, COUNT(*) AS 국가수
FROM country
WHERE Population >= 10000000  -- 인구 1천만 이상 국가만
GROUP BY Continent;

-- HAVING: 그룹화 후 필터링 (그룹)
SELECT Continent, COUNT(*) AS 국가수
FROM country
GROUP BY Continent
HAVING COUNT(*) >= 40;  -- 국가가 40개 이상인 대륙만
```

---

## 4. 문자열 함수

### 4.1. CONCAT: 문자열 연결

```sql
-- 국가명과 대륙을 연결
SELECT CONCAT(Name, ' (', Continent, ')') AS 국가정보
FROM country
LIMIT 10;
```

**결과**:
```
+-------------------------+
|국가정보                 |
+-------------------------+
|Afghanistan (Asia)       |
|Netherlands (Europe)     |
|Albania (Europe)         |
+-------------------------+
```

### 4.2. UPPER / LOWER: 대소문자 변환

```sql
-- 국가명을 대문자로
SELECT Name, UPPER(Name) AS 대문자
FROM country
WHERE Name LIKE 'South%'
LIMIT 5;
```

### 4.3. SUBSTRING: 부분 문자열 추출

```sql
-- 국가명의 첫 3글자만 추출
SELECT Name, SUBSTRING(Name, 1, 3) AS 축약명
FROM country
LIMIT 10;
```

**MySQL 인덱스**: 1부터 시작

### 4.4. LENGTH: 문자열 길이

```sql
-- 국가명 길이 계산
SELECT Name, LENGTH(Name) AS 글자수
FROM country
ORDER BY 글자수 DESC
LIMIT 10;
```

### 4.5. TRIM: 공백 제거

```sql
-- 앞뒤 공백 제거
SELECT TRIM('  hello  ');  -- 'hello'

-- 왼쪽/오른쪽만 제거
SELECT LTRIM('  hello  ');  -- 'hello  '
SELECT RTRIM('  hello  ');  -- '  hello'
```

### 4.6. REPLACE: 문자열 치환

```sql
-- 지역명에서 'Eastern'을 'East'로 변경
SELECT
    Region,
    REPLACE(Region, 'Eastern', 'East') AS 수정된지역
FROM country
WHERE Region LIKE '%Eastern%'
LIMIT 10;
```

---

## 5. 날짜 함수

### 5.1. NOW / CURRENT_TIMESTAMP: 현재 날짜시간

```sql
-- 현재 날짜와 시간
SELECT NOW();  -- 2025-01-16 14:30:25

-- 현재 날짜만
SELECT CURDATE();  -- 2025-01-16

-- 현재 시간만
SELECT CURTIME();  -- 14:30:25
```

### 5.2. DATE: 날짜 부분만 추출

```sql
-- 주문 테이블 예시
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 날짜 부분만 추출
SELECT order_id, DATE(order_date) AS 주문일
FROM orders;
```

### 5.3. YEAR, MONTH, DAY: 연월일 추출

```sql
SELECT
    NOW() AS 현재시각,
    YEAR(NOW()) AS 년,
    MONTH(NOW()) AS 월,
    DAY(NOW()) AS 일;
```

**결과**:
```
+---------------------+------+----+----+
|현재시각             |년    |월  |일  |
+---------------------+------+----+----+
|2025-01-16 14:30:25  |2025  |1   |16  |
+---------------------+------+----+----+
```

### 5.4. DATEDIFF: 날짜 차이

```sql
-- 두 날짜 간의 일수 차이
SELECT DATEDIFF('2025-01-20', '2025-01-16') AS 차이;
-- 결과: 4

-- 대출일로부터 며칠 지났는지 (도서관 예시)
SELECT
    book_title,
    loan_date,
    DATEDIFF(NOW(), loan_date) AS 경과일수
FROM loans
WHERE return_date IS NULL;
```

### 5.5. DATE_ADD / DATE_SUB: 날짜 연산

```sql
-- 7일 후 날짜
SELECT DATE_ADD(NOW(), INTERVAL 7 DAY) AS 일주일후;

-- 1개월 전 날짜
SELECT DATE_SUB(NOW(), INTERVAL 1 MONTH) AS 한달전;

-- 대출 후 14일이 반납 예정일
SELECT
    book_title,
    loan_date,
    DATE_ADD(loan_date, INTERVAL 14 DAY) AS 반납예정일
FROM loans;
```

### 5.6. DATE_FORMAT: 날짜 포맷

```sql
-- 날짜를 원하는 형식으로 표시
SELECT DATE_FORMAT(NOW(), '%Y년 %m월 %d일') AS 한글날짜;
-- 결과: 2025년 01월 16일

SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') AS 기본형식;
-- 결과: 2025-01-16 14:30:25
```

**주요 포맷**:
- `%Y`: 4자리 연도 (2025)
- `%m`: 2자리 월 (01)
- `%d`: 2자리 일 (16)
- `%H`: 24시간 형식 시 (14)
- `%i`: 분 (30)
- `%s`: 초 (25)

---

## 6. 수학 함수

### 6.1. ROUND: 반올림

```sql
-- 평균 평균수명을 소수점 첫째 자리에서 반올림
SELECT ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country
WHERE LifeExpectancy IS NOT NULL;
```

### 6.2. CEIL / FLOOR: 올림 / 내림

```sql
SELECT
    AVG(LifeExpectancy) AS 원본,
    CEIL(AVG(LifeExpectancy)) AS 올림,
    FLOOR(AVG(LifeExpectancy)) AS 내림
FROM country
WHERE LifeExpectancy IS NOT NULL;
```

### 6.3. ABS: 절댓값

```sql
SELECT ABS(-100);  -- 100

-- 인구 차이 계산에 활용
SELECT
    Name,
    Population,
    ABS(Population - 50000000) AS 오천만과의차이
FROM country
WHERE Population > 0
ORDER BY 오천만과의차이
LIMIT 10;
```

### 6.4. MOD: 나머지

```sql
-- 인구가 짝수인 국가
SELECT Name, Population
FROM country
WHERE MOD(Population, 2) = 0
LIMIT 10;
```

---

## 7. 실전 예시

### 예시 1: 대륙별 인구 통계

```sql
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수,
    CONCAT(ROUND(SUM(Population) / 1000000, 0), '백만명') AS 총인구,
    CONCAT(ROUND(AVG(LifeExpectancy), 1), '세') AS 평균수명
FROM country
WHERE LifeExpectancy IS NOT NULL
GROUP BY Continent
ORDER BY SUM(Population) DESC;
```

### 예시 2: 지역별 국가 통계

```sql
SELECT
    Region AS 지역,
    COUNT(*) AS 국가수,
    ROUND(AVG(Population), 0) AS 평균인구,
    ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country
WHERE LifeExpectancy IS NOT NULL
GROUP BY Region
HAVING COUNT(*) >= 5
ORDER BY 평균수명 DESC
LIMIT 10;
```

### 예시 3: 인구 규모 분류

```sql
SELECT
    Name,
    Population,
    CASE
        WHEN Population >= 100000000 THEN '초대국'
        WHEN Population >= 50000000 THEN '대국'
        WHEN Population >= 10000000 THEN '중국'
        ELSE '소국'
    END AS 규모
FROM country
WHERE Population > 0
ORDER BY Population DESC
LIMIT 20;
```

---

## 실습 문제

이제 **sakila 데이터베이스**로 실습해봅시다.

```sql
USE sakila;
```

### 문제 1: 집계 함수

다음 쿼리를 작성하세요.

1. 전체 영화의 개수
2. 모든 영화의 평균 대여료
3. 가장 비싼 대여료와 해당 영화 제목

**예상 답**:
```sql
-- 1
SELECT COUNT(*) AS 총영화수 FROM film;

-- 2
SELECT ROUND(AVG(rental_rate), 2) AS 평균대여료
FROM film;

-- 3
SELECT title, rental_rate
FROM film
WHERE rental_rate = (SELECT MAX(rental_rate) FROM film)
LIMIT 10;
```

### 문제 2: GROUP BY

등급(rating)별로 다음 정보를 조회하세요:
- 등급
- 영화 개수
- 평균 대여료
- 최고 대여료
- 최저 대여료

단, 영화가 100개 이상인 등급만 조회하세요.

**예상 답**:
```sql
SELECT
    rating AS 등급,
    COUNT(*) AS 영화수,
    ROUND(AVG(rental_rate), 2) AS 평균대여료,
    MAX(rental_rate) AS 최고대여료,
    MIN(rental_rate) AS 최저대여료
FROM film
GROUP BY rating
HAVING COUNT(*) >= 100
ORDER BY 평균대여료 DESC;
```

### 문제 3: 문자열 함수

영화 정보를 "제목 [등급] - $대여료" 형식으로 출력하세요. (상위 10개)
예: "ACADEMY DINOSAUR [PG] - $0.99"

**예상 답**:
```sql
SELECT CONCAT(title, ' [', rating, '] - $', rental_rate) AS 영화정보
FROM film
LIMIT 10;
```

### 문제 4: 날짜 함수 (rental 테이블 활용)

rental 테이블에서 다음을 조회하세요:
1. 가장 최근 대여 날짜
2. 가장 오래된 대여 날짜
3. 2005년에 대여된 건수

**예상 답**:
```sql
-- 1
SELECT MAX(rental_date) AS 최근대여일 FROM rental;

-- 2
SELECT MIN(rental_date) AS 최초대여일 FROM rental;

-- 3
SELECT COUNT(*) AS 대여건수
FROM rental
WHERE YEAR(rental_date) = 2005;
```

### 문제 5: 종합 문제

배우(actor) 테이블에서 다음을 조회하세요:
1. 전체 배우 수
2. 성(last_name)별 배우 수 (상위 10개)
3. 성이 'A'로 시작하는 배우의 이름을 "성, 이름" 형식으로 출력 (상위 10개)

**예상 답**:
```sql
-- 1
SELECT COUNT(*) AS 총배우수 FROM actor;

-- 2
SELECT
    last_name AS 성,
    COUNT(*) AS 배우수
FROM actor
GROUP BY last_name
ORDER BY 배우수 DESC
LIMIT 10;

-- 3
SELECT CONCAT(last_name, ', ', first_name) AS 배우이름
FROM actor
WHERE last_name LIKE 'A%'
ORDER BY last_name, first_name
LIMIT 10;
```

---

## 강사 가이드

### 핵심 포인트

1. **집계 함수는 GROUP BY와 짝꿍**: 카테고리별, 날짜별 통계
2. **WHERE vs HAVING**: 그룹화 전/후 필터링 구분
3. **NULL 처리**: 집계 함수는 NULL을 무시
4. **CONCAT 활용**: 사용자 친화적 결과 표시
5. **DATE 함수**: 시계열 분석의 기초

### 자주 하는 질문

**Q: COUNT(*)와 COUNT(column)의 차이는?**
A: `COUNT(*)`는 모든 행 개수, `COUNT(column)`은 NULL이 아닌 행만 센다.

**Q: GROUP BY에 SELECT한 컬럼이 없으면 오류가 나나요?**
A: MySQL은 허용하지만 권장하지 않습니다. PostgreSQL은 오류가 발생합니다.

**Q: 날짜 계산에서 시간대는 어떻게 처리하나요?**
A: MySQL은 시스템 시간대를 사용합니다. `SET time_zone = '+09:00';`로 변경 가능.

**Q: ROUND의 두 번째 인자는 무엇인가요?**
A: 소수점 자릿수입니다. `ROUND(3.14159, 2)` → 3.14

### 데이터베이스 활용 전략

1. **world DB (강의 설명 및 예제)**
   - 집계 함수, 문자열 함수, 수학 함수 예제
   - country, city 테이블의 직관적인 데이터
   - 인구, 수명, 대륙 등 이해하기 쉬운 컬럼
   - GROUP BY 개념 설명에 적합

2. **sakila DB (실습 문제)**
   - 실무에 가까운 DVD 렌탈 시스템
   - film, actor, rental 테이블 활용
   - 날짜 함수는 rental 테이블의 실제 타임스탬프 데이터 활용
   - 실전 감각을 기를 수 있음

3. **수업 진행 흐름**
   ```
   1. world DB로 집계 함수 개념 설명 (대륙별, 지역별 통계)
   2. world DB로 문자열/수학 함수 시연 (국가명, 인구 데이터)
   3. sakila DB로 실습 문제 풀이 (영화, 배우, 대여 데이터)
   4. 함수를 조합한 복잡한 쿼리 연습
   ```

### 실습 진행 팁

1. **집계 함수 체험**: 대륙별 통계 → 등급별 통계 순서로 진행
2. **GROUP BY 시각화**: world DB의 대륙 데이터로 그룹화 개념 설명
3. **문자열 함수 실습**: 국가명 조작 → 영화 제목 조작 순서로 연습
4. **날짜 함수 실습**: rental 테이블의 실제 타임스탬프 데이터 활용
5. **실전 쿼리**: 대시보드 용 통계 쿼리 작성 (인구 통계, 영화 분석)

---

## 요약

- **집계 함수**: 여러 행을 하나로 요약
  - `COUNT(*)`: 행 개수
  - `SUM()`: 합계
  - `AVG()`: 평균
  - `MAX()`, `MIN()`: 최댓값, 최솟값
- **GROUP BY**: 같은 값끼리 그룹화
  - `HAVING`: 그룹 필터링
- **문자열 함수**:
  - `CONCAT()`: 연결
  - `SUBSTRING()`: 부분 추출
  - `UPPER()`, `LOWER()`: 대소문자 변환
- **날짜 함수**:
  - `NOW()`, `CURDATE()`: 현재 날짜시간
  - `YEAR()`, `MONTH()`, `DAY()`: 연월일 추출
  - `DATEDIFF()`: 날짜 차이
  - `DATE_ADD()`, `DATE_SUB()`: 날짜 연산
- **수학 함수**:
  - `ROUND()`: 반올림
  - `CEIL()`, `FLOOR()`: 올림, 내림

**다음 단계**: 실습 프로젝트로 지금까지 배운 모든 내용을 종합 적용합니다!
