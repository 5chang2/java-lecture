# 3.8. CASE 조건문

## 학습 목표
- CASE 문의 개념과 문법을 이해한다
- Simple CASE와 Searched CASE의 차이를 안다
- SELECT, WHERE, ORDER BY에서 CASE를 활용할 수 있다
- 집계 함수와 CASE를 조합하여 복잡한 쿼리를 작성할 수 있다

---

## 1. CASE 문이란?

**CASE 문**은 SQL에서 조건부 로직을 처리하는 표현식입니다.

### 1.1. 기본 개념

```sql
-- JavaScript의 if-else와 유사
if (condition) {
    return value1;
} else if (condition2) {
    return value2;
} else {
    return value3;
}

-- SQL의 CASE
CASE
    WHEN condition THEN value1
    WHEN condition2 THEN value2
    ELSE value3
END
```

### 1.2. CASE의 두 가지 형식

**1. Simple CASE** (값 비교)
```sql
CASE column_name
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ELSE default_result
END
```

**2. Searched CASE** (조건 표현식)
```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ELSE default_result
END
```

---

## 2. Simple CASE

### 2.1. 기본 사용법

```sql
-- 대륙명을 한글로 변환
SELECT
    Name AS 국가명,
    Continent,
    CASE Continent
        WHEN 'Asia' THEN '아시아'
        WHEN 'Europe' THEN '유럽'
        WHEN 'Africa' THEN '아프리카'
        WHEN 'North America' THEN '북아메리카'
        WHEN 'South America' THEN '남아메리카'
        WHEN 'Oceania' THEN '오세아니아'
        ELSE '기타'
    END AS 대륙명
FROM country
LIMIT 10;
```

**결과:**
```
국가명          | Continent      | 대륙명
Aruba          | North America  | 북아메리카
Afghanistan    | Asia           | 아시아
Angola         | Africa         | 아프리카
Albania        | Europe         | 유럽
```

### 2.2. JavaScript 비교

**JavaScript:**
```javascript
function getContinentName(continent) {
    switch(continent) {
        case 'Asia': return '아시아';
        case 'Europe': return '유럽';
        case 'Africa': return '아프리카';
        default: return '기타';
    }
}
```

**SQL:**
```sql
CASE Continent
    WHEN 'Asia' THEN '아시아'
    WHEN 'Europe' THEN '유럽'
    WHEN 'Africa' THEN '아프리카'
    ELSE '기타'
END
```

---

## 3. Searched CASE

### 3.1. 조건식 사용

```sql
-- 인구 규모별 분류
SELECT
    Name AS 국가명,
    Population AS 인구,
    CASE
        WHEN Population >= 100000000 THEN '초대형'
        WHEN Population >= 50000000 THEN '대형'
        WHEN Population >= 10000000 THEN '중형'
        WHEN Population >= 1000000 THEN '소형'
        ELSE '초소형'
    END AS 인구규모
FROM country
WHERE Population > 0
ORDER BY Population DESC
LIMIT 10;
```

**결과:**
```
국가명    | 인구        | 인구규모
China    | 1277558000 | 초대형
India    | 1013662000 | 초대형
USA      | 278357000  | 대형
Indonesia| 212107000  | 대형
Brazil   | 170115000  | 대형
```

### 3.2. 복잡한 조건

```sql
-- 국가 등급 분류 (인구 + GNP 고려)
SELECT
    Name AS 국가명,
    Population AS 인구,
    GNP,
    CASE
        WHEN Population >= 100000000 AND GNP >= 1000000 THEN 'S등급'
        WHEN Population >= 50000000 OR GNP >= 500000 THEN 'A등급'
        WHEN Population >= 10000000 AND GNP >= 100000 THEN 'B등급'
        ELSE 'C등급'
    END AS 국가등급
FROM country
WHERE GNP > 0
ORDER BY Population DESC, GNP DESC
LIMIT 10;
```

---

## 4. SELECT에서 CASE 활용

### 4.1. 여러 CASE 동시 사용

```sql
SELECT
    Name AS 국가명,
    Continent,
    Population,
    -- 대륙 분류
    CASE Continent
        WHEN 'Asia' THEN '아시아'
        WHEN 'Europe' THEN '유럽'
        ELSE '기타'
    END AS 대륙,
    -- 인구 등급
    CASE
        WHEN Population >= 50000000 THEN '대국'
        WHEN Population >= 10000000 THEN '중국'
        ELSE '소국'
    END AS 인구등급
FROM country
WHERE Continent IN ('Asia', 'Europe')
LIMIT 10;
```

### 4.2. 계산식과 조합

```sql
-- 1인당 GNP 계산 및 경제 수준 분류
SELECT
    Name AS 국가명,
    Population AS 인구,
    GNP,
    ROUND(GNP / Population * 1000000, 2) AS 1인당GNP,
    CASE
        WHEN (GNP / Population * 1000000) >= 40000 THEN '선진국'
        WHEN (GNP / Population * 1000000) >= 12000 THEN '중진국'
        WHEN (GNP / Population * 1000000) >= 4000 THEN '개발도상국'
        ELSE '저개발국'
    END AS 경제수준
FROM country
WHERE Population > 0 AND GNP > 0
ORDER BY 1인당GNP DESC
LIMIT 10;
```

---

## 5. WHERE절에서 CASE 활용

### 5.1. 조건부 필터링

```sql
-- 대륙별로 다른 인구 기준 적용
SELECT
    Name AS 국가명,
    Continent AS 대륙,
    Population AS 인구
FROM country
WHERE Population >= CASE Continent
    WHEN 'Asia' THEN 50000000      -- 아시아는 5천만 이상
    WHEN 'Europe' THEN 30000000    -- 유럽은 3천만 이상
    WHEN 'Africa' THEN 20000000    -- 아프리카는 2천만 이상
    ELSE 10000000                  -- 기타는 1천만 이상
END
ORDER BY Continent, Population DESC;
```

---

## 6. ORDER BY에서 CASE 활용

### 6.1. 조건부 정렬

```sql
-- 대륙별로 다른 정렬 기준 적용
SELECT
    Name AS 국가명,
    Continent AS 대륙,
    Population AS 인구,
    GNP
FROM country
WHERE Population > 10000000
ORDER BY
    Continent,
    CASE Continent
        WHEN 'Asia' THEN Population     -- 아시아는 인구 기준
        WHEN 'Europe' THEN GNP          -- 유럽은 GNP 기준
        ELSE Population                 -- 기타는 인구 기준
    END DESC
LIMIT 20;
```

### 6.2. 특정 값 우선 정렬

```sql
-- 한국, 일본, 중국을 먼저 보여주고 나머지는 인구순
SELECT
    Name AS 국가명,
    Continent AS 대륙,
    Population AS 인구
FROM country
WHERE Continent = 'Asia'
ORDER BY
    CASE Name
        WHEN 'South Korea' THEN 1
        WHEN 'Japan' THEN 2
        WHEN 'China' THEN 3
        ELSE 4
    END,
    Population DESC
LIMIT 15;
```

---

## 7. 집계 함수와 CASE 조합

### 7.1. 조건부 집계

```sql
-- 대륙별 인구 규모 분포
SELECT
    Continent AS 대륙,
    COUNT(*) AS 전체국가수,
    SUM(CASE WHEN Population >= 50000000 THEN 1 ELSE 0 END) AS 5천만이상,
    SUM(CASE WHEN Population >= 10000000 AND Population < 50000000 THEN 1 ELSE 0 END) AS 천만이상,
    SUM(CASE WHEN Population < 10000000 THEN 1 ELSE 0 END) AS 천만미만
FROM country
GROUP BY Continent
ORDER BY 전체국가수 DESC;
```

**결과:**
```
대륙            | 전체국가수 | 5천만이상 | 천만이상 | 천만미만
Africa         | 58        | 4   | 15  | 39
Europe         | 46        | 3   | 12  | 31
Asia           | 51        | 10  | 20  | 21
```

### 7.2. 조건부 합계

```sql
-- 대륙별 경제 규모 분석
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수,
    SUM(CASE WHEN GNP >= 100000 THEN GNP ELSE 0 END) AS 선진국GNP합계,
    SUM(CASE WHEN GNP < 100000 THEN GNP ELSE 0 END) AS 개도국GNP합계,
    SUM(GNP) AS 전체GNP합계
FROM country
WHERE GNP IS NOT NULL
GROUP BY Continent
ORDER BY 전체GNP합계 DESC;
```

### 7.3. 조건부 평균

```sql
-- 대륙별 대도시 vs 중소도시 평균 인구
SELECT
    co.Continent AS 대륙,
    AVG(CASE WHEN ci.Population >= 1000000 THEN ci.Population END) AS 대도시평균인구,
    AVG(CASE WHEN ci.Population < 1000000 THEN ci.Population END) AS 중소도시평균인구
FROM city ci
JOIN country co ON ci.CountryCode = co.Code
GROUP BY co.Continent
ORDER BY 대도시평균인구 DESC;
```

---

## 8. 실전 예제

### 8.1. 성적 등급 변환

```sql
-- 도시 인구 기준 등급 부여
SELECT
    Name AS 도시명,
    CountryCode AS 국가코드,
    Population AS 인구,
    CASE
        WHEN Population >= 5000000 THEN 'S등급'
        WHEN Population >= 1000000 THEN 'A등급'
        WHEN Population >= 500000 THEN 'B등급'
        WHEN Population >= 100000 THEN 'C등급'
        ELSE 'D등급'
    END AS 도시등급
FROM city
ORDER BY Population DESC
LIMIT 20;
```

### 8.2. 재고 상태 표시

```sql
-- 국가별 공식언어 사용 비율 분석
SELECT
    cl.CountryCode AS 국가코드,
    c.Name AS 국가명,
    cl.Language AS 언어,
    cl.Percentage AS 사용비율,
    CASE
        WHEN cl.Percentage >= 90 THEN '주요언어'
        WHEN cl.Percentage >= 50 THEN '공용언어'
        WHEN cl.Percentage >= 10 THEN '소수언어'
        ELSE '극소수언어'
    END AS 언어분류
FROM countrylanguage cl
JOIN country c ON cl.CountryCode = c.Code
WHERE cl.IsOfficial = 'T'
ORDER BY c.Name, cl.Percentage DESC
LIMIT 30;
```

---

## 9. 실습 문제 (sakila DB 사용)

### Mission 1: 영화 등급 분류 (⭐⭐)

**문제:**
영화(film) 테이블에서 rental_rate를 기준으로 가격 등급을 분류하세요.

**요구사항:**
- 4.99 이상: 프리미엄
- 2.99 ~ 4.98: 일반
- 2.99 미만: 저가
- film_id, title, rental_rate, 가격등급 출력
- 20개만 조회

**정답:**
```sql
SELECT
    film_id,
    title AS 제목,
    rental_rate AS 대여료,
    CASE
        WHEN rental_rate >= 4.99 THEN '프리미엄'
        WHEN rental_rate >= 2.99 THEN '일반'
        ELSE '저가'
    END AS 가격등급
FROM film
LIMIT 20;
```

---

### Mission 2: 고객 등급 분류 (⭐⭐⭐)

**문제:**
고객(customer)의 대여 횟수에 따라 등급을 분류하세요.

**요구사항:**
- rental 테이블과 JOIN
- 대여 횟수 30회 이상: VIP
- 20~29회: 골드
- 10~19회: 실버
- 10회 미만: 일반
- customer_id, 이름, 대여횟수, 등급 출력
- 대여횟수 기준 내림차순

**정답:**
```sql
SELECT
    c.customer_id,
    CONCAT(c.first_name, ' ', c.last_name) AS 이름,
    COUNT(r.rental_id) AS 대여횟수,
    CASE
        WHEN COUNT(r.rental_id) >= 30 THEN 'VIP'
        WHEN COUNT(r.rental_id) >= 20 THEN '골드'
        WHEN COUNT(r.rental_id) >= 10 THEN '실버'
        ELSE '일반'
    END AS 등급
FROM customer c
LEFT JOIN rental r ON c.customer_id = r.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name
ORDER BY 대여횟수 DESC;
```

---

### Mission 3: 영화 길이별 분류 통계 (⭐⭐⭐⭐)

**문제:**
영화를 길이(length)별로 분류하고, 각 분류별 개수를 구하세요.

**요구사항:**
- 120분 이상: 장편
- 90~119분: 중편
- 60~89분: 단편
- 60분 미만: 초단편
- rating별로 그룹화
- rating, 장편, 중편, 단편, 초단편 개수 출력

**정답:**
```sql
SELECT
    rating AS 등급,
    SUM(CASE WHEN length >= 120 THEN 1 ELSE 0 END) AS 장편,
    SUM(CASE WHEN length >= 90 AND length < 120 THEN 1 ELSE 0 END) AS 중편,
    SUM(CASE WHEN length >= 60 AND length < 90 THEN 1 ELSE 0 END) AS 단편,
    SUM(CASE WHEN length < 60 THEN 1 ELSE 0 END) AS 초단편,
    COUNT(*) AS 전체
FROM film
GROUP BY rating
ORDER BY rating;
```

---

### Mission 4: 대여료 수익 분석 (⭐⭐⭐⭐⭐)

**문제:**
영화 카테고리별로 대여료 수준에 따른 영화 수와 평균 대여료를 구하세요.

**요구사항:**
- film, film_category, category 테이블 JOIN
- 대여료 4.99: 고가
- 대여료 2.99: 중가
- 나머지: 저가
- category.name, 고가영화수, 중가영화수, 저가영화수, 평균대여료 출력
- 평균대여료 기준 내림차순

**정답:**
```sql
SELECT
    c.name AS 카테고리,
    SUM(CASE WHEN f.rental_rate = 4.99 THEN 1 ELSE 0 END) AS 고가영화수,
    SUM(CASE WHEN f.rental_rate = 2.99 THEN 1 ELSE 0 END) AS 중가영화수,
    SUM(CASE WHEN f.rental_rate < 2.99 THEN 1 ELSE 0 END) AS 저가영화수,
    ROUND(AVG(f.rental_rate), 2) AS 평균대여료
FROM film f
JOIN film_category fc ON f.film_id = fc.film_id
JOIN category c ON fc.category_id = c.category_id
GROUP BY c.name
ORDER BY 평균대여료 DESC;
```

---

### Mission 5: 조건부 정렬 (⭐⭐⭐⭐⭐)

**문제:**
영화를 등급(rating)별로 다른 기준으로 정렬하세요.

**요구사항:**
- PG-13, R 등급: rental_rate 내림차순
- G, PG 등급: length 내림차순
- 나머지: title 오름차순
- film_id, title, rating, rental_rate, length 출력
- 30개만 조회

**정답:**
```sql
SELECT
    film_id,
    title AS 제목,
    rating AS 등급,
    rental_rate AS 대여료,
    length AS 길이
FROM film
ORDER BY
    rating,
    CASE
        WHEN rating IN ('PG-13', 'R') THEN rental_rate * -1  -- 내림차순
        WHEN rating IN ('G', 'PG') THEN length * -1          -- 내림차순
        ELSE 0
    END,
    CASE
        WHEN rating NOT IN ('PG-13', 'R', 'G', 'PG') THEN title
        ELSE ''
    END
LIMIT 30;
```

---

## 강사 가이드

### 수업 진행 팁

**1. CASE 개념 설명 (15분)**
- JavaScript if-else, switch와 비교
- Simple CASE vs Searched CASE
- 화이트보드에 흐름도 그리기

**2. SELECT에서 실습 (20분)**
- 대륙명 한글 변환 (Simple CASE)
- 인구 규모 분류 (Searched CASE)
- 학생들이 직접 조건 추가해보기

**3. 집계 함수와 조합 (25분)**
- CASE를 SUM 안에 넣기
- 조건부 집계의 실용성 강조
- "이렇게 하면 피벗 테이블처럼 사용 가능"

**4. 실습 문제 풀이 (30분)**
- Mission 1~2: 함께 풀이
- Mission 3~5: 학생들이 먼저 시도
- 다양한 풀이 방법 공유

### 자주 하는 질문

**Q1: CASE와 IF의 차이는?**
> A: IF는 저장 프로시저에서 사용하는 제어문이고, CASE는 SELECT 문에서 사용하는 표현식입니다. CASE는 값을 반환하지만, IF는 제어 흐름을 결정합니다.

**Q2: ELSE를 생략하면 어떻게 되나요?**
> A: ELSE를 생략하면 조건에 맞지 않는 경우 NULL이 반환됩니다.

**Q3: CASE 안에 CASE를 중첩할 수 있나요?**
> A: 가능하지만 가독성이 떨어집니다. 대신 AND, OR로 조건을 조합하는 것을 권장합니다.

**Q4: Simple CASE와 Searched CASE 중 어떤 것을 사용해야 하나요?**
> A: 단순 값 비교는 Simple CASE, 범위 비교나 복잡한 조건은 Searched CASE를 사용하세요.

### 실습 중 흔한 실수

**1. END 누락**
```sql
-- ❌ 에러 발생
SELECT
    Name,
    CASE Continent
        WHEN 'Asia' THEN '아시아'
    -- END가 없음!
FROM country;

-- ✅ 올바른 코드
SELECT
    Name,
    CASE Continent
        WHEN 'Asia' THEN '아시아'
    END AS 대륙
FROM country;
```

**2. THEN 누락**
```sql
-- ❌ 에러
CASE
    WHEN Population > 1000000 '대국'  -- THEN 누락
END

-- ✅ 올바른 코드
CASE
    WHEN Population > 1000000 THEN '대국'
END
```

**3. 조건 순서 실수**
```sql
-- ❌ 모든 값이 '소형'으로 분류됨
CASE
    WHEN Population > 0 THEN '소형'          -- 먼저 체크되어 항상 참
    WHEN Population >= 10000000 THEN '대형'  -- 실행 안 됨
END

-- ✅ 큰 조건부터
CASE
    WHEN Population >= 10000000 THEN '대형'
    WHEN Population > 0 THEN '소형'
END
```

---

## 요약

### CASE 문법

**Simple CASE:**
```sql
CASE column_name
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ELSE default_result
END
```

**Searched CASE:**
```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ELSE default_result
END
```

### 활용 위치

- ✅ **SELECT**: 값 변환, 조건부 표시
- ✅ **WHERE**: 조건부 필터링
- ✅ **ORDER BY**: 조건부 정렬
- ✅ **집계 함수**: 조건부 집계

### JavaScript 비교

| JavaScript | SQL |
|-----------|-----|
| if-else | Searched CASE |
| switch | Simple CASE |
| ternary (? :) | CASE ... END |

### 다음 단계
다음 시간에는 **실습: SQL 기초 종합 (3.9)**을 진행합니다.

---

**CASE 문 학습 완료!** 이제 조건부 로직을 자유롭게 사용할 수 있습니다! 🎯
