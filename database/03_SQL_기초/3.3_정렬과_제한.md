# 3.3. 정렬과 제한 (ORDER BY, LIMIT)

> ORDER BY로 결과를 정렬하고, LIMIT로 결과 개수를 제한할 수 있다.

---

## 1. ORDER BY: 결과 정렬하기

`ORDER BY` 절은 조회된 결과를 **특정 컬럼 기준으로 정렬**합니다.

### 1.1. 기본 구조

```sql
SELECT 컬럼명
FROM 테이블명
ORDER BY 정렬기준컬럼 [ASC|DESC];
```

- **ASC** (Ascending): 오름차순 (기본값, 생략 가능)
- **DESC** (Descending): 내림차순

---

## 2. 단일 컬럼 정렬

### 2.1. 오름차순 정렬 (ASC)

```sql
-- 가격이 낮은 순서대로 정렬
SELECT product_name, price
FROM products
ORDER BY price ASC;

-- ASC는 생략 가능
SELECT product_name, price
FROM products
ORDER BY price;
```

**결과**:
```
+------------+--------+
|product_name|price   |
+------------+--------+
| 펜         |1000    |
| 노트       |2000    |
| 마우스     |25000   |
| 키보드     |80000   |
| 책상       |150000  |
| 의자       |200000  |
| 모니터     |300000  |
| 노트북     |1500000 |
+------------+--------+
```

### 2.2. 내림차순 정렬 (DESC)

```sql
-- 가격이 높은 순서대로 정렬
SELECT product_name, price
FROM products
ORDER BY price DESC;
```

**결과**:
```
+------------+--------+
|product_name|price   |
+------------+--------+
| 노트북     |1500000 |
| 모니터     |300000  |
| 의자       |200000  |
| 책상       |150000  |
| 키보드     |80000   |
| 마우스     |25000   |
| 노트       |2000    |
| 펜         |1000    |
+------------+--------+
```

### 2.3. 문자열 정렬

```sql
-- 상품명 가나다순 정렬
SELECT product_name, category
FROM products
ORDER BY product_name ASC;
```

**결과**:
```
+------------+----------+
|product_name|category  |
+------------+----------+
| 노트       |문구      |
| 노트북     |전자제품  |
| 마우스     |전자제품  |
| 모니터     |전자제품  |
| 의자       |가구      |
| 키보드     |전자제품  |
| 책상       |가구      |
| 펜         |문구      |
+------------+----------+
```

---

## 3. 다중 컬럼 정렬

여러 컬럼을 기준으로 순차적으로 정렬할 수 있습니다.

### 3.1. 2차 정렬

```sql
-- 1차: 카테고리 순, 2차: 가격 높은 순
SELECT product_name, category, price
FROM products
ORDER BY category ASC, price DESC;
```

**동작 방식**:
1. 먼저 `category`로 오름차순 정렬
2. 같은 카테고리 내에서 `price`로 내림차순 정렬

**결과**:
```
+------------+----------+--------+
|product_name|category  |price   |
+------------+----------+--------+
| 의자       |가구      |200000  |
| 책상       |가구      |150000  |
| 노트       |문구      |2000    |
| 펜         |문구      |1000    |
| 노트북     |전자제품  |1500000 |
| 모니터     |전자제품  |300000  |
| 키보드     |전자제품  |80000   |
| 마우스     |전자제품  |25000   |
+------------+----------+--------+
```

### 3.2. 3차 정렬

```sql
-- 1차: 카테고리, 2차: 가격, 3차: 재고
SELECT product_name, category, price, stock
FROM products
ORDER BY category ASC, price DESC, stock ASC;
```

---

## 4. ORDER BY와 WHERE 함께 사용

`WHERE`로 필터링한 후 정렬할 수 있습니다.

```sql
-- 전자제품 중 가격이 높은 순서대로 조회
SELECT product_name, price
FROM products
WHERE category = '전자제품'
ORDER BY price DESC;
```

**결과**:
```
+------------+--------+
|product_name|price   |
+------------+--------+
| 노트북     |1500000 |
| 모니터     |300000  |
| 키보드     |80000   |
| 마우스     |25000   |
+------------+--------+
```

**실행 순서**:
```
FROM → WHERE → SELECT → ORDER BY
```

---

## 5. LIMIT: 결과 개수 제한

`LIMIT`는 조회 결과의 **개수를 제한**합니다.

### 5.1. 기본 사용법

```sql
-- 상위 3개만 조회
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 3;
```

**결과**:
```
+------------+--------+
|product_name|price   |
+------------+--------+
| 노트북     |1500000 |
| 모니터     |300000  |
| 의자       |200000  |
+------------+--------+
```

**활용 사례**:
- 베스트 상품 TOP 10
- 최신 게시글 5개
- 인기 검색어 상위 3개

### 5.2. LIMIT과 ORDER BY

`LIMIT`는 거의 항상 `ORDER BY`와 함께 사용합니다.

```sql
-- 가장 비싼 상품 1개
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 1;
```

**주의**: `ORDER BY` 없이 `LIMIT`만 사용하면 **결과가 불확실**합니다.

```sql
-- ❌ 나쁜 예: 어떤 3개가 나올지 불명확
SELECT * FROM products LIMIT 3;

-- ✅ 좋은 예: 가격이 낮은 3개
SELECT * FROM products ORDER BY price ASC LIMIT 3;
```

---

## 6. OFFSET: 시작 위치 지정

`OFFSET`은 결과의 **시작 위치를 건너뛰고** 조회합니다. 주로 페이지네이션에 사용합니다.

### 6.1. 기본 구조

```sql
SELECT 컬럼명
FROM 테이블명
ORDER BY 정렬기준
LIMIT 개수 OFFSET 건너뛸개수;
```

### 6.2. 페이지네이션 예시

```sql
-- 1페이지: 상위 5개
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 5 OFFSET 0;

-- 2페이지: 6~10번째
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 5 OFFSET 5;

-- 3페이지: 11~15번째
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 5 OFFSET 10;
```

**페이지 공식**:
```
페이지 크기 = N
페이지 번호 = P (1부터 시작)

LIMIT N OFFSET (P - 1) * N
```

### 6.3. 축약 문법

MySQL에서는 `LIMIT`에 2개의 값을 전달하여 간단히 표현할 수 있습니다.

```sql
-- LIMIT 개수 OFFSET 시작위치
SELECT * FROM products ORDER BY price DESC LIMIT 5 OFFSET 5;

-- 축약 형태: LIMIT 시작위치, 개수
SELECT * FROM products ORDER BY price DESC LIMIT 5, 5;
```

---

## 7. 실전 예시

### 예시 1: TOP 3 고가 상품

```sql
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 3;
```

### 예시 2: 재고가 적은 상품 5개

```sql
SELECT product_name, stock
FROM products
WHERE stock > 0  -- 재고가 있는 상품만
ORDER BY stock ASC
LIMIT 5;
```

### 예시 3: 카테고리별 최저가 상품

```sql
-- 전자제품 중 가장 저렴한 상품
SELECT product_name, price
FROM products
WHERE category = '전자제품'
ORDER BY price ASC
LIMIT 1;
```

### 예시 4: 페이지네이션 (한 페이지에 3개씩)

```sql
-- 1페이지
SELECT product_name, price
FROM products
ORDER BY product_name
LIMIT 3 OFFSET 0;

-- 2페이지
SELECT product_name, price
FROM products
ORDER BY product_name
LIMIT 3 OFFSET 3;
```

---

## 8. NULL 정렬

### 8.1. NULL 값의 정렬 위치

- **MySQL**: NULL이 가장 먼저 (오름차순 기준)
- **PostgreSQL**: NULL이 가장 나중 (오름차순 기준)

```sql
-- MySQL: NULL이 먼저 나옴
SELECT product_name, price
FROM products
ORDER BY price ASC;
```

### 8.2. NULL 정렬 제어

```sql
-- NULL을 제외하고 정렬
SELECT product_name, price
FROM products
WHERE price IS NOT NULL
ORDER BY price DESC;

-- NULL을 마지막에 배치 (MySQL)
SELECT product_name, price
FROM products
ORDER BY price IS NULL, price DESC;
```

---

## 실습 문제

### 문제 1: 기본 정렬

다음 요구사항에 맞는 SQL을 작성하세요.

1. 모든 상품을 재고가 많은 순서대로 조회
2. 상품명을 가나다순으로 조회
3. 가격이 낮은 순서대로 상위 5개 조회

**예상 답**:
```sql
-- 1
SELECT * FROM products ORDER BY stock DESC;

-- 2
SELECT product_name FROM products ORDER BY product_name ASC;

-- 3
SELECT product_name, price FROM products ORDER BY price ASC LIMIT 5;
```

### 문제 2: 다중 정렬

다음 요구사항에 맞는 SQL을 작성하세요.

"카테고리별로 그룹화하고, 같은 카테고리 내에서는 가격이 높은 순서대로 정렬"

**예상 답**:
```sql
SELECT product_name, category, price
FROM products
ORDER BY category ASC, price DESC;
```

### 문제 3: 페이지네이션

한 페이지에 4개씩 보여주는 페이지네이션을 구현하세요.
가격이 높은 순서대로 정렬하고, 2페이지를 조회하세요.

**예상 답**:
```sql
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 4 OFFSET 4;

-- 또는 축약형
SELECT product_name, price
FROM products
ORDER BY price DESC
LIMIT 4, 4;
```

### 문제 4: 복합 쿼리

다음 요구사항을 SQL로 작성하세요.

"전자제품 중에서 재고가 10개 이상인 상품을 가격이 높은 순서대로 상위 3개 조회"

**예상 답**:
```sql
SELECT product_name, price, stock
FROM products
WHERE category = '전자제품' AND stock >= 10
ORDER BY price DESC
LIMIT 3;
```

---

## 강사 가이드

### 핵심 포인트

1. **ORDER BY 위치**: SELECT 다음, LIMIT 이전
2. **LIMIT은 항상 ORDER BY와 함께**: 결과가 불확실하지 않도록
3. **다중 정렬 순서**: 첫 번째 컬럼 → 두 번째 컬럼 순서대로 적용
4. **페이지네이션**: `LIMIT N OFFSET (page-1)*N`
5. **성능**: OFFSET이 크면 성능 저하 (대안: 커서 기반 페이지네이션)

### 자주 하는 질문

**Q: ORDER BY 없이 LIMIT을 쓰면 어떻게 되나요?**
A: 결과가 불확실합니다. 데이터베이스가 내부적으로 저장된 순서대로 반환하지만, 이 순서는 보장되지 않습니다.

**Q: LIMIT 0은 무슨 의미인가요?**
A: 0개를 조회합니다. 주로 테이블 구조만 확인할 때 사용합니다.
```sql
SELECT * FROM products LIMIT 0;  -- 결과는 없지만 컬럼 정보는 확인 가능
```

**Q: OFFSET이 너무 크면 어떻게 되나요?**
A: 성능이 저하됩니다. 데이터베이스가 앞의 행들을 모두 건너뛰어야 하기 때문입니다. 대안으로 `WHERE id > last_id LIMIT N` 방식을 사용할 수 있습니다.

**Q: ORDER BY에 여러 컬럼을 쓸 때 각각 ASC/DESC를 다르게 할 수 있나요?**
A: 네, 가능합니다.
```sql
ORDER BY category ASC, price DESC, stock ASC
```

### 실습 진행 팁

1. **시각화**: ORDER BY 결과를 화면으로 보여주며 순서 확인
2. **페이지네이션 실습**: 1페이지, 2페이지, 3페이지를 순차적으로 조회
3. **실수 유도**: ORDER BY 없이 LIMIT 사용하여 불확실성 체험
4. **대용량 시뮬레이션**: OFFSET 1000000 같은 큰 값으로 성능 차이 설명

---

## 요약

- **ORDER BY**: 결과를 정렬
  - `ASC`: 오름차순 (기본값)
  - `DESC`: 내림차순
- **다중 정렬**: `ORDER BY col1, col2` (순서대로 적용)
- **LIMIT**: 결과 개수 제한
  - `LIMIT N`: 상위 N개
- **OFFSET**: 시작 위치 지정
  - `LIMIT N OFFSET M`: M번째부터 N개
- **페이지네이션**: `LIMIT pageSize OFFSET (pageNum-1)*pageSize`
- **쿼리 실행 순서**: `FROM` → `WHERE` → `SELECT` → `ORDER BY` → `LIMIT`
- **NULL 정렬**: DBMS마다 다름, `IS NOT NULL`로 제외 가능

**다음 단계**: INSERT, UPDATE, DELETE로 데이터를 추가/수정/삭제하는 방법을 배웁니다!
