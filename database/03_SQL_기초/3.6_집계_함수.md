# 3.6. 집계 함수 (COUNT, SUM, AVG, MAX, MIN)

> SQL의 집계 함수를 사용하여 데이터를 요약하고 분석할 수 있다.

---

## 실습 준비

이 섹션에서는 **world 데이터베이스**를 사용합니다.

```sql
USE world;
```

---

## 1. 집계 함수란?

**집계 함수(Aggregate Functions)**는 **여러 행의 데이터를 하나의 값으로 요약**합니다.

### 주요 집계 함수

| 함수 | 설명 | 예시 |
|------|------|------|
| **COUNT()** | 행의 개수 | `COUNT(*)` → 전체 행 수 |
| **SUM()** | 합계 | `SUM(Population)` → 총 인구 |
| **AVG()** | 평균 | `AVG(Population)` → 평균 인구 |
| **MAX()** | 최댓값 | `MAX(Population)` → 최대 인구 |
| **MIN()** | 최솟값 | `MIN(Population)` → 최소 인구 |

**특징:**
- 여러 행 → 하나의 결과값
- NULL 값은 자동으로 제외 (COUNT(*) 제외)
- 주로 `GROUP BY`와 함께 사용

---

## 2. COUNT: 행 개수

### 2.1. COUNT(*): 전체 행 개수

```sql
-- 전체 국가 개수
SELECT COUNT(*) AS 총국가수 FROM country;
```

**결과**:
```
+-----------+
|총국가수   |
+-----------+
| 239       |
+-----------+
```

### 2.2. COUNT(컬럼): NULL 제외 개수

```sql
-- LifeExpectancy가 NULL이 아닌 국가 수
SELECT COUNT(LifeExpectancy) AS 평균수명있는국가수
FROM country;

-- LifeExpectancy가 NULL인 국가 수
SELECT
    COUNT(*) - COUNT(LifeExpectancy) AS NULL인국가수
FROM country;
```

**차이점:**
- `COUNT(*)`: 모든 행 개수 (NULL 포함)
- `COUNT(컬럼)`: NULL이 아닌 행만 개수

### 2.3. COUNT(DISTINCT): 중복 제거 개수

```sql
-- 대륙 종류 개수
SELECT COUNT(DISTINCT Continent) AS 대륙수 FROM country;
-- 결과: 7

-- 지역 종류 개수
SELECT COUNT(DISTINCT Region) AS 지역수 FROM country;
```

---

## 3. SUM: 합계

### 3.1. 기본 사용

```sql
-- 전 세계 총 인구
SELECT SUM(Population) AS 세계총인구 FROM country;
```

### 3.2. 조건과 함께 사용

```sql
-- 아시아 총 인구
SELECT SUM(Population) AS 아시아총인구
FROM country
WHERE Continent = 'Asia';

-- 인구 1억 이상 국가의 총 인구
SELECT SUM(Population) AS 대국총인구
FROM country
WHERE Population >= 100000000;
```

### 3.3. 계산된 값의 합계

```sql
-- 모든 도시 인구의 합계
SELECT SUM(Population) AS 도시총인구
FROM city;

-- 전 세계 국가 면적 합계 (SurfaceArea)
SELECT
    SUM(SurfaceArea) AS 총면적,
    ROUND(SUM(SurfaceArea) / 1000000, 2) AS '총면적(백만km²)'
FROM country;
```

---

## 4. AVG: 평균

### 4.1. 기본 평균

```sql
-- 전 세계 평균 인구
SELECT ROUND(AVG(Population), 0) AS 평균인구
FROM country;
```

**주의:** NULL 값은 자동으로 제외됩니다.

```sql
-- 평균 수명 계산 (NULL 제외)
SELECT
    ROUND(AVG(LifeExpectancy), 1) AS 평균수명,
    COUNT(*) AS 전체국가수,
    COUNT(LifeExpectancy) AS 수명데이터있는국가수
FROM country;
```

### 4.2. 조건부 평균

```sql
-- 아시아 국가의 평균 인구
SELECT ROUND(AVG(Population), 0) AS 아시아평균인구
FROM country
WHERE Continent = 'Asia';

-- 인구 1천만 이상 국가의 평균 수명
SELECT ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country
WHERE Population >= 10000000
  AND LifeExpectancy IS NOT NULL;
```

---

## 5. MAX / MIN: 최댓값 / 최솟값

### 5.1. 기본 사용

```sql
-- 가장 많은 인구
SELECT MAX(Population) AS 최대인구 FROM country;

-- 가장 적은 인구 (0 제외)
SELECT MIN(Population) AS 최소인구
FROM country
WHERE Population > 0;
```

### 5.2. 최댓값/최솟값을 가진 행 찾기

```sql
-- 인구가 가장 많은 국가 (서브쿼리 사용)
SELECT Name, Population
FROM country
WHERE Population = (SELECT MAX(Population) FROM country);

-- 수명이 가장 긴 국가
SELECT Name, LifeExpectancy
FROM country
WHERE LifeExpectancy = (SELECT MAX(LifeExpectancy) FROM country);
```

### 5.3. 여러 집계 함수 조합

```sql
-- 인구 통계 요약
SELECT
    COUNT(*) AS 총국가수,
    SUM(Population) AS 총인구,
    ROUND(AVG(Population), 0) AS 평균인구,
    MAX(Population) AS 최대인구,
    MIN(Population) AS 최소인구
FROM country
WHERE Population > 0;
```

---

## 6. 집계 함수와 NULL

### 6.1. NULL 처리 방식

```sql
-- LifeExpectancy 통계
SELECT
    COUNT(*) AS 전체국가,
    COUNT(LifeExpectancy) AS 수명데이터있음,
    COUNT(*) - COUNT(LifeExpectancy) AS 수명NULL개수,
    ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country;
```

**결과 예시:**
```
+-----------+-----------------+--------------+-----------+
|전체국가   |수명데이터있음   |수명NULL개수  |평균수명   |
+-----------+-----------------+--------------+-----------+
| 239       | 222             | 17           | 66.5      |
+-----------+-----------------+--------------+-----------+
```

### 6.2. COALESCE로 NULL 처리

```sql
-- NULL을 0으로 처리하여 평균 계산
SELECT
    AVG(LifeExpectancy) AS 평균1,  -- NULL 제외
    AVG(COALESCE(LifeExpectancy, 0)) AS 평균2  -- NULL을 0으로 처리
FROM country;
```

---

## 실습 문제

이제 **sakila 데이터베이스**로 실습해봅시다.

```sql
USE sakila;
```

### 문제 1: COUNT

다음을 조회하세요:
1. 전체 영화 개수
2. 등급(rating)이 'PG'인 영화 개수
3. 서로 다른 등급(rating)의 개수

**예상 답:**
```sql
-- 1
SELECT COUNT(*) AS 총영화수 FROM film;

-- 2
SELECT COUNT(*) AS PG영화수
FROM film
WHERE rating = 'PG';

-- 3
SELECT COUNT(DISTINCT rating) AS 등급수 FROM film;
```

### 문제 2: SUM과 AVG

다음을 조회하세요:
1. 모든 영화의 대여료(rental_rate) 합계
2. 모든 영화의 평균 대여료 (소수점 둘째 자리)
3. 등급이 'R'인 영화의 평균 대여료

**예상 답:**
```sql
-- 1
SELECT SUM(rental_rate) AS 총대여료 FROM film;

-- 2
SELECT ROUND(AVG(rental_rate), 2) AS 평균대여료 FROM film;

-- 3
SELECT ROUND(AVG(rental_rate), 2) AS R등급평균대여료
FROM film
WHERE rating = 'R';
```

### 문제 3: MAX와 MIN

다음을 조회하세요:
1. 가장 비싼 대여료와 해당 영화 제목
2. 가장 긴 상영 시간(length)과 해당 영화 제목
3. 가장 짧은 상영 시간과 해당 영화 제목

**예상 답:**
```sql
-- 1
SELECT title, rental_rate
FROM film
WHERE rental_rate = (SELECT MAX(rental_rate) FROM film)
LIMIT 10;

-- 2
SELECT title, length
FROM film
WHERE length = (SELECT MAX(length) FROM film);

-- 3
SELECT title, length
FROM film
WHERE length = (SELECT MIN(length) FROM film)
LIMIT 10;
```

### 문제 4: 종합 통계

film 테이블의 다음 통계를 한 번에 조회하세요:
- 전체 영화 수
- 총 대여료 합계
- 평균 대여료
- 최고 대여료
- 최저 대여료
- 평균 상영 시간

**예상 답:**
```sql
SELECT
    COUNT(*) AS 총영화수,
    SUM(rental_rate) AS 총대여료,
    ROUND(AVG(rental_rate), 2) AS 평균대여료,
    MAX(rental_rate) AS 최고대여료,
    MIN(rental_rate) AS 최저대여료,
    ROUND(AVG(length), 0) AS 평균상영시간
FROM film;
```

### 문제 5: NULL 처리

다음을 조회하세요:
1. 전체 영화 수
2. original_language_id가 NULL이 아닌 영화 수
3. original_language_id가 NULL인 영화 수

**예상 답:**
```sql
SELECT
    COUNT(*) AS 전체영화,
    COUNT(original_language_id) AS 원본언어있음,
    COUNT(*) - COUNT(original_language_id) AS 원본언어NULL
FROM film;
```

---

## 강사 가이드

### 데이터베이스 활용 전략

1. **world DB (강의 설명 및 예제)**
   - country, city 테이블의 직관적인 데이터
   - 인구, 수명, 대륙 등 이해하기 쉬운 컬럼
   - 집계 함수 개념 설명에 적합

2. **sakila DB (실습 문제)**
   - film 테이블의 실무 데이터
   - 대여료, 상영시간 등 숫자 데이터
   - NULL 처리 연습 (original_language_id)

3. **수업 진행 흐름**
   ```
   1. world DB로 집계 함수 개념 설명 (인구 통계)
   2. NULL 처리 방식 강조 (LifeExpectancy)
   3. sakila DB로 실습 문제 풀이
   4. 다음 섹션(GROUP BY)과의 연결 예고
   ```

### 핵심 포인트

1. **COUNT(*)vs COUNT(컬럼)**: NULL 포함 여부 차이
2. **NULL 자동 제외**: SUM, AVG, MAX, MIN은 NULL 무시
3. **서브쿼리 활용**: MAX/MIN 값을 가진 행 찾기
4. **ROUND 활용**: AVG 결과를 보기 좋게 반올림
5. **다음 단계 예고**: "GROUP BY와 함께 사용하면 더 강력"

### 자주 하는 질문

**Q: COUNT(*)와 COUNT(1)의 차이는?**
A: 성능상 거의 차이 없습니다. `COUNT(*)`가 더 명확하고 표준적입니다.

**Q: COUNT(column)은 NULL을 세나요?**
A: 아니요, NULL은 제외하고 셉니다.

**Q: AVG 계산 시 NULL은 0으로 처리되나요?**
A: 아니요, NULL은 완전히 제외됩니다. 0으로 처리하려면 COALESCE 사용.

**Q: MAX/MIN은 문자열에도 사용할 수 있나요?**
A: 네, 알파벳 순서로 최댓값/최솟값을 찾습니다.

**Q: 여러 집계 함수를 한 번에 쓸 수 있나요?**
A: 네, SELECT 절에 여러 집계 함수를 동시에 사용 가능합니다.

### 실습 진행 팁

1. **개념부터**: COUNT(*) 하나만 먼저 익히기
2. **NULL 체험**: LifeExpectancy로 NULL 처리 직접 확인
3. **서브쿼리 연습**: MAX 값을 가진 행 찾기 패턴
4. **다음 단계 준비**: "카테고리별로 집계하려면?" → GROUP BY 예고
5. **실전 예제**: "대시보드에 표시할 통계" 같은 실무 시나리오

---

## 요약

- **집계 함수**: 여러 행을 하나의 값으로 요약
  - `COUNT(*)`: 모든 행 개수 (NULL 포함)
  - `COUNT(컬럼)`: NULL이 아닌 행만 개수
  - `COUNT(DISTINCT 컬럼)`: 중복 제거 개수
  - `SUM(컬럼)`: 합계
  - `AVG(컬럼)`: 평균
  - `MAX(컬럼)`, `MIN(컬럼)`: 최댓값, 최솟값

- **NULL 처리**:
  - COUNT(*) 제외한 모든 집계 함수는 NULL 무시
  - COALESCE로 NULL을 다른 값으로 대체 가능

- **활용 패턴**:
  - 전체 통계: `SELECT COUNT(*), SUM(...), AVG(...) FROM 테이블`
  - 조건부 통계: `WHERE 절과 함께 사용`
  - 최댓값/최솟값 행: `서브쿼리와 함께 사용`

**다음 단계**: GROUP BY와 HAVING을 배워 카테고리별 집계를 수행합니다!
