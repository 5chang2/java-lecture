# 3.7. GROUP BY와 HAVING

> GROUP BY로 데이터를 그룹화하고, HAVING으로 그룹을 필터링할 수 있다.

---

## 실습 준비

이 섹션에서는 **world 데이터베이스**를 사용합니다.

```sql
USE world;
```

---

## 1. GROUP BY란?

`GROUP BY`는 **같은 값을 가진 행끼리 그룹화**하여 집계합니다.

### 왜 GROUP BY가 필요한가?

```sql
-- ❌ 전체 국가 수만 나옴
SELECT COUNT(*) FROM country;

-- ✅ 대륙별 국가 수
SELECT Continent, COUNT(*) AS 국가수
FROM country
GROUP BY Continent;
```

**비유**: 데이터를 "카테고리별 바구니"에 담아 각 바구니별로 통계 계산

---

## 2. GROUP BY 기본 사용법

### 2.1. 단일 컬럼 그룹화

```sql
-- 대륙별 국가 개수
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent;
```

**결과**:
```
+---------------+-------+
|대륙           |국가수 |
+---------------+-------+
|Asia           |51     |
|Europe         |46     |
|North America  |37     |
|Africa         |58     |
|South America  |14     |
|Oceania        |28     |
|Antarctica     |5      |
+---------------+-------+
```

### 2.2. 정렬과 함께

```sql
-- 국가가 많은 대륙 순서로
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent
ORDER BY 국가수 DESC;
```

---

## 3. 여러 집계 함수 사용

### 3.1. 대륙별 인구 통계

```sql
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수,
    SUM(Population) AS 총인구,
    ROUND(AVG(Population), 0) AS 평균인구,
    MAX(Population) AS 최대인구,
    MIN(Population) AS 최소인구
FROM country
GROUP BY Continent
ORDER BY 총인구 DESC;
```

**결과 예시**:
```
+---------------+-------+-----------+-----------+-----------+-----------+
|대륙           |국가수 |총인구     |평균인구   |최대인구   |최소인구   |
+---------------+-------+-----------+-----------+-----------+-----------+
|Asia           |51     |3705025700 |72647562   |1277558000 |0          |
|Africa         |58     |784475000  |13525431   |111506000  |0          |
|Europe         |46     |730074600  |15871186   |146934000  |0          |
+---------------+-------+-----------+-----------+-----------+-----------+
```

### 3.2. 계산된 값 표시

```sql
-- 대륙별 인구 통계 (단위 변환)
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수,
    CONCAT(ROUND(SUM(Population) / 1000000, 0), '백만명') AS 총인구,
    ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country
WHERE LifeExpectancy IS NOT NULL
GROUP BY Continent
ORDER BY SUM(Population) DESC;
```

---

## 4. 다중 컬럼 그룹화

### 4.1. 여러 컬럼으로 그룹화

```sql
-- 대륙 + 지역별 국가 수
SELECT
    Continent AS 대륙,
    Region AS 지역,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent, Region
ORDER BY Continent, 국가수 DESC;
```

**결과 예시**:
```
+---------------+-------------------------+-------+
|대륙           |지역                     |국가수 |
+---------------+-------------------------+-------+
|Africa         |Eastern Africa           |20     |
|Africa         |Western Africa           |17     |
|Africa         |Northern Africa          |7      |
|Asia           |Southern and Central Asia|14     |
|Asia           |Southeast Asia           |11     |
+---------------+-------------------------+-------+
```

### 4.2. 실용 예제

```sql
-- 지역별 인구 통계 (국가 수 5개 이상)
SELECT
    Region AS 지역,
    COUNT(*) AS 국가수,
    ROUND(AVG(Population), 0) AS 평균인구,
    ROUND(AVG(LifeExpectancy), 1) AS 평균수명
FROM country
WHERE LifeExpectancy IS NOT NULL
GROUP BY Region
ORDER BY 평균수명 DESC
LIMIT 10;
```

---

## 5. HAVING: 그룹 필터링

`HAVING`은 **그룹화된 결과를 필터링**합니다.

### 5.1. WHERE vs HAVING

```sql
-- WHERE: 그룹화 전 필터링 (개별 행)
SELECT Continent, COUNT(*) AS 국가수
FROM country
WHERE Population >= 10000000  -- 인구 1천만 이상 국가만 먼저 필터링
GROUP BY Continent;

-- HAVING: 그룹화 후 필터링 (그룹)
SELECT Continent, COUNT(*) AS 국가수
FROM country
GROUP BY Continent
HAVING COUNT(*) >= 40;  -- 그룹화 후 국가 수가 40개 이상인 대륙만
```

**차이점**:
- **WHERE**: 개별 행 필터링 → 그룹화 전
- **HAVING**: 그룹 필터링 → 그룹화 후

### 5.2. HAVING 기본 예제

```sql
-- 국가가 40개 이상인 대륙만
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent
HAVING COUNT(*) >= 40
ORDER BY 국가수 DESC;
```

### 5.3. 집계 함수 조건

```sql
-- 총 인구가 5억 이상인 대륙
SELECT
    Continent AS 대륙,
    SUM(Population) AS 총인구,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent
HAVING SUM(Population) >= 500000000
ORDER BY 총인구 DESC;
```

### 5.4. WHERE + HAVING 조합

```sql
-- 인구 1천만 이상 국가만 집계 후, 국가 수 10개 이상인 대륙만 표시
SELECT
    Continent AS 대륙,
    COUNT(*) AS 대국개수,
    ROUND(AVG(Population), 0) AS 평균인구
FROM country
WHERE Population >= 10000000  -- WHERE: 개별 행 필터링
GROUP BY Continent
HAVING COUNT(*) >= 10  -- HAVING: 그룹 필터링
ORDER BY 평균인구 DESC;
```

**실행 순서**:
1. `FROM country`
2. `WHERE Population >= 10000000` (개별 행 필터링)
3. `GROUP BY Continent` (그룹화)
4. `HAVING COUNT(*) >= 10` (그룹 필터링)
5. `SELECT` (결과 생성)
6. `ORDER BY` (정렬)

---

## 6. GROUP BY 실전 패턴

### 6.1. Top N 그룹

```sql
-- 국가가 가장 많은 대륙 TOP 3
SELECT
    Continent AS 대륙,
    COUNT(*) AS 국가수
FROM country
GROUP BY Continent
ORDER BY 국가수 DESC
LIMIT 3;
```

### 6.2. 백분율 계산

```sql
-- 대륙별 인구 비율
SELECT
    Continent AS 대륙,
    SUM(Population) AS 대륙인구,
    ROUND(SUM(Population) / (SELECT SUM(Population) FROM country) * 100, 2) AS 비율
FROM country
GROUP BY Continent
ORDER BY 비율 DESC;
```

### 6.3. 비교 분석

```sql
-- 각 대륙에서 평균보다 인구가 많은 국가 수
SELECT
    co.Continent AS 대륙,
    COUNT(*) AS 평균이상국가수,
    ROUND(AVG(co.Population), 0) AS 평균인구
FROM country co
WHERE co.Population > (
    SELECT AVG(Population)
    FROM country
    WHERE Continent = co.Continent
)
GROUP BY co.Continent;
```

---

## 실습 문제

이제 **sakila 데이터베이스**로 실습해봅시다.

```sql
USE sakila;
```

### 문제 1: 기본 GROUP BY

등급(rating)별로 다음 정보를 조회하세요:
- 등급
- 영화 개수
- 영화 개수가 많은 순서로 정렬

**예상 답:**
```sql
SELECT
    rating AS 등급,
    COUNT(*) AS 영화수
FROM film
GROUP BY rating
ORDER BY 영화수 DESC;
```

### 문제 2: 여러 집계 함수

등급(rating)별로 다음 정보를 조회하세요:
- 등급
- 영화 개수
- 평균 대여료 (소수점 둘째 자리)
- 최고 대여료
- 최저 대여료
- 대여료 내림차순 정렬

**예상 답:**
```sql
SELECT
    rating AS 등급,
    COUNT(*) AS 영화수,
    ROUND(AVG(rental_rate), 2) AS 평균대여료,
    MAX(rental_rate) AS 최고대여료,
    MIN(rental_rate) AS 최저대여료
FROM film
GROUP BY rating
ORDER BY 평균대여료 DESC;
```

### 문제 3: HAVING 사용

등급별 통계에서 영화가 100개 이상인 등급만 조회하세요:
- 등급
- 영화 개수
- 평균 대여료

**예상 답:**
```sql
SELECT
    rating AS 등급,
    COUNT(*) AS 영화수,
    ROUND(AVG(rental_rate), 2) AS 평균대여료
FROM film
GROUP BY rating
HAVING COUNT(*) >= 100
ORDER BY 평균대여료 DESC;
```

### 문제 4: WHERE + GROUP BY + HAVING

대여료가 2.99 이상인 영화만 집계하여, 등급별 통계를 조회하세요.
단, 해당 등급의 영화가 50개 이상인 경우만 표시:
- 등급
- 영화 개수
- 평균 대여료

**예상 답:**
```sql
SELECT
    rating AS 등급,
    COUNT(*) AS 영화수,
    ROUND(AVG(rental_rate), 2) AS 평균대여료
FROM film
WHERE rental_rate >= 2.99
GROUP BY rating
HAVING COUNT(*) >= 50
ORDER BY 평균대여료 DESC;
```

### 문제 5: 다중 컬럼 그룹화

배우(actor) 테이블에서 성(last_name)별 배우 수를 조회하세요:
- 성
- 배우 수
- 배우가 2명 이상인 성만 표시
- 배우 수 내림차순 정렬

**예상 답:**
```sql
SELECT
    last_name AS 성,
    COUNT(*) AS 배우수
FROM actor
GROUP BY last_name
HAVING COUNT(*) >= 2
ORDER BY 배우수 DESC;
```


---

## 강사 가이드

### 데이터베이스 활용 전략

1. **world DB (강의 설명 및 예제)**
   - 대륙별, 지역별 그룹화가 직관적
   - 인구, 수명 통계로 GROUP BY 개념 명확히 설명
   - WHERE vs HAVING 차이 강조

2. **sakila DB (실습 문제)**
   - 등급별, 카테고리별 그룹화 연습
   - film 테이블로 단일 그룹화 연습
   - film + category JOIN으로 복합 그룹화 연습

3. **수업 진행 흐름**
   ```
   1. world DB로 GROUP BY 개념 설명 (대륙별 국가 수)
   2. 여러 집계 함수 조합 (대륙별 인구 통계)
   3. HAVING 개념 및 WHERE와의 차이
   4. sakila DB로 실습 문제 풀이
   ```

### 핵심 포인트

1. **GROUP BY = 카테고리별 바구니**: 같은 값끼리 묶음
2. **집계 함수 필수**: GROUP BY는 항상 집계 함수와 함께
3. **WHERE vs HAVING**:
   - WHERE: 그룹화 전 (개별 행 필터링)
   - HAVING: 그룹화 후 (그룹 필터링)
4. **실행 순서**: FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY
5. **다중 컬럼 그룹화**: 세부 카테고리별 통계

### 자주 하는 질문

**Q: GROUP BY에 SELECT한 컬럼이 없으면 오류가 나나요?**
A: MySQL은 허용하지만 권장하지 않습니다. PostgreSQL, Oracle은 오류 발생. GROUP BY에 SELECT한 모든 비집계 컬럼을 포함하는 것이 표준입니다.

**Q: HAVING과 WHERE는 언제 사용하나요?**
A: WHERE는 그룹화 전 개별 행 필터링, HAVING은 그룹화 후 그룹 필터링. 집계 함수 조건은 HAVING에서만 가능.

**Q: GROUP BY 컬럼을 SELECT에 안 쓰면 어떻게 되나요?**
A: MySQL은 동작하지만 의미 없는 결과. 표준 SQL에서는 오류. 항상 GROUP BY 컬럼을 SELECT에 포함 권장.

**Q: GROUP BY 순서가 결과에 영향을 주나요?**
A: `GROUP BY A, B`와 `GROUP BY B, A`는 같은 결과. 하지만 가독성을 위해 SELECT 순서와 맞추는 것이 좋습니다.

**Q: COUNT(*)와 COUNT(컬럼)을 HAVING에 쓰면 차이가 있나요?**
A: `HAVING COUNT(*) > 10`은 그룹 행 수, `HAVING COUNT(컬럼) > 10`은 NULL 제외한 행 수.

### 실습 진행 팁

1. **시각화**: 화이트보드에 대륙별로 나눠진 바구니 그림
2. **단계별 접근**:
   - 1단계: GROUP BY만 (대륙별 국가 수)
   - 2단계: 여러 집계 함수 (총인구, 평균인구 등)
   - 3단계: HAVING 추가 (조건 필터링)
3. **WHERE vs HAVING 비교**: 같은 데이터로 양쪽 결과 비교
4. **실수 체험**: GROUP BY 없이 집계 함수만 쓰면 오류 (일부 DBMS)
5. **실전 쿼리**: 대시보드, 보고서용 통계 쿼리 작성 연습

---

## 요약

### GROUP BY
- **목적**: 같은 값을 가진 행끼리 그룹화하여 집계
- **문법**: `GROUP BY 컬럼1, 컬럼2, ...`
- **필수**: 집계 함수와 함께 사용 (COUNT, SUM, AVG, MAX, MIN)
- **다중 그룹화**: 여러 컬럼으로 세부 카테고리 구분 가능

### HAVING
- **목적**: 그룹화된 결과를 필터링
- **문법**: `HAVING 조건`
- **WHERE와 차이**:
  - WHERE: 그룹화 전, 개별 행 필터링
  - HAVING: 그룹화 후, 그룹 필터링
- **집계 함수 조건**: HAVING에서만 사용 가능

### 실행 순서
```
FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY → LIMIT
```

### 활용 패턴
- **카테고리별 통계**: 대륙별, 등급별, 카테고리별 집계
- **Top N**: `ORDER BY + LIMIT`으로 상위 그룹만
- **비율 계산**: 서브쿼리로 전체 대비 비율
- **조건부 집계**: WHERE로 필터 후 GROUP BY

**다음 단계**: 3.8에서 CASE 조건문을 배웁니다!
