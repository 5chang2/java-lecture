# 3.5. 정렬과 제한 (ORDER BY, LIMIT)

> ORDER BY로 결과를 정렬하고, LIMIT로 결과 개수를 제한할 수 있다.

---

## 실습 준비

이 섹션에서는 **world 데이터베이스**를 사용합니다.

```sql
USE world;
```

---

## 1. ORDER BY: 결과 정렬하기

`ORDER BY` 절은 조회된 결과를 **특정 컬럼 기준으로 정렬**합니다.

### 1.1. 기본 구조

```sql
SELECT 컬럼명
FROM 테이블명
ORDER BY 정렬기준컬럼 [ASC|DESC];
```

- **ASC** (Ascending): 오름차순 (기본값, 생략 가능)
- **DESC** (Descending): 내림차순

---

## 2. 단일 컬럼 정렬

### 2.1. 오름차순 정렬 (ASC)

```sql
-- 인구가 적은 순서대로 정렬
SELECT Name, Population
FROM country
WHERE Population > 0
ORDER BY Population ASC
LIMIT 10;

-- ASC는 생략 가능
SELECT Name, Population
FROM country
WHERE Population > 0
ORDER BY Population
LIMIT 10;
```

**결과**:
```
+-------------------+------------+
| Name              | Population |
+-------------------+------------+
| Pitcairn          | 50         |
| Cocos Islands     | 600        |
| Vatican City      | 1000       |
| Tokelau           | 2000       |
| Niue              | 2000       |
+-------------------+------------+
```

### 2.2. 내림차순 정렬 (DESC)

```sql
-- 인구가 많은 순서대로 정렬
SELECT Name, Population
FROM country
ORDER BY Population DESC
LIMIT 10;
```

**결과**:
```
+--------------------+------------+
| Name               | Population |
+--------------------+------------+
| China              | 1277558000 |
| India              | 1013662000 |
| United States      | 278357000  |
| Indonesia          | 212107000  |
| Brazil             | 170115000  |
| Pakistan           | 156483000  |
| Russian Federation | 146934000  |
| Bangladesh         | 129155000  |
| Japan              | 126714000  |
| Nigeria            | 111506000  |
+--------------------+------------+
```

### 2.3. 문자열 정렬

```sql
-- 국가명 가나다순 정렬
SELECT Name, Continent
FROM country
ORDER BY Name ASC
LIMIT 10;
```

**결과**:
```
+-------------+---------------+
| Name        | Continent     |
+-------------+---------------+
| Afghanistan | Asia          |
| Albania     | Europe        |
| Algeria     | Africa        |
| ...         | ...           |
+-------------+---------------+
```

---

## 3. 다중 컬럼 정렬

여러 컬럼을 기준으로 순차적으로 정렬할 수 있습니다.

### 3.1. 2차 정렬

```sql
-- 1차: 대륙 순, 2차: 인구 많은 순
SELECT Name, Continent, Population
FROM country
ORDER BY Continent ASC, Population DESC
LIMIT 20;
```

**동작 방식**:
1. 먼저 `Continent`로 오름차순 정렬
2. 같은 대륙 내에서 `Population`으로 내림차순 정렬

**결과**:
```
+-------------+--------+------------+
| Name        |Continent| Population|
+-------------+--------+------------+
| Nigeria     |Africa  | 111506000  |
| Egypt       |Africa  | 68470000   |
| Ethiopia    |Africa  | 62565000   |
| ...         |...     | ...        |
| China       |Asia    | 1277558000 |
| India       |Asia    | 1013662000 |
| Indonesia   |Asia    | 212107000  |
+-------------+--------+------------+
```

### 3.2. 3차 정렬

```sql
-- 1차: 대륙, 2차: 지역, 3차: 인구
SELECT Name, Continent, Region, Population
FROM country
ORDER BY Continent ASC, Region ASC, Population DESC
LIMIT 20;
```

---

## 4. ORDER BY와 WHERE 함께 사용

`WHERE`로 필터링한 후 정렬할 수 있습니다.

```sql
-- 아시아 국가 중 인구가 많은 순서대로 조회
SELECT Name, Population
FROM country
WHERE Continent = 'Asia'
ORDER BY Population DESC
LIMIT 10;
```

**결과**:
```
+--------------------+------------+
| Name               | Population |
+--------------------+------------+
| China              | 1277558000 |
| India              | 1013662000 |
| Indonesia          | 212107000  |
| Pakistan           | 156483000  |
| Bangladesh         | 129155000  |
| Japan              | 126714000  |
| Philippines        | 75967000   |
| Vietnam            | 79832000   |
| Iran               | 67702000   |
| Turkey             | 66591000   |
+--------------------+------------+
```

**실행 순서**:
```
FROM → WHERE → SELECT → ORDER BY
```

---

## 5. LIMIT: 결과 개수 제한

`LIMIT`는 조회 결과의 **개수를 제한**합니다.

### 5.1. 기본 사용법

```sql
-- 인구 상위 5개 국가
SELECT Name, Population
FROM country
ORDER BY Population DESC
LIMIT 5;
```

**결과**:
```
+---------------+------------+
| Name          | Population |
+---------------+------------+
| China         | 1277558000 |
| India         | 1013662000 |
| United States | 278357000  |
| Indonesia     | 212107000  |
| Brazil        | 170115000  |
+---------------+------------+
```

**활용 사례**:
- 인기 상품 TOP 10
- 최신 게시글 5개
- 고득점자 상위 3명

### 5.2. LIMIT과 ORDER BY

`LIMIT`는 거의 항상 `ORDER BY`와 함께 사용합니다.

```sql
-- 평균 수명이 가장 긴 국가 TOP 10
SELECT Name, LifeExpectancy
FROM country
WHERE LifeExpectancy IS NOT NULL
ORDER BY LifeExpectancy DESC
LIMIT 10;
```

**주의**: `ORDER BY` 없이 `LIMIT`만 사용하면 **결과가 불확실**합니다.

```sql
-- ❌ 나쁜 예: 어떤 5개가 나올지 불명확
SELECT * FROM country LIMIT 5;

-- ✅ 좋은 예: 인구가 많은 5개
SELECT * FROM country ORDER BY Population DESC LIMIT 5;
```

---

## 6. OFFSET: 시작 위치 지정

`OFFSET`은 결과의 **시작 위치를 건너뛰고** 조회합니다. 주로 페이지네이션에 사용합니다.

### 6.1. 기본 구조

```sql
SELECT 컬럼명
FROM 테이블명
ORDER BY 정렬기준
LIMIT 개수 OFFSET 건너뛸개수;
```

### 6.2. 페이지네이션 예시

```sql
-- 1페이지: 인구 상위 10개 국가
SELECT Name, Population
FROM country
ORDER BY Population DESC
LIMIT 10 OFFSET 0;

-- 2페이지: 11~20위 국가
SELECT Name, Population
FROM country
ORDER BY Population DESC
LIMIT 10 OFFSET 10;

-- 3페이지: 21~30위 국가
SELECT Name, Population
FROM country
ORDER BY Population DESC
LIMIT 10 OFFSET 20;
```

**페이지 공식**:
```
페이지 크기 = N
페이지 번호 = P (1부터 시작)

LIMIT N OFFSET (P - 1) * N
```

### 6.3. 축약 문법

MySQL에서는 `LIMIT`에 2개의 값을 전달하여 간단히 표현할 수 있습니다.

```sql
-- LIMIT 개수 OFFSET 시작위치
SELECT * FROM country ORDER BY Population DESC LIMIT 10 OFFSET 10;

-- 축약 형태: LIMIT 시작위치, 개수
SELECT * FROM country ORDER BY Population DESC LIMIT 10, 10;
```

---

## 7. 도시 데이터 활용 (city 테이블)

### 예시 1: 인구 많은 도시 TOP 10

```sql
SELECT Name, CountryCode, Population
FROM city
ORDER BY Population DESC
LIMIT 10;
```

**결과**:
```
+----------------------+-------------+------------+
| Name                 | CountryCode | Population |
+----------------------+-------------+------------+
| Mumbai (Bombay)      | IND         | 10500000   |
| Seoul                | KOR         | 9981619    |
| São Paulo            | BRA         | 9968485    |
| Shanghai             | CHN         | 9696300    |
| Jakarta              | IDN         | 9604900    |
| Karachi              | PAK         | 9269265    |
| Istanbul             | TUR         | 8787958    |
| Ciudad de México     | MEX         | 8591309    |
| Moscow               | RUS         | 8389200    |
| New York             | USA         | 8008278    |
+----------------------+-------------+------------+
```

### 예시 2: 특정 국가의 도시 정렬

```sql
-- 대한민국 도시를 인구 순으로
SELECT Name, Population
FROM city
WHERE CountryCode = 'KOR'
ORDER BY Population DESC;
```

### 예시 3: 페이지네이션

```sql
-- 전체 도시 목록 (1페이지: 20개씩)
SELECT ID, Name, CountryCode, Population
FROM city
ORDER BY Population DESC
LIMIT 20 OFFSET 0;

-- 2페이지
SELECT ID, Name, CountryCode, Population
FROM city
ORDER BY Population DESC
LIMIT 20 OFFSET 20;
```

---

## 8. 실전 예시

### 예시 1: 대륙별 최대 인구 국가 (각 대륙 TOP 3)

```sql
-- 아시아 TOP 3
SELECT Name, Population
FROM country
WHERE Continent = 'Asia'
ORDER BY Population DESC
LIMIT 3;

-- 유럽 TOP 3
SELECT Name, Population
FROM country
WHERE Continent = 'Europe'
ORDER BY Population DESC
LIMIT 3;
```

### 예시 2: 평균 수명 순위

```sql
-- 평균 수명이 긴 국가 TOP 10
SELECT Name, LifeExpectancy
FROM country
WHERE LifeExpectancy IS NOT NULL
ORDER BY LifeExpectancy DESC
LIMIT 10;

-- 평균 수명이 짧은 국가 TOP 10
SELECT Name, LifeExpectancy
FROM country
WHERE LifeExpectancy IS NOT NULL
ORDER BY LifeExpectancy ASC
LIMIT 10;
```

### 예시 3: 다중 조건 정렬

```sql
-- 대륙별로 묶고, 각 대륙에서 평균 수명이 긴 순서
SELECT Continent, Name, LifeExpectancy
FROM country
WHERE LifeExpectancy IS NOT NULL
ORDER BY Continent ASC, LifeExpectancy DESC
LIMIT 30;
```

---

## 9. NULL 정렬

### 9.1. NULL 값의 정렬 위치

- **MySQL**: NULL이 가장 먼저 (오름차순 기준)

```sql
-- 독립 연도 정렬 (NULL이 먼저)
SELECT Name, IndepYear
FROM country
ORDER BY IndepYear ASC
LIMIT 10;
```

### 9.2. NULL 정렬 제어

```sql
-- NULL을 제외하고 정렬
SELECT Name, IndepYear
FROM country
WHERE IndepYear IS NOT NULL
ORDER BY IndepYear ASC
LIMIT 10;

-- NULL을 마지막에 배치 (MySQL)
SELECT Name, IndepYear
FROM country
ORDER BY IndepYear IS NULL, IndepYear ASC
LIMIT 10;
```

---

## 실습 문제

이제 **sakila 데이터베이스**로 실습해봅시다.

```sql
USE sakila;
```

### 문제 1: 기본 정렬

다음 요구사항에 맞는 SQL을 작성하세요.

1. 모든 영화를 대여료가 비싼 순서대로 조회 (상위 10개)
2. 영화 제목을 알파벳순으로 조회 (상위 10개)
3. 상영시간이 긴 순서대로 상위 10개 조회

**예상 답**:
```sql
-- 1
SELECT title, rental_rate
FROM film
ORDER BY rental_rate DESC
LIMIT 10;

-- 2
SELECT title
FROM film
ORDER BY title ASC
LIMIT 10;

-- 3
SELECT title, length
FROM film
ORDER BY length DESC
LIMIT 10;
```

### 문제 2: 다중 정렬

다음 요구사항에 맞는 SQL을 작성하세요.

"등급(rating)별로 그룹화하고, 같은 등급 내에서는 대여료가 비싼 순서대로 정렬" (상위 20개)

**예상 답**:
```sql
SELECT title, rating, rental_rate
FROM film
ORDER BY rating ASC, rental_rate DESC
LIMIT 20;
```

### 문제 3: 페이지네이션

한 페이지에 15개씩 보여주는 페이지네이션을 구현하세요.
영화 제목을 알파벳순으로 정렬하고, 2페이지를 조회하세요.

**예상 답**:
```sql
SELECT title, rental_rate, length
FROM film
ORDER BY title ASC
LIMIT 15 OFFSET 15;

-- 또는 축약형
SELECT title, rental_rate, length
FROM film
ORDER BY title ASC
LIMIT 15, 15;
```

### 문제 4: 복합 쿼리

다음 요구사항을 SQL로 작성하세요.

"등급이 'PG-13'인 영화 중에서 대여료가 3달러 이상인 영화를 대여료가 비싼 순서대로 상위 10개 조회"

**예상 답**:
```sql
SELECT title, rating, rental_rate, length
FROM film
WHERE rating = 'PG-13' AND rental_rate >= 3.0
ORDER BY rental_rate DESC
LIMIT 10;
```

### 문제 5: 배우 데이터

actor 테이블에서 다음을 조회하세요.

1. 배우를 성(last_name) 알파벳순으로 조회 (상위 20개)
2. 배우를 이름(first_name) 알파벳순으로 조회 (상위 20개)
3. 배우를 성 → 이름 순으로 정렬하여 조회 (상위 30개)

**예상 답**:
```sql
-- 1
SELECT first_name, last_name
FROM actor
ORDER BY last_name ASC
LIMIT 20;

-- 2
SELECT first_name, last_name
FROM actor
ORDER BY first_name ASC
LIMIT 20;

-- 3
SELECT first_name, last_name
FROM actor
ORDER BY last_name ASC, first_name ASC
LIMIT 30;
```

---

## 강사 가이드

### 핵심 포인트

1. **ORDER BY 위치**: SELECT 다음, LIMIT 이전
2. **LIMIT은 항상 ORDER BY와 함께**: 결과가 불확실하지 않도록
3. **다중 정렬 순서**: 첫 번째 컬럼 → 두 번째 컬럼 순서대로 적용
4. **페이지네이션**: `LIMIT N OFFSET (page-1)*N`
5. **성능**: OFFSET이 크면 성능 저하 (대안: 커서 기반 페이지네이션)

### 자주 하는 질문

**Q: ORDER BY 없이 LIMIT을 쓰면 어떻게 되나요?**
A: 결과가 불확실합니다. 데이터베이스가 내부적으로 저장된 순서대로 반환하지만, 이 순서는 보장되지 않습니다.

**Q: LIMIT 0은 무슨 의미인가요?**
A: 0개를 조회합니다. 주로 테이블 구조만 확인할 때 사용합니다.

**Q: OFFSET이 너무 크면 어떻게 되나요?**
A: 성능이 저하됩니다. 데이터베이스가 앞의 행들을 모두 건너뛰어야 하기 때문입니다.

### 데이터베이스 활용 전략

1. **world DB (강의 설명/예제)**
   - 단순하고 직관적인 데이터 (국가, 도시)
   - 개념 설명에 적합
   - 학생들이 쉽게 이해할 수 있는 도메인

2. **sakila DB (실습 문제)**
   - 실무에 가까운 DVD 렌탈 시스템
   - 영화, 배우 등 친숙한 데이터
   - 실전 감각을 기를 수 있음

3. **수업 진행 팁**
   - 먼저 world DB로 개념 설명 및 시연
   - 이해를 확인한 후 sakila DB로 실습 문제 풀이
   - 학생들이 두 DB를 번갈아 사용하며 연습하도록 유도

### 실습 진행 팁

1. **시각화**: ORDER BY 결과를 화면으로 보여주며 순서 확인
2. **페이지네이션 실습**: 1페이지, 2페이지, 3페이지를 순차적으로 조회
3. **데이터베이스 전환**: `USE world;` (강의) → `USE sakila;` (실습) 명확히 안내
4. **대용량 시뮬레이션**: OFFSET 1000 같은 큰 값으로 성능 차이 설명

---

## 요약

- **ORDER BY**: 결과를 정렬
  - `ASC`: 오름차순 (기본값)
  - `DESC`: 내림차순
- **다중 정렬**: `ORDER BY col1, col2` (순서대로 적용)
- **LIMIT**: 결과 개수 제한
  - `LIMIT N`: 상위 N개
- **OFFSET**: 시작 위치 지정
  - `LIMIT N OFFSET M`: M번째부터 N개
- **페이지네이션**: `LIMIT pageSize OFFSET (pageNum-1)*pageSize`
- **쿼리 실행 순서**: `FROM` → `WHERE` → `SELECT` → `ORDER BY` → `LIMIT`
- **NULL 정렬**: DBMS마다 다름, `IS NOT NULL`로 제외 가능

**다음 단계**: INSERT, UPDATE, DELETE로 데이터를 추가/수정/삭제하는 방법을 배웁니다!
