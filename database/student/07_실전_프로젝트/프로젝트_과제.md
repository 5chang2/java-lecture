# 7장. 실전 종합 프로젝트: 온라인 쇼핑몰 DB 구축

### 1. 프로젝트 목표

- **요구사항 분석 및 설계**: 주어진 "온라인 쇼핑몰" 시나리오의 요구사항을 분석하여 데이터베이스 스키마를 설계한다.
- **테이블 구현**: DDL을 사용하여 실제 테이블과 제약조건을 생성한다.
- **데이터 관리 및 분석**: DML, JOIN, 서브쿼리, 집계 함수, 윈도우 함수 등 배운 모든 SQL 문법을 종합적으로 활용하여 실무적인 데이터를 관리하고 분석하는 쿼리를 작성한다.
- **성능 최적화**: 인덱스 전략을 수립하고 `EXPLAIN`을 통해 쿼리 성능을 분석 및 개선한다.

---

### 2. 1단계: 환경 준비

- **과제**: 아래 SQL 스크립트를 실행하여 `eshop` 데이터베이스, 모든 테이블, 그리고 실습용 샘플 데이터를 준비하시오.

- **데이터베이스 생성**
  ```sql
  CREATE DATABASE eshop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
  USE eshop;
  ```

- **테이블 생성**
  ```sql
  -- Users, Addresses, Categories, Products, Carts, Orders, Order_Items, Payments, Reviews 테이블 생성 (이전 섹션의 DDL 구문 참고)
  CREATE TABLE Users (user_id INT AUTO_INCREMENT PRIMARY KEY, email VARCHAR(100) UNIQUE NOT NULL, password VARCHAR(255) NOT NULL, name VARCHAR(50) NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
  CREATE TABLE Categories (category_id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(50) UNIQUE NOT NULL);
  CREATE TABLE Products (product_id INT AUTO_INCREMENT PRIMARY KEY, category_id INT NOT NULL, name VARCHAR(100) NOT NULL, price DECIMAL(10,2) NOT NULL, stock INT DEFAULT 0, FOREIGN KEY (category_id) REFERENCES Categories(category_id));
  CREATE TABLE Orders (order_id INT AUTO_INCREMENT PRIMARY KEY, user_id INT NOT NULL, total_amount DECIMAL(10,2) NOT NULL, status ENUM('pending', 'paid', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending', ordered_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES Users(user_id));
  CREATE TABLE Order_Items (order_item_id INT AUTO_INCREMENT PRIMARY KEY, order_id INT NOT NULL, product_id INT NOT NULL, quantity INT NOT NULL, price DECIMAL(10,2) NOT NULL, FOREIGN KEY (order_id) REFERENCES Orders(order_id), FOREIGN KEY (product_id) REFERENCES Products(product_id));
  -- (나머지 테이블들도 위와 같이 생성)
  ```

- **샘플 데이터 삽입**
  ```sql
  -- Users, Categories, Products, Orders, Order_Items 등에 대한 INSERT 구문 실행 (이전 섹션의 INSERT 구문 참고)
  ```

---

### 3. 2단계: 실습 과제

- 아래 각 문제에 대한 SQL 쿼리를 직접 작성하여 결과를 도출하시오.

1.  **매출 분석**
    - 월별 총 매출액과 평균 주문 금액을 조회하시오.
    - 가장 매출이 높은 상위 3개 카테고리의 이름과 총 매출액을 조회하시오.

2.  **상품 분석**
    - 가장 많이 팔린 상품 상위 10개의 이름, 총 판매 수량, 총 매출액을 조회하시오.
    - 한 번도 판매되지 않은 상품의 목록을 조회하시오.

3.  **고객 분석**
    - 총 구매 금액을 기준으로 상위 5명의 VIP 고객 이름과 총 구매액을 조회하시오.
    - 최근 6개월 동안 구매 이력이 없는 휴면 고객의 목록을 조회하시오.

4.  **고급 분석 (Window Function 활용)**
    - 각 카테고리 내에서 가격이 비싼 순서대로 상품의 순위를 매겨, 카테고리명, 상품명, 가격, 순위를 조회하시오.
    - 월별 매출액과 함께, 해당 월까지의 누적 매출액을 조회하시오.

5.  **성능 최적화**
    - 특정 고객의 주문 목록을 조회하는 쿼리가 느리다고 가정하고, `EXPLAIN`으로 실행 계획을 분석하시오.
    - `Orders` 테이블의 `user_id` 컬럼에 인덱스를 생성하고, 다시 `EXPLAIN`을 실행하여 성능(예: `type`, `rows`)이 개선되었는지 확인하시오.

6.  **(선택) 저장 프로시저 작성**
    - 고객 ID(`user_id`)를 입력받아, 해당 고객의 총 주문 횟수와 총 결제 금액을 `OUT` 파라미터로 반환하는 저장 프로시저 `get_customer_summary`를 작성하시오.
