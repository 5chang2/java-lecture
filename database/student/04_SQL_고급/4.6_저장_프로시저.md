# 4.6. 저장 프로시저(Stored Procedure) 핵심 요약

### 1. 저장 프로시저 기본 개념

- **저장 프로시저 (Stored Procedure)**
  - 데이터베이스에 미리 저장해두고 재사용할 수 있는 **SQL 명령어들의 묶음(집합)**.
  - 여러 SQL 문을 하나의 프로그램처럼 묶어서, 필요할 때 `CALL` 문으로 호출하여 실행.

- **장점**
  - **재사용성**: 반복적인 작업을 하나의 프로시저로 만들어두고 계속 호출하여 사용.
  - **성능 향상**: 처음 실행될 때 컴파일되어 캐싱되므로, 반복 호출 시 파싱 및 최적화 과정이 생략되어 빠름.
  - **보안 강화**: 사용자에게 테이블에 대한 직접 접근 권한 대신, 프로시저에 대한 실행 권한만 부여하여 데이터 접근을 제어.
  - **네트워크 부하 감소**: 여러 개의 SQL 문을 서버에 보내는 대신, `CALL` 문 하나만 보내면 되므로 네트워크 트래픽이 줄어듦.

- **단점**
  - **낮은 이식성**: DBMS(MySQL, Oracle 등)마다 문법이 달라 다른 데이터베이스로 전환하기 어려움.
  - **어려운 디버깅**: 일반 프로그래밍 언어에 비해 디버깅이 복잡함.
  - **로직 분산**: 애플리케이션과 데이터베이스 양쪽에 비즈니스 로직이 나뉘어 관리가 복잡해질 수 있음.

---

### 2. 기본 문법

- **생성**
  ```sql
  -- 1. 구분자(Delimiter) 임시 변경
  DELIMITER $$

  -- 2. 프로시저 생성
  CREATE PROCEDURE 프로시저명( [매개변수 모드] 매개변수명 데이터타입, ... )
  BEGIN
      -- 실행할 SQL 문장들;
  END$$

  -- 3. 구분자 원상복구
  DELIMITER ;
  ```
  - **`DELIMITER`**: 프로시저 내부의 `;`와 SQL 문장의 끝을 구분하기 위해 임시로 문장 종료 기호를 변경하는 명령어.

- **실행**
  ```sql
  CALL 프로시저명(인자값, ...);
  ```

- **삭제**
  ```sql
  DROP PROCEDURE 프로시저명;
  ```

---

### 3. 매개변수(Parameter)

- **`IN` (입력)**: 프로시저에 값을 **전달**하는 용도. (기본값)
  ```sql
  CREATE PROCEDURE get_user(IN user_id INT) ...
  CALL get_user(123);
  ```

- **`OUT` (출력)**: 프로시저가 실행된 후, 결과를 **반환**받는 용도.
  ```sql
  CREATE PROCEDURE get_user_count(OUT total_users INT) ...
  CALL get_user_count(@count);
  SELECT @count; -- 결과를 사용자 변수 @count로 확인
  ```

- **`INOUT` (입출력)**: 값을 전달하고, 그 값을 변경하여 다시 반환받는 용도.

---

### 4. 프로시저 내부 문법

- **변수 선언**: `DECLARE 변수명 데이터타입 [DEFAULT 기본값];`
- **변수 할당**: `SET 변수명 = 값;`
- **조건문**: `IF ... THEN ... ELSEIF ... THEN ... ELSE ... END IF;`
- **반복문**: `WHILE`, `LOOP`, `REPEAT` 등.
- **커서(Cursor)**: 쿼리 결과를 한 행씩 순회하며 처리할 때 사용. (성능 저하를 유발할 수 있어 신중하게 사용)
