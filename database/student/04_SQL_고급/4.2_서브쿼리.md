# 4.2. 서브쿼리(Subquery) 핵심 요약

- **서브쿼리 (Subquery)**: 하나의 SQL 쿼리 문 안에 포함된 또 다른 `SELECT` 쿼리. 괄호 `()`로 감싸서 표현.
- **실행 순서**: 서브쿼리(안쪽 쿼리)가 먼저 실행되고, 그 결과가 메인 쿼리(바깥쪽 쿼리)의 조건이나 대상이 됨.

---

### 1. 서브쿼리의 종류 (사용 위치에 따라)

- **`WHERE` 절 서브쿼리**
  - **설명**: `WHERE` 절의 조건 값으로 다른 쿼리의 결과를 사용.
  - **종류**:
    - **단일 행 서브쿼리 (Single-Row)**: 서브쿼리가 하나의 값만 반환. `=`, `>`, `<` 등 일반 비교 연산자와 함께 사용.
      ```sql
      -- 예: 서울의 인구수와 같은 인구를 가진 도시 찾기
      WHERE population = (SELECT population FROM city WHERE name = 'Seoul');
      ```
    - **다중 행 서브쿼리 (Multi-Row)**: 서브쿼리가 여러 행을 반환. `IN`, `ANY`, `ALL`, `EXISTS` 등 다중 행 연산자와 함께 사용.
      ```sql
      -- 예: 아시아 대륙에 속한 국가들의 도시 찾기
      WHERE CountryCode IN (SELECT Code FROM country WHERE Continent = 'Asia');
      ```

- **`FROM` 절 서브쿼리 (인라인 뷰 - Inline View)**
  - **설명**: 서브쿼리의 결과가 마치 하나의 가상 테이블처럼 사용됨.
  - **규칙**: **반드시 별칭(Alias)을 지정해야 함.**
  - **주요 용도**: `GROUP BY`로 집계된 결과에 대해 추가적인 필터링이나 조인을 할 때 유용.
    ```sql
    SELECT ...
    FROM (
        SELECT Continent, COUNT(*) AS country_count FROM country GROUP BY Continent
    ) AS continent_summary; -- 반드시 별칭 지정
    ```

- **`SELECT` 절 서브쿼리 (스칼라 서브쿼리 - Scalar Subquery)**
  - **설명**: `SELECT` 목록에 포함되며, 반드시 하나의 값만 반환해야 함.
  - **특징**: 메인 쿼리의 각 행마다 서브쿼리가 실행될 수 있어 성능 저하의 원인이 될 수 있음 (상관 서브쿼리).
    ```sql
    -- 예: 각 국가의 도시 수 함께 조회
    SELECT 
        Name, 
        (SELECT COUNT(*) FROM city WHERE CountryCode = country.Code) AS city_count
    FROM country;
    ```

---

### 2. 주요 서브쿼리 연산자

- **`IN`**: 서브쿼리 결과 목록에 **포함되는** 경우 `TRUE`.
- **`NOT IN`**: 서브쿼리 결과 목록에 **포함되지 않는** 경우 `TRUE`.
- **`EXISTS`**: 서브쿼리 결과가 **하나라도 존재하면** `TRUE`. (실제 값을 비교하지 않고 존재 여부만 체크하여 성능상 이점이 있을 수 있음)
- **`ANY`**: 서브쿼리 결과 중 **어느 하나라도** 조건을 만족하면 `TRUE`. (예: `> ANY` → 최솟값보다 크면 `TRUE`)
- **`ALL`**: 서브쿼리 결과 **모두를** 조건을 만족하면 `TRUE`. (예: `> ALL` → 최댓값보다 크면 `TRUE`)

---

### 3. 상관 서브쿼리 (Correlated Subquery)

- **설명**: 서브쿼리가 메인 쿼리의 열을 참조하여, 메인 쿼리의 각 행에 대해 독립적으로 실행되는 서브쿼리.
- **예시**: `SELECT` 절 서브쿼리, `EXISTS` 등에서 주로 사용됨.
- **주의**: 메인 쿼리의 행 수만큼 서브쿼리가 반복 실행될 수 있어 성능에 영향을 줄 수 있으므로, `JOIN`으로 대체 가능한지 검토하는 것이 좋음.
