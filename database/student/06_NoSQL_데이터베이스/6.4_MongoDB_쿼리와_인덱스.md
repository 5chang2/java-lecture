# 6.4. MongoDB 쿼리와 인덱스 핵심 요약

### 1. 고급 쿼리 기법

- **배열 쿼리**
  - `{ hobbies: "coding" }`: 배열 필드에 특정 요소가 포함된 문서 검색.
  - `{ hobbies: { $all: ["A", "B"] } }`: 배열 필드에 여러 요소가 모두 포함된 문서 검색.
  - `{ hobbies: { $size: 3 } }`: 배열의 크기(요소 개수)가 정확히 3인 문서 검색.

- **중첩 문서 쿼리**
  - `{ "address.city": "Seoul" }`: 점 표기법(Dot Notation)을 사용하여 중첩된 문서의 필드를 조건으로 검색.

- **정규표현식**
  - `{ name: /^A/ }`: 정규표현식을 사용하여 복잡한 문자열 패턴 검색.

---

### 2. 집계 파이프라인 (Aggregation Pipeline)

- **개념**: 여러 단계(Stage)의 데이터 처리 과정을 파이프처럼 연결하여, 데이터를 필터링, 그룹화, 변환, 요약하는 강력한 기능. SQL의 `GROUP BY`와 유사하지만 훨씬 더 유연함.
- **구문**: `db.collection.aggregate([ { 파이프라인_단계_1 }, { 파이프라인_단계_2 }, ... ]);`

- **주요 파이프라인 단계**

| 단계 | 설명 | SQL 유사 기능 |
| :--- | :--- | :--- |
| **`$match`** | 조건에 맞는 문서를 필터링. | `WHERE` |
| **`$group`** | 지정된 키를 기준으로 문서를 그룹화하고, 그룹별로 집계. | `GROUP BY` |
| **`$sort`** | 결과를 정렬. | `ORDER BY` |
| **`$limit`** | 결과 문서의 수를 제한. | `LIMIT` |
| **`$project`** | 문서의 필드를 재구성(선택, 제외, 이름 변경 등). | `SELECT` 절 |

- **`$group` 내의 주요 집계 연산자**
  - `$sum`: 합계를 계산.
  - `$avg`: 평균을 계산.
  - `$max`: 최댓값을 찾음.
  - `$min`: 최솟값을 찾음.
  - `$push`: 그룹화된 문서의 특정 필드 값을 배열로 만듦.

---

### 3. 인덱스 (Index)

- **개념**: `find()` 쿼리의 성능을 향상시키기 위한 자료구조. 대용량 컬렉션에서 특정 문서를 빠르게 찾을 수 있도록 함.

- **인덱스 관리 명령어**
  - **생성**: `db.collection.createIndex({ 필드명: 1 또는 -1 })`
    - `1`: 오름차순, `-1`: 내림차순
    - 복합 인덱스: `db.collection.createIndex({ 필드1: 1, 필드2: -1 })`
  - **조회**: `db.collection.getIndexes()`
  - **삭제**: `db.collection.dropIndex("인덱스명")`

- **실행 계획 확인**
  - `db.collection.find({ ... }).explain("executionStats")`
  - 쿼리가 인덱스를 사용했는지(`IXSCAN`), 아니면 컬렉션 전체를 스캔했는지(`COLLSCAN`) 확인할 수 있음.
