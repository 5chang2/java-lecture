# 5.5. 락(Lock)과 동시성 제어 핵심 요약

### 1. 락(Lock) 기본 개념

- **락 (Lock)**
  - 여러 트랜잭션이 동시에 같은 데이터에 접근할 때, 데이터의 일관성과 무결성을 보장하기 위한 **동기화 메커니즘**.
  - 특정 데이터에 대해 하나의 트랜잭션이 독점적으로 접근하거나, 다른 트랜잭션의 수정을 막는 "자물쇠" 역할.

---

### 2. 락의 종류

- **공유 락 (Shared Lock, S Lock)**
  - **용도**: 데이터를 **읽을 때** 사용. (`SELECT ... FOR SHARE`)
  - **특징**: 여러 트랜잭션이 동시에 공유 락을 획득할 수 있음. 하지만 공유 락이 걸린 데이터는 다른 트랜잭션이 수정(쓰기)할 수 없음.
  - **비유**: 여러 사람이 동시에 책을 읽을 수는 있지만, 누군가 읽고 있는 동안에는 책 내용을 수정할 수 없음.

- **배타적 락 (Exclusive Lock, X Lock)**
  - **용도**: 데이터를 **변경(쓰기)**할 때 사용 (`INSERT`, `UPDATE`, `DELETE`, `SELECT ... FOR UPDATE`).
  - **특징**: 오직 하나의 트랜잭션만 락을 획득할 수 있음. 이 락이 걸리면 다른 어떤 트랜잭션도 해당 데이터를 읽거나 쓸 수 없음.
  - **비유**: 한 사람이 책을 수정하고 있을 때는, 다른 누구도 그 책을 읽거나 수정할 수 없음.

| | 공유 락(S) 요청 | 배타적 락(X) 요청 |
| :--- | :--- | :--- |
| **현재 공유 락(S) 상태** | **가능** | **대기** |
| **현재 배타적 락(X) 상태** | **대기** | **대기** |

---

### 3. 락의 범위 (Granularity)

- **행 수준 락 (Row-Level Lock)**
  - **개념**: 테이블의 특정 **행(Row)**에만 락을 거는 방식.
  - **특징**: 동시성이 높아 여러 사용자가 같은 테이블의 **다른 행**을 동시에 수정할 수 있음. **MySQL의 InnoDB 엔진이 기본적으로 사용.**

- **테이블 수준 락 (Table-Level Lock)**
  - **개념**: **테이블 전체**에 락을 거는 방식.
  - **특징**: 동시성이 낮아 하나의 트랜잭션이 테이블을 사용하는 동안 다른 트랜잭션은 대기해야 함.

---

### 4. 주요 락 관련 구문

- **`SELECT ... FOR SHARE`**
  - 데이터를 읽으면서 해당 행(들)에 **공유 락**을 설정.
  - 다른 트랜잭션이 해당 데이터를 읽는 것은 허용하지만, 수정하는 것은 막음.

- **`SELECT ... FOR UPDATE`**
  - 데이터를 읽으면서 해당 행(들)에 **배타적 락**을 설정.
  - 다른 트랜잭션이 해당 데이터를 읽거나 수정하는 것을 모두 막음.
  - **주요 용도**: 데이터의 현재 값을 확인하고, 그 값을 기반으로 수정하려는 경우. (예: 재고 확인 후 차감, 잔액 확인 후 출금)

---

### 5. 락 대기 및 타임아웃

- **락 대기**: 특정 트랜잭션이 요청한 데이터에 다른 트랜잭션이 이미 락을 걸어둔 경우, 락이 해제될 때까지 기다리는 상태.
- **타임아웃**: 락 대기 시간이 설정된 시간을 초과하면, 쿼리는 실패하고 오류를 반환. (`innodb_lock_wait_timeout` 변수로 설정, 기본값 50초)
