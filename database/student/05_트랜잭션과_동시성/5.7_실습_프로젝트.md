# 5.7. 실습: 트랜잭션 종합 프로젝트

### 1. 프로젝트 목표

- `트랜잭션`, `ACID`, `격리 수준`, `락(Lock)`, `데드락(Deadlock)` 등 5장에서 배운 개념을 종합적으로 활용한다.
- 동시성 문제가 발생하기 쉬운 실무 시나리오를 직접 구현하고 해결한다.
- 데이터의 일관성을 보장하는 안전한 데이터베이스 로직을 작성하는 능력을 기른다.

---

### 2. Mission 1: 안전한 티켓 예매 시스템

- **시나리오**: 여러 사용자가 동시에 같은 좌석을 예매하려고 할 때, 단 한 명의 사용자만 성공적으로 예매를 완료해야 합니다. (데이터 정합성 문제)

- **과제**: `book_seat` 저장 프로시저를 작성하여 아래 요구사항을 만족시키시오.
  1.  `START TRANSACTION`으로 트랜잭션을 시작한다.
  2.  예매하려는 좌석을 `SELECT ... FOR UPDATE` 구문을 사용하여 다른 트랜잭션이 접근하지 못하도록 **배타적 락(Exclusive Lock)**을 획득한다.
  3.  좌석의 상태(`status`)가 'available'일 경우에만 예매를 진행하고, 상태를 'reserved'로 변경 후 `COMMIT`한다.
  4.  좌석이 'available'이 아닐 경우, `ROLLBACK`하여 작업을 취소하고 "예매 실패" 메시지를 반환한다.
  5.  두 개의 클라이언트(세션)를 열어 동일한 좌석을 동시에 예매하여 한쪽만 성공하고 다른 쪽은 실패하는지 테스트한다.

---

### 3. Mission 2: 데드락(Deadlock)을 예방하는 계좌 이체 시스템

- **시나리오**: 두 사용자가 서로의 계좌에 동시에 돈을 이체할 때, 데드락이 발생하지 않도록 시스템을 구현해야 합니다.

- **과제**: `safe_transfer` 저장 프로시저를 작성하여 아래 요구사항을 만족시키시오.
  1.  `START TRANSACTION`으로 트랜잭션을 시작한다.
  2.  두 계좌(출금 계좌, 입금 계좌)에 `SELECT ... FOR UPDATE`로 락을 설정할 때, 항상 **계좌 ID가 작은 순서(알파벳 순)로 락을 획득**하도록 로직을 구현한다. (데드락 예방의 핵심)
  3.  두 계좌에 모두 락을 건 후, 출금 계좌의 잔액을 확인하고 이체를 진행한다.
  4.  잔액이 부족하면 `ROLLBACK`한다.
  5.  두 개의 클라이언트(세션)를 열어 서로 교차하여 이체(`A→B`, `B→A`)를 동시에 시도하고, 데드락 없이 순차적으로 처리되는지 테스트한다.

---

### 4. (참고) 실습용 테이블 생성 구문

- 아래 쿼리를 실행하여 실습에 필요한 테이블과 데이터를 준비하세요.

- **Mission 1용 테이블**
  ```sql
  CREATE TABLE shows (show_id INT PRIMARY KEY AUTO_INCREMENT, show_name VARCHAR(100), total_seats INT);
  CREATE TABLE seats (seat_id INT PRIMARY KEY AUTO_INCREMENT, show_id INT, seat_number VARCHAR(10), status ENUM('available', 'reserved', 'sold') DEFAULT 'available', FOREIGN KEY (show_id) REFERENCES shows(show_id));
  CREATE TABLE bookings (booking_id INT PRIMARY KEY AUTO_INCREMENT, seat_id INT, customer_name VARCHAR(100), booking_date DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (seat_id) REFERENCES seats(seat_id));
  INSERT INTO shows (show_name, total_seats) VALUES ('뮤지컬 오페라의 유령', 100);
  INSERT INTO seats (show_id, seat_number) SELECT 1, CONCAT('A', num) FROM (SELECT @row := @row + 1 AS num FROM (SELECT 0 UNION ALL SELECT 1) t1, (SELECT 0 UNION ALL SELECT 1) t2, (SELECT 0 UNION ALL SELECT 1) t3, (SELECT 0 UNION ALL SELECT 1) t4, (SELECT 0 UNION ALL SELECT 1) t5, (SELECT 0 UNION ALL SELECT 1) t6, (SELECT 0 UNION ALL SELECT 1) t7, (SELECT @row:=-1) t8) numbers WHERE num < 100;
  ```

- **Mission 2용 테이블**
  ```sql
  CREATE TABLE bank_accounts (account_id VARCHAR(20) PRIMARY KEY, balance DECIMAL(15, 2) NOT NULL CHECK (balance >= 0));
  INSERT INTO bank_accounts (account_id, balance) VALUES ('ACC001', 1000000), ('ACC002', 500000);
  ```
