# 8.3 AI 생성 쿼리 검증 및 수정

> **학습 목표**
> - AI가 생성한 쿼리의 문제점을 발견하는 방법을 배웁니다
> - 쿼리를 검증하는 단계별 절차를 익힙니다
> - 일반적인 AI 실수 패턴을 파악합니다

---

## 1. 왜 검증이 필요한가?

### 1.1 AI도 실수한다!

AI는 매우 똑똑하지만 **완벽하지 않습니다**.

#### 실제 사례: 틀린 테이블명

**요청**:
```
"고객 정보를 조회해줘"
```

**AI 응답**:
```sql
SELECT * FROM users;  -- ❌ 틀림!
```

**문제점**:
- sakila에는 `users` 테이블이 없음
- 올바른 테이블명은 `customer`

---

#### 실제 사례: 비효율적인 쿼리

**AI 응답**:
```sql
-- ❌ 비효율적
SELECT * FROM film;  -- 모든 컬럼 조회 (불필요)
```

**개선안**:
```sql
-- ✅ 효율적
SELECT film_id, title, rental_rate
FROM film;  -- 필요한 컬럼만 조회
```

---

#### 실제 사례: 논리 오류

**요청**:
```
"대여료가 2.99 이상이고 4.99 이하인 영화를 조회해줘"
```

**AI 응답 (잘못)**:
```sql
SELECT * FROM film
WHERE rental_rate >= 2.99 AND rental_rate <= 4.99;  -- ✅ 이건 맞음!
```

**AI 응답 (틀림)**:
```sql
-- 하지만 가끔 이렇게 잘못 생성:
SELECT * FROM film
WHERE rental_rate >= 2.99 OR rental_rate <= 4.99;  -- ❌ OR은 틀림!
```

---

## 2. 쿼리 검증 4단계

### 2.1 1단계: 문법 검증

**실행해보기**:
```sql
-- AI가 생성한 쿼리를 복사해서 실행
SELECT title, rental_rate
FROM film
WHERE rental_rate >= 4.99;
```

**문법 에러 확인**:
```
✅ 에러 없음: 쿼리가 정상 실행됨
❌ 에러 발생: 문법 오류 있음
```

#### 자주 발생하는 문법 에러

**1. 따옴표 오류**:
```sql
-- ❌ 잘못된 따옴표
SELECT * FROM film WHERE title = "Avatar";

-- ✅ 올바른 따옴표
SELECT * FROM film WHERE title = 'Avatar';
```

**2. 컬럼명 오타**:
```sql
-- ❌ 오타
SELECT titel FROM film;  -- titel → title

-- ✅ 올바름
SELECT title FROM film;
```

**3. GROUP BY 누락**:
```sql
-- ❌ GROUP BY 없음
SELECT rating, COUNT(*)
FROM film;

-- ✅ GROUP BY 추가
SELECT rating, COUNT(*)
FROM film
GROUP BY rating;
```

---

### 2.2 2단계: 결과 검증

쿼리가 실행되더라도 결과가 원하는 대로 나오는지 확인해야 합니다.

#### 예시: 결과 개수 확인

**요청**:
```
"대여료가 4.99 이상인 영화 개수를 세어줘"
```

**AI 쿼리**:
```sql
SELECT COUNT(*) as count
FROM film
WHERE rental_rate >= 4.99;
```

**검증 방법**:
```sql
-- 1. AI 쿼리 실행
SELECT COUNT(*) as count
FROM film
WHERE rental_rate >= 4.99;
-- 결과: 336

-- 2. 다른 방법으로 검증
SELECT rental_rate, COUNT(*) as count
FROM film
WHERE rental_rate >= 4.99
GROUP BY rental_rate;
-- 결과:
-- 4.99: 336개
-- 합계: 336개 (위와 일치! ✅)
```

---

#### 예시: 조건 검증

**요청**:
```
"2005년 6월에 대여된 기록을 조회해줘"
```

**AI 쿼리**:
```sql
SELECT *
FROM rental
WHERE rental_date >= '2005-06-01'
  AND rental_date <= '2005-06-30';
```

**문제점 발견**:
```sql
-- 6월 30일 23:59:59의 데이터는?
-- <= '2005-06-30'은 00:00:00까지만 포함!

-- ✅ 올바른 쿼리
SELECT *
FROM rental
WHERE rental_date >= '2005-06-01'
  AND rental_date < '2005-07-01';  -- 7월 1일 미만
```

---

### 2.3 3단계: 성능 검증

쿼리가 너무 느리면 개선이 필요합니다.

#### EXPLAIN 사용

```sql
-- AI가 생성한 쿼리
EXPLAIN SELECT *
FROM film
WHERE title = 'Avatar';
```

**결과 확인**:
- `type: ALL` → 전체 테이블 스캔 (느림 ⚠️)
- `type: ref` 또는 `eq_ref` → 인덱스 사용 (빠름 ✅)

---

### 2.4 4단계: 보안 검증

SQL Injection 위험이 있는지 확인합니다.

#### ❌ 위험한 패턴

**AI가 가끔 생성하는 위험한 쿼리**:
```sql
-- Python 코드에서 문자열 결합
query = "SELECT * FROM customer WHERE username = '" + user_input + "'"
```

**문제점**:
```
user_input = "admin' OR '1'='1"

실제 쿼리:
SELECT * FROM customer WHERE username = 'admin' OR '1'='1'
→ 모든 고객 정보 유출!
```

#### ✅ 안전한 패턴

```python
# 파라미터 바인딩 사용
query = "SELECT * FROM customer WHERE username = %s"
cursor.execute(query, (user_input,))
```

---

## 3. 일반적인 AI 실수 패턴

### 3.1 패턴 1: SELECT * 남용

**AI 쿼리**:
```sql
SELECT * FROM film;
```

**문제점**:
- 불필요한 컬럼까지 조회 (메모리 낭비)
- 네트워크 대역폭 낭비
- 쿼리 성능 저하

**개선안**:
```sql
SELECT film_id, title, rental_rate
FROM film;
```

---

### 3.2 패턴 2: 중복 데이터 미제거

**AI 쿼리**:
```sql
SELECT city
FROM address;
-- 결과: 중복된 도시명 포함
```

**개선안**:
```sql
SELECT DISTINCT city
FROM address;
-- 결과: 중복 제거된 도시명
```

---

### 3.3 패턴 3: 비효율적인 JOIN

**AI 쿼리**:
```sql
-- 서브쿼리 사용
SELECT *
FROM film
WHERE film_id IN (
    SELECT film_id FROM inventory
);
```

**개선안**:
```sql
-- JOIN 사용 (더 빠름)
SELECT DISTINCT f.*
FROM film f
JOIN inventory i ON f.film_id = i.film_id;
```

---

### 3.4 패턴 4: 불필요한 정렬

**AI 쿼리**:
```sql
SELECT customer_id, COUNT(*) as cnt
FROM rental
GROUP BY customer_id
ORDER BY customer_id;  -- 불필요!
```

**언제 불필요한가?**:
- 결과를 화면에 표시만 하고 순서가 중요하지 않을 때
- 정렬은 비용이 큰 연산

**개선안**:
```sql
-- 순서가 중요하지 않으면 ORDER BY 제거
SELECT customer_id, COUNT(*) as cnt
FROM rental
GROUP BY customer_id;
```

---

## 4. 실전 검증 예제

### 예제 1: 문법 오류 찾기

**AI가 생성한 쿼리**:
```sql
SELECT title COUNT(*)
FROM film
GROUP rental_rate;
```

**문제점 찾기**:
1. ❌ `COUNT(*)` 앞에 쉼표 없음
2. ❌ `GROUP BY` 키워드 오타 (`GROUP rental_rate`)

**수정안**:
```sql
SELECT title, COUNT(*)
FROM film
GROUP BY title, rental_rate;
```

---

### 예제 2: 논리 오류 찾기

**요청**:
```
"등급이 PG이고 대여료가 2.99인 영화를 조회해줘"
```

**AI 쿼리**:
```sql
SELECT * FROM film
WHERE rating = 'PG' OR rental_rate = 2.99;  -- ❌ OR은 틀림!
```

**문제점**:
- `OR`를 사용하면 "PG 등급" 또는 "2.99 대여료" 중 하나만 만족해도 조회됨
- 요청은 "둘 다" 만족해야 함

**수정안**:
```sql
SELECT * FROM film
WHERE rating = 'PG' AND rental_rate = 2.99;  -- ✅ AND 사용
```

---

### 예제 3: 성능 문제 찾기

**AI 쿼리**:
```sql
SELECT *
FROM rental
WHERE DATE(rental_date) = '2005-06-15';
```

**문제점**:
- `DATE()` 함수 사용으로 인덱스 미사용
- 전체 테이블 스캔 발생

**수정안**:
```sql
SELECT *
FROM rental
WHERE rental_date >= '2005-06-15 00:00:00'
  AND rental_date < '2005-06-16 00:00:00';
-- 인덱스 사용 가능!
```

---

## 5. AI에게 쿼리 개선 요청하기

### 5.1 에러 수정 요청

```
"이 쿼리에서 에러가 나는데 수정해줘:

SELECT title COUNT(*)
FROM film
GROUP rental_rate;"
```

**AI 응답**:
```sql
-- 수정된 쿼리
SELECT title, COUNT(*)
FROM film
GROUP BY title;
```

---

### 5.2 성능 개선 요청

```
"이 쿼리를 더 빠르게 만들어줘:

SELECT *
FROM film
WHERE title LIKE '%Avatar%';"
```

**AI 응답**:
```
"전체 텍스트 인덱스(Full-Text Index)를 사용하거나,
정확한 제목을 알고 있다면 = 연산자를 사용하는 것이 좋습니다:

SELECT film_id, title, rental_rate
FROM film
WHERE title = 'Avatar';

또는 필요한 컬럼만 선택하세요."
```

---

### 5.3 보안 개선 요청

```
"이 코드의 SQL Injection 위험을 제거해줘:

query = 'SELECT * FROM users WHERE id = ' + user_id"
```

**AI 응답**:
```python
# 파라미터 바인딩 사용
query = "SELECT * FROM users WHERE id = %s"
cursor.execute(query, (user_id,))
```

---

## 실습 문제

### 문제 1: 문법 오류 찾기

다음 AI가 생성한 쿼리에서 문법 오류를 찾고 수정하세요:

```sql
SELECT customer_id SUM(amount)
FROM payment
WHERE payment_date > '2005-01-01'
GROUP customer_id
HAVING SUM(amount) > 100
ORDER total_payment DESC;
```

<details>
<summary>답안 보기</summary>

**오류**:
1. `customer_id` 뒤에 쉼표 없음
2. `GROUP BY` 키워드 오타
3. `ORDER BY` 키워드 불완전

**수정안**:
```sql
SELECT customer_id, SUM(amount) as total_payment
FROM payment
WHERE payment_date > '2005-01-01'
GROUP BY customer_id
HAVING SUM(amount) > 100
ORDER BY total_payment DESC;
```

</details>

---

### 문제 2: 비효율적인 쿼리 개선

다음 쿼리를 더 효율적으로 개선하세요:

```sql
SELECT * FROM film;
```

<details>
<summary>답안 보기</summary>

**문제점**:
- 모든 컬럼 조회 (불필요)

**개선안**:
```sql
-- 필요한 컬럼만 선택
SELECT film_id, title, rental_rate, rating
FROM film;

-- 또는 조건 추가
SELECT film_id, title, rental_rate
FROM film
WHERE rental_rate >= 2.99
LIMIT 100;
```

</details>

---

## 정리

### 핵심 요약

1. **검증 4단계**
   - 문법 검증: 실행 가능한가?
   - 결과 검증: 원하는 결과인가?
   - 성능 검증: 충분히 빠른가?
   - 보안 검증: 안전한가?

2. **일반적인 AI 실수**
   - SELECT * 남용
   - 중복 데이터 미제거
   - 비효율적인 JOIN
   - 불필요한 정렬

3. **개선 방법**
   - AI에게 에러/성능/보안 개선 요청
   - 직접 수정 후 재검증

### 다음 단계

다음 섹션에서는 **복잡한 쿼리를 AI와 함께 단계적으로 작성하는 방법**을 배웁니다!

---

## 강사 가이드

### 강의 진행 팁

**1. 실제 에러 경험**
- 일부러 틀린 쿼리를 실행해보기
- 에러 메시지를 함께 읽고 해석하기

**2. 학생 참여**
- 학생들이 직접 AI 쿼리의 문제점 찾기
- 서로의 발견을 공유하고 토론

**3. 검증 습관화**
- 모든 AI 쿼리를 무조건 검증하는 습관 강조
- "믿지만 확인하라" 원칙

### 예상 질문과 답변

**Q: AI가 틀린 쿼리를 주면 어떻게 하나요?**
A: AI에게 에러 메시지를 보여주고 수정을 요청하거나, 직접 수정하세요.

**Q: 검증을 매번 다 해야 하나요?**
A: 처음에는 모든 단계를 거치는 것이 좋습니다. 익숙해지면 빠르게 검증 가능합니다.

---

**[이전: 8.2 AI에게 효과적으로 SQL 요청하기](./8.2_AI에게_효과적으로_SQL_요청하기.md)** | **[다음: 8.4 복잡한 쿼리를 AI와 함께 작성하기](./8.4_복잡한_쿼리를_AI와_함께_작성하기.md)**
