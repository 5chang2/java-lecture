# 2.3 Thymeleaf 템플릿 엔진

> **학습 목표**
> - Thymeleaf가 무엇이고 왜 사용하는지 이해합니다
> - Thymeleaf의 기본 문법을 활용할 수 있습니다
> - 변수 표현식, 조건문, 반복문을 작성할 수 있습니다
> - JSP와의 차이점을 구분할 수 있습니다

---

## 1. Thymeleaf란?

### 1.1 개념

**Thymeleaf**는 **서버 사이드 템플릿 엔진**입니다.

- HTML 파일에 특수한 속성을 추가하여 **동적 콘텐츠** 생성
- **Natural Templates**: HTML 구조를 유지하여 브라우저에서 바로 열어도 확인 가능
- Spring Boot가 **공식 지원**하는 템플릿 엔진

### 1.2 왜 Thymeleaf인가?

#### JSP의 문제점

```jsp
<%@ page contentType="text/html;charset=UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head><title>사용자 목록</title></head>
<body>
    <c:forEach items="${users}" var="user">
        <p>${user.name}</p>
    </c:forEach>
</body>
</html>
```

**문제점**:
- ❌ 서버 없이는 렌더링 불가 (디자이너가 확인 어려움)
- ❌ JAR 패키징 시 문제
- ❌ Spring Boot 비권장

#### Thymeleaf의 장점

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>사용자 목록</title></head>
<body>
    <div th:each="user : ${users}">
        <p th:text="${user.name}">홍길동</p>
    </div>
</body>
</html>
```

**장점**:
- ✅ HTML 구조 유지 (Natural Templates)
- ✅ 브라우저에서 바로 열어도 확인 가능
- ✅ Spring Boot 기본 템플릿 엔진
- ✅ JAR 패키징 문제 없음

---

## 2. Thymeleaf 설정

### 2.1 의존성 추가

**build.gradle**:
```groovy
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
}
```

Spring Initializr에서 "Thymeleaf" 선택 시 자동 추가됩니다.

### 2.2 파일 위치

```
src/main/resources/
└── templates/
    ├── index.html
    ├── user/
    │   ├── list.html
    │   └── detail.html
    └── product/
        └── list.html
```

**규칙**:
- `src/main/resources/templates/` 아래에 위치
- `.html` 확장자
- Controller에서 반환하는 View 이름과 매칭

### 2.3 기본 설정 (application.properties)

```properties
# Thymeleaf 설정 (기본값, 생략 가능)
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html
spring.thymeleaf.cache=false  # 개발 시: false, 운영 시: true
```

**개발 시 캐시 비활성화**:
- HTML 수정 후 즉시 반영
- 운영 환경에서는 `true`로 변경 (성능 향상)

---

## 3. Thymeleaf 기본 문법

### 3.1 네임스페이스 선언

모든 Thymeleaf HTML 파일은 다음으로 시작합니다:

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>제목</title>
</head>
<body>
    <!-- 여기에 Thymeleaf 문법 사용 -->
</body>
</html>
```

`xmlns:th`: Thymeleaf 네임스페이스 선언

### 3.2 변수 표현식 `${...}`

**Model의 데이터를 출력**합니다.

**Controller**:
```java
@GetMapping("/greeting")
public String greeting(Model model) {
    model.addAttribute("name", "홍길동");
    model.addAttribute("age", 25);
    return "greeting";
}
```

**View (greeting.html)**:
```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>인사</title></head>
<body>
    <h1 th:text="${name}">이름</h1>
    <p>나이: <span th:text="${age}">0</span>세</p>
</body>
</html>
```

**결과 (렌더링 후)**:
```html
<body>
    <h1>홍길동</h1>
    <p>나이: <span>25</span>세</p>
</body>
```

### 3.3 th:text vs 태그 내용

```html
<!-- th:text 사용 (권장) -->
<p th:text="${message}">기본 메시지</p>

<!-- 태그 내용으로 직접 사용 (비권장) -->
<p>[[${message}]]</p>
```

**th:text 사용 시 장점**:
- HTML로 바로 열어도 "기본 메시지" 표시
- 디자이너가 확인 가능

### 3.4 객체 속성 접근

**Controller**:
```java
@GetMapping("/user")
public String user(Model model) {
    User user = new User("홍길동", 25);
    model.addAttribute("user", user);
    return "user-detail";
}
```

**View**:
```html
<h1 th:text="${user.name}">사용자명</h1>
<p th:text="${user.age}">나이</p>

<!-- Getter 메서드 호출 -->
<p th:text="${user.getName()}">사용자명</p>
<p th:text="${user.getAge()}">나이</p>
```

**주의**: Getter 메서드 필요!

### 3.5 HTML 이스케이프

**th:text**: HTML 태그를 **이스케이프** (안전)
```html
<!-- Controller: model.addAttribute("html", "<b>굵게</b>"); -->
<p th:text="${html}"></p>
<!-- 결과: &lt;b&gt;굵게&lt;/b&gt; -->
```

**th:utext**: HTML 태그를 **그대로 렌더링** (위험)
```html
<p th:utext="${html}"></p>
<!-- 결과: <b>굵게</b> -->
```

**보안**: 사용자 입력은 반드시 `th:text` 사용!

---

## 4. 조건문

### 4.1 th:if

**조건이 참일 때만 렌더링**:

```html
<!-- age가 18 이상일 때만 표시 -->
<p th:if="${age >= 18}">성인입니다.</p>

<!-- age가 18 미만일 때만 표시 -->
<p th:if="${age < 18}">미성년자입니다.</p>
```

**null 체크**:
```html
<!-- user가 null이 아닐 때 -->
<div th:if="${user != null}">
    <h1 th:text="${user.name}">사용자명</h1>
</div>

<!-- user가 null일 때 -->
<div th:if="${user == null}">
    <p>사용자를 찾을 수 없습니다.</p>
</div>
```

### 4.2 th:unless

**조건이 거짓일 때만 렌더링** (th:if의 반대):

```html
<p th:unless="${age >= 18}">미성년자입니다.</p>
<!-- age < 18일 때 표시 -->
```

### 4.3 th:if-else (th:switch)

**여러 조건 분기**:

```html
<div th:switch="${user.role}">
    <p th:case="'ADMIN'">관리자</p>
    <p th:case="'USER'">일반 사용자</p>
    <p th:case="*">기타</p>
</div>
```

---

## 5. 반복문

### 5.1 th:each

**리스트를 반복**하여 렌더링:

**Controller**:
```java
@GetMapping("/users")
public String users(Model model) {
    List<User> users = Arrays.asList(
        new User("홍길동", 25),
        new User("김철수", 30),
        new User("이영희", 28)
    );
    model.addAttribute("users", users);
    return "user-list";
}
```

**View**:
```html
<table>
    <tr th:each="user : ${users}">
        <td th:text="${user.name}">이름</td>
        <td th:text="${user.age}">나이</td>
    </tr>
</table>
```

**결과**:
```html
<table>
    <tr>
        <td>홍길동</td>
        <td>25</td>
    </tr>
    <tr>
        <td>김철수</td>
        <td>30</td>
    </tr>
    <tr>
        <td>이영희</td>
        <td>28</td>
    </tr>
</table>
```

### 5.2 반복 상태 변수

**인덱스, 카운트 등 추가 정보** 사용:

```html
<tr th:each="user, stat : ${users}">
    <td th:text="${stat.index}">0</td>      <!-- 0부터 시작 -->
    <td th:text="${stat.count}">1</td>      <!-- 1부터 시작 -->
    <td th:text="${user.name}">이름</td>
    <td>
        <span th:if="${stat.first}">첫 번째</span>
        <span th:if="${stat.last}">마지막</span>
    </td>
</tr>
```

**상태 변수 속성**:
- `index`: 0부터 시작하는 인덱스
- `count`: 1부터 시작하는 카운트
- `size`: 전체 크기
- `first`: 첫 번째 요소인지 (boolean)
- `last`: 마지막 요소인지 (boolean)
- `even`: 짝수 번째인지
- `odd`: 홀수 번째인지

---

## 6. URL 링크

### 6.1 th:href

**Controller**:
```java
@GetMapping("/products/{id}")
public String product(@PathVariable Long id) {
    return "product-detail";
}
```

**View**:
```html
<!-- 일반 링크 -->
<a th:href="@{/products}">상품 목록</a>

<!-- PathVariable 포함 -->
<a th:href="@{/products/{id}(id=1)}">상품 1</a>
<a th:href="@{/products/{id}(id=${product.id})}">상품 상세</a>

<!-- 쿼리 스트링 -->
<a th:href="@{/products(page=1, size=10)}">상품 목록 (페이징)</a>
<!-- 결과: /products?page=1&size=10 -->

<!-- 조합 -->
<a th:href="@{/products/{id}(id=${product.id}, page=1)}">상품 상세 (페이징)</a>
<!-- 결과: /products/1?page=1 -->
```

### 6.2 th:src (이미지, 스크립트)

```html
<!-- 이미지 -->
<img th:src="@{/images/logo.png}" alt="로고" />

<!-- CSS -->
<link rel="stylesheet" th:href="@{/css/style.css}" />

<!-- JavaScript -->
<script th:src="@{/js/script.js}"></script>
```

**정적 파일 위치**:
```
src/main/resources/static/
├── images/
│   └── logo.png
├── css/
│   └── style.css
└── js/
    └── script.js
```

---

## 7. 폼 처리

### 7.1 th:action, th:method

```html
<form th:action="@{/users}" th:method="post">
    <input type="text" name="username" placeholder="사용자명" />
    <input type="email" name="email" placeholder="이메일" />
    <button type="submit">등록</button>
</form>
```

### 7.2 th:object, th:field (객체 바인딩)

**Controller**:
```java
@GetMapping("/users/new")
public String newUserForm(Model model) {
    model.addAttribute("user", new User());
    return "user-form";
}

@PostMapping("/users")
public String createUser(@ModelAttribute User user) {
    // user 객체에 폼 데이터 자동 바인딩
    return "redirect:/users";
}
```

**View**:
```html
<form th:action="@{/users}" th:object="${user}" method="post">
    <input type="text" th:field="*{name}" placeholder="이름" />
    <input type="number" th:field="*{age}" placeholder="나이" />
    <button type="submit">등록</button>
</form>
```

**th:field의 장점**:
- `name`, `id`, `value` 속성 자동 생성
- 유효성 검증 에러 표시 용이

**결과 (렌더링 후)**:
```html
<input type="text" id="name" name="name" value="" />
<input type="number" id="age" name="age" value="" />
```

---

## 8. 기타 유용한 기능

### 8.1 인라인 표현식

**[[...]]**: 텍스트 인라인
```html
<p>안녕하세요, [[${name}]]님!</p>
<!-- 결과: 안녕하세요, 홍길동님! -->
```

**[(...)]]**: utext 인라인 (HTML 렌더링)
```html
<p>내용: [(${content})]</p>
```

### 8.2 연산자

**비교 연산**:
```html
<p th:if="${age > 18}">성인</p>
<p th:if="${age == 18}">18세</p>
<p th:if="${age != 18}">18세 아님</p>
```

**논리 연산**:
```html
<p th:if="${age >= 18 and age < 65}">근로 가능 연령</p>
<p th:if="${role == 'ADMIN' or role == 'MANAGER'}">관리자</p>
<p th:if="${!isBlocked}">활성 사용자</p>
```

**삼항 연산자**:
```html
<p th:text="${age >= 18} ? '성인' : '미성년자'">-</p>
```

**Elvis 연산자** (null 체크):
```html
<p th:text="${user.name} ?: '이름 없음'">이름</p>
<!-- user.name이 null이면 "이름 없음" 출력 -->
```

### 8.3 유틸리티 객체

**날짜 포맷**:
```html
<p th:text="${#temporals.format(today, 'yyyy-MM-dd')}">날짜</p>
```

**문자열 조작**:
```html
<p th:text="${#strings.toUpperCase(name)}">이름</p>
<p th:text="${#strings.substring(name, 0, 3)}">이름 (3글자)</p>
```

**리스트 유틸**:
```html
<p th:if="${#lists.isEmpty(users)}">사용자 없음</p>
<p>사용자 수: <span th:text="${#lists.size(users)}">0</span></p>
```

---

## 9. JSP vs Thymeleaf 비교

### 9.1 변수 출력

| JSP | Thymeleaf |
|-----|-----------|
| `${user.name}` | `th:text="${user.name}"` |
| `<c:out value="${user.name}"/>` | `th:text="${user.name}"` |

### 9.2 조건문

**JSP**:
```jsp
<c:if test="${age >= 18}">
    <p>성인</p>
</c:if>
```

**Thymeleaf**:
```html
<p th:if="${age >= 18}">성인</p>
```

### 9.3 반복문

**JSP**:
```jsp
<c:forEach items="${users}" var="user">
    <p>${user.name}</p>
</c:forEach>
```

**Thymeleaf**:
```html
<p th:each="user : ${users}" th:text="${user.name}">이름</p>
```

### 9.4 링크

**JSP**:
```jsp
<a href="${pageContext.request.contextPath}/products/${product.id}">상품</a>
```

**Thymeleaf**:
```html
<a th:href="@{/products/{id}(id=${product.id})}">상품</a>
```

---

## 실습 문제

### 문제: 성적표 출력

**Controller**:
```java
@GetMapping("/grades")
public String grades(Model model) {
    List<Student> students = Arrays.asList(
        new Student("홍길동", 85, 90, 88),
        new Student("김철수", 70, 75, 80),
        new Student("이영희", 95, 92, 94)
    );
    model.addAttribute("students", students);
    return "grades";
}
```

**Student 클래스**:
```java
public class Student {
    private String name;
    private int korean;
    private int english;
    private int math;

    public int getAverage() {
        return (korean + english + math) / 3;
    }

    public String getGrade() {
        int avg = getAverage();
        if (avg >= 90) return "A";
        if (avg >= 80) return "B";
        if (avg >= 70) return "C";
        return "D";
    }
}
```

**요구사항**:
1. 테이블 형식으로 출력
2. 평균이 90 이상이면 빨간색, 80 이상이면 파란색으로 표시
3. 각 학생의 등급(A, B, C, D) 출력

<details>
<summary>답안 보기</summary>

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>성적표</title>
    <style>
        .high { color: red; }
        .mid { color: blue; }
    </style>
</head>
<body>
    <h1>성적표</h1>
    <table border="1">
        <tr>
            <th>이름</th>
            <th>국어</th>
            <th>영어</th>
            <th>수학</th>
            <th>평균</th>
            <th>등급</th>
        </tr>
        <tr th:each="student : ${students}">
            <td th:text="${student.name}">이름</td>
            <td th:text="${student.korean}">0</td>
            <td th:text="${student.english}">0</td>
            <td th:text="${student.math}">0</td>
            <td th:text="${student.average}"
                th:class="${student.average >= 90} ? 'high' : (${student.average >= 80} ? 'mid' : '')">
                0
            </td>
            <td th:text="${student.grade}">-</td>
        </tr>
    </table>
</body>
</html>
```

</details>

---

## 정리

### 핵심 요약

1. **Thymeleaf**: Spring Boot 공식 템플릿 엔진
2. **Natural Templates**: HTML 구조 유지
3. **기본 문법**:
   - `th:text="${...}"`: 변수 출력
   - `th:if`, `th:unless`: 조건문
   - `th:each`: 반복문
   - `th:href="@{...}"`: URL 링크
4. **JSP 대비 장점**:
   - HTML 유지
   - JAR 패키징 문제 없음
   - Spring Boot 권장

### 다음 단계

다음 섹션에서는 지금까지 배운 내용을 종합하여 간단한 웹 페이지를 만들어봅니다!

---

## 강사 가이드

### 강의 진행 팁

**1. 비교 학습**
- JSP 예제를 먼저 보여주고 Thymeleaf로 변환
- HTML로 바로 열어서 "Natural Templates" 체험

**2. 브라우저 소스 보기**
- 렌더링 전/후 비교
- `th:*` 속성이 어떻게 변환되는지 확인

**3. 실시간 코딩**
- 학생들과 함께 HTML 작성
- 서버 실행하여 즉시 확인

### 예상 질문과 답변

**Q: th:text와 [[${...}]] 중 뭘 써야 하나요?**
A: `th:text`를 권장합니다. HTML로 바로 열어도 기본값이 보이기 때문입니다.

**Q: Thymeleaf 말고 Freemarker나 Mustache는요?**
A: 모두 좋은 템플릿 엔진이지만, Spring Boot는 Thymeleaf를 권장하고 가장 많이 사용됩니다.

**Q: React나 Vue를 쓸 거면 Thymeleaf는 필요 없나요?**
A: 맞습니다. 프론트엔드 프레임워크를 사용하면 Backend는 REST API만 제공하면 됩니다. (챕터 3에서 배움)

---

**[이전: 2.2 Controller와 요청 처리](./2.2_Controller와_요청_처리.md)** | **[다음: 2.4 간단한 웹 페이지 만들기](./2.4_간단한_웹_페이지_만들기.md)**
