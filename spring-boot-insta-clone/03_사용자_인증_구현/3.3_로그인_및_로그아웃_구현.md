# 3.3. 로그인 및 로그아웃 구현

회원가입 기능이 완성되었으니, 이제 사용자가 시스템에 자신을 인증하는 로그인(Login)과 세션을 종료하는 로그아웃(Logout) 기능을 구현합니다. Spring Security는 대부분의 로직을 자동으로 처리해주므로, 우리는 주로 설정과 UI만 구성하면 됩니다.

---

## 1. UserDetailsService 구현

Spring Security가 사용자를 인증하려면, 입력된 사용자 이름(username)으로 실제 데이터베이스에서 사용자 정보를 가져오는 과정이 필요합니다. `UserDetailsService` 인터페이스를 구현하여 이 로직을 제공해야 합니다.

`com.example.instaclone.service` 패키지에 `CustomUserDetailsService.java` 클래스를 생성합니다.

```java
package com.example.instaclone.service;

import com.example.instaclone.domain.User;
import com.example.instaclone.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException(username + " 사용자를 찾을 수 없습니다."));

        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getUsername())
                .password(user.getPassword()) // DB에 저장된 암호화된 비밀번호
                .roles("USER") // 역할(Role) 설정
                .build();
    }
}
```

- `UserDetailsService`의 `loadUserByUsername` 메서드를 오버라이드합니다.
- `userRepository`를 통해 DB에서 사용자를 조회합니다.
- 조회된 `User` 엔티티 정보를 Spring Security가 사용하는 `UserDetails` 객체로 변환하여 반환합니다. Spring Security는 이 객체의 비밀번호와 사용자가 입력한 비밀번호를 `PasswordEncoder`를 통해 비교하여 인증을 수행합니다.

---

## 2. 로그인 기능 구현

#### 1) `login-form.html` 생성

`templates/users/` 경로에 `login-form.html` 파일을 생성합니다.

```html
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h1 class="my-4 text-center">로그인</h1>
            <div th:if="${param.error}" class="alert alert-danger">사용자 이름 또는 비밀번호가 올바르지 않습니다.</div>
            <form action="/login" method="post">
                <div class="mb-3">
                    <label for="username" class="form-label">사용자 이름</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">비밀번호</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">로그인</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
```

- `action="/login"`, `name="username"`, `name="password"`는 Spring Security가 기본적으로 사용하는 설정값이므로 그대로 사용해야 합니다.
- `th:if="${param.error}"`: 만약 로그인에 실패하면 Spring Security는 URL 파라미터로 `?error`를 붙여주는데, 이를 감지하여 에러 메시지를 표시합니다.

#### 2) `SecurityConfig` 수정

로그인 페이지와 로그아웃 기능을 사용하도록 `SecurityConfig.java`를 수정합니다.

```java
// SecurityConfig.java

// ... imports ...

@Configuration
@EnableWebSecurity
public class SecurityConfig {
    // ... passwordEncoder() Bean ...

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/", "/posts/**", "/images/**", "/css/**", "/js/**").permitAll()
                .requestMatchers("/signup").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login") // 커스텀 로그인 페이지 경로
                .defaultSuccessUrl("/", true) // 로그인 성공 시 이동할 경로
                .permitAll() // 로그인 페이지는 누구나 접근 가능해야 함
            )
            .logout(logout -> logout
                .logoutUrl("/logout") // 로그아웃을 처리할 URL
                .logoutSuccessUrl("/") // 로그아웃 성공 시 이동할 경로
            );

        return http.build();
    }
}
```

- **`.formLogin()`**: 폼 기반 로그인을 설정합니다.
  - `loginPage("/login")`: 우리가 만든 커스텀 로그인 페이지의 경로를 지정합니다. 이 설정을 추가하면 `UserController`에 `/login` GET 매핑을 추가해야 합니다.
- **`.logout()`**: 로그아웃 기능을 설정합니다.

#### 3) `UserController`에 로그인 폼 보여주는 메서드 추가

```java
// UserController.java

@GetMapping("/login")
public String loginForm() {
    return "users/login-form";
}
```

---

## 3. 로그인 상태에 따른 UI 변경

로그인 상태에 따라 내비게이션 바의 메뉴가 다르게 보이도록 `navbar.html`을 수정합니다. 이를 위해 `thymeleaf-extras-springsecurity6` 의존성이 필요합니다.

**`build.gradle`에 의존성 추가**
```gradle
dependencies {
    // ...
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
}
```

**`navbar.html` 수정**
```html
<nav class="navbar navbar-expand-lg navbar-light bg-light" 
     xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Insta Clone</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <!-- 인증되지 않은 사용자에게 보임 -->
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" href="/login">로그인</a>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" href="/signup">회원가입</a>
                </li>
                <!-- 인증된 사용자에게 보임 -->
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <a class="nav-link" href="/posts/new">새 게시물</a>
                </li>
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <form action="/logout" method="post">
                        <button type="submit" class="btn nav-link">로그아웃</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>
```

- `xmlns:sec`: Spring Security용 Thymeleaf 확장 기능을 사용하기 위한 네임스페이스입니다.
- `sec:authorize="isAuthenticated()"`: 현재 사용자가 인증(로그인)된 상태일 때만 해당 태그를 렌더링합니다.
- `sec:authorize="!isAuthenticated()"`: 인증되지 않은 상태일 때만 렌더링합니다.

---

## 4. Django와 비교

- Spring Security의 **`UserDetailsService`**는 Django의 **`AUTHENTICATION_BACKENDS`** 설정과 유사한 역할을 합니다. 사용자를 어떻게 가져오고 인증할지에 대한 로직을 정의합니다.
- Spring Security의 **`.formLogin()`**, **`.logout()`** 설정은 Django의 `django.contrib.auth.urls`에 미리 정의된 **`LoginView`**, **`LogoutView`**를 사용하는 것과 같습니다. 두 프레임워크 모두 인증/인가의 많은 부분을 자동화해줍니다.
- Thymeleaf의 **`sec:authorize`** 속성은 Django 템플릿의 **`{% if user.is_authenticated %}`** 와 정확히 동일한 기능입니다.
