# 3.1. User 엔티티와 Spring Security

지금까지는 누구나 게시물을 작성하고 수정/삭제할 수 있었습니다. 이제부터는 Spring Security를 도입하여 사용자 인증(Authentication) 기능을 구현합니다. 먼저 사용자 정보를 저장할 `User` 엔티티를 만들고, Spring Security의 기본 설정을 구성하여 웹사이트의 보안을 강화하는 방법을 알아봅니다.

---

## 1. User 엔티티 및 리포지토리 생성

게시물(Post)과 마찬가지로, 사용자 정보를 데이터베이스에 저장하기 위한 `User` 엔티티와 `UserRepository`를 생성합니다.

#### 1) `User.java` 엔티티 생성

`com.example.instaclone.domain` 패키지에 `User.java` 클래스를 생성합니다.

```java
package com.example.instaclone.domain;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Entity
@Getter
@NoArgsConstructor
@Table(name = "users") // DB에 user라는 키워드가 예약어인 경우가 있어 users로 지정
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String username;

    @Column(nullable = false)
    private String password;

    private String email;

    //== 생성자 ==//
    public User(String username, String password, String email) {
        this.username = username;
        this.password = password;
        this.email = email;
    }
}
```

- **`@Table(name = "users")`**: 데이터베이스에 생성될 테이블 이름을 `users`로 명시적으로 지정합니다. `user`는 많은 DB에서 예약어(reserved word)로 사용되기 때문에 충돌을 피하기 위함입니다.
- **`unique = true`**: `username`은 고유해야 하므로 유니크 제약조건을 추가합니다.

#### 2) `UserRepository.java` 인터페이스 생성

`com.example.instaclone.repository` 패키지에 `UserRepository.java`를 생성합니다.

```java
package com.example.instaclone.repository;

import com.example.instaclone.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
}
```

- **`Optional<User> findByUsername(String username)`**: Spring Data JPA의 **쿼리 메서드** 기능입니다. 메서드 이름을 규칙에 맞게 작성하면 Spring Data JPA가 자동으로 해당 JPQL 쿼리를 생성해줍니다. `findByUsername`은 `username` 필드로 `User`를 조회하는 기능을 수행하며, 나중에 Spring Security가 사용자를 인증할 때 사용됩니다.

---

## 2. Spring Security 기본 설정

Spring Security는 의존성을 추가하는 것만으로도 모든 요청에 인증을 요구하는 등 기본적인 보안 기능이 활성화됩니다. 우리는 이 기본 설정을 우리 프로젝트에 맞게 커스터마이징해야 합니다.

#### 1) `SecurityConfig.java` 생성

`com.example.instaclone.config` 패키지에 `SecurityConfig.java` 클래스를 생성합니다.

```java
package com.example.instaclone.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable()) // CSRF 보호 비활성화 (개발 중 편의를 위해)
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/", "/posts/**", "/images/**", "/css/**", "/js/**").permitAll() // 특정 경로 허용
                .requestMatchers("/signup", "/login").permitAll() // 회원가입, 로그인 경로 허용
                .anyRequest().authenticated() // 나머지 모든 요청은 인증 필요
            );

        return http.build();
    }
}
```

- **`@Configuration`, `@EnableWebSecurity`**: 이 클래스가 Spring Security의 설정 파일임을 나타냅니다.
- **`passwordEncoder()` Bean**: 비밀번호를 안전하게 암호화하기 위한 `PasswordEncoder`를 Bean으로 등록합니다. `BCryptPasswordEncoder`는 현재 가장 널리 사용되는 안전한 해시 알고리즘 중 하나입니다.
- **`securityFilterChain()` Bean**: HTTP 요청에 대한 보안 설정을 구성합니다.
  - `csrf.disable()`: 개발 초기 단계에서는 CSRF(Cross-Site Request Forgery) 보호 기능을 비활성화하는 것이 편리합니다.
  - `authorizeHttpRequests()`: URL별로 접근 권한을 설정합니다.
    - `requestMatchers(...).permitAll()`: `/`, `/posts/**` 등 지정된 경로는 인증 없이 누구나 접근할 수 있도록 허용합니다.
    - `anyRequest().authenticated()`: 위에서 지정한 경로 외의 모든 요청은 반드시 인증(로그인)을 거쳐야만 접근할 수 있습니다.

이제 애플리케이션을 재시작하면, 우리가 허용한 경로 외의 다른 경로로 접근 시 Spring Security가 기본으로 제공하는 로그인 페이지로 리다이렉트됩니다.

---

## 3. Django와 비교

- **`User` 엔티티**는 Django의 `auth` 앱에 있는 **`User` 모델** (또는 `AbstractUser`를 상속받은 커스텀 유저 모델)과 같습니다.
- **`SecurityConfig.java`**는 Django의 `settings.py`에서 `AUTHENTICATION_BACKENDS`, `LOGIN_URL`, `LOGIN_REDIRECT_URL` 등을 설정하고, 프로젝트의 `urls.py`에서 URL별 접근을 제어하는 것과 유사한 역할을 한 곳에서 처리합니다.
- **`PasswordEncoder`**는 Django가 `User` 모델의 비밀번호를 저장할 때 자동으로 사용하는 **비밀번호 해싱 메커니즘**과 동일한 개념입니다. Django는 `PBKDF2`를 기본값으로 사용합니다.
