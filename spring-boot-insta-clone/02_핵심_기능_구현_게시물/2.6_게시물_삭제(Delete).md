# 2.6. 게시물 삭제(Delete)

게시물 관리의 마지막 기능인 삭제를 구현합니다. 게시물을 삭제할 때는 데이터베이스의 레코드만 지우는 것이 아니라, 서버의 파일 시스템에 저장된 이미지 파일도 함께 삭제해야 용량 낭비를 막을 수 있습니다. 안전을 위해 삭제 기능은 보통 GET이 아닌 POST 방식으로 구현합니다.

---

## 1. 삭제 버튼 수정 (`home.html`)

GET 요청으로 중요 데이터를 삭제하는 것은 웹 크롤러 등에 의해 의도치 않게 데이터가 삭제될 위험이 있습니다. 따라서, 간단한 링크(`<a>`) 대신 `<form>`을 사용하여 POST 방식으로 삭제를 요청하도록 `home.html`을 수정합니다.

```html
<!-- home.html의 수정/삭제 버튼 부분 -->
<div>
    <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-sm btn-outline-primary">수정</a>
    <!-- 삭제 form 추가 -->
    <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display: inline;" onsubmit="return confirm('정말로 삭제하시겠습니까?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
    </form>
</div>
```

- **`<form>`**: 삭제 요청을 POST 방식으로 보내기 위해 form으로 버튼을 감쌉니다.
- **`method="post"`**: 요청 방식을 POST로 지정합니다.
- **`onsubmit="return confirm(...)"`**: 삭제 버튼 클릭 시, 사용자에게 정말 삭제할 것인지 확인하는 JavaScript 확인창을 띄웁니다.

---

## 2. 삭제 처리 로직 (Controller, Service)

#### 1) `PostService`에 `delete` 메서드 추가

게시물 ID를 받아 데이터베이스와 파일 시스템에서 모두 삭제하는 로직을 서비스 계층에 구현합니다.

```java
// PostService.java

// ... imports ...
import java.nio.file.Files;
import java.nio.file.Paths;

@Service
@RequiredArgsConstructor
public class PostService {
    // ...

    @Transactional
    public void delete(Long postId) {
        // 1. 게시물 조회
        Post post = postRepository.findById(postId)
                .orElseThrow(() -> new IllegalArgumentException("해당 게시물을 찾을 수 없습니다."));

        // 2. 파일 시스템에서 이미지 파일 삭제
        try {
            // uploadDir: C:/dev/uploads/
            // post.getImageUrl(): /images/uuid_filename.jpg
            String filePath = uploadDir + post.getImageUrl().replace("/images/", "");
            Files.deleteIfExists(Paths.get(filePath));
        } catch (IOException e) {
            // 파일 삭제 실패 시 로그 처리 등을 할 수 있음
            throw new RuntimeException("이미지 파일 삭제에 실패했습니다.", e);
        }

        // 3. 데이터베이스에서 게시물 삭제
        postRepository.delete(post);
    }
}
```

- **파일 삭제 로직**: `post.getImageUrl()`은 `/images/filename.jpg` 형태의 URL이므로, 실제 파일 시스템 경로와 맞추기 위해 앞부분(`/images/`)을 제거하고 `uploadDir`와 조합합니다.
- `Files.deleteIfExists()`: 해당 경로에 파일이 존재하면 삭제합니다. 파일이 없어도 예외가 발생하지 않아 안전합니다.
- `postRepository.delete(post)`: JPA 리포지토리가 제공하는 삭제 메서드입니다. `deleteById(postId)`를 사용해도 동일합니다.

#### 2) `PostController`에 삭제 처리 메서드 추가

```java
// PostController.java

// ... imports ...

@PostMapping("/posts/{postId}/delete")
public String deletePost(@PathVariable Long postId) {
    postService.delete(postId);
    return "redirect:/";
}
```

- `@PostMapping("/posts/{postId}/delete")`: POST 방식으로 들어오는 삭제 요청을 처리합니다.
- `postService.delete(postId)`를 호출하여 실제 삭제 로직을 위임합니다.
- 처리가 완료되면 메인 페이지로 리다이렉트합니다.

---

## 3. Django와 비교

- Spring Data JPA의 **`postRepository.delete(post)`** 또는 **`deleteById(postId)`**는 Django ORM의 **`post.delete()`**와 정확히 같은 역할을 합니다.

  ```python
  # Django views.py
  def post_delete(request, post_id):
      post = Post.objects.get(id=post_id)
      
      # 파일 시스템에서 이미지 삭제
      import os
      if post.image:
          os.remove(post.image.path)

      # DB에서 레코드 삭제
      post.delete()
      return redirect('/')
  ```

- 두 프레임워크 모두 데이터베이스 레코드를 삭제하는 것은 매우 간단하지만, **연관된 파일을 파일 시스템에서 직접 삭제하는 로직은 개발자가 신경 써서 구현해야 한다는 공통점**이 있습니다. (물론, 파일 처리만 전문으로 하는 라이브러리를 사용하면 이 과정이 자동화되기도 합니다.)

이것으로 게시물(Post)에 대한 기본적인 CRUD 기능 구현이 모두 완료되었습니다.
